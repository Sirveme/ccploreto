<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caja - CCPL</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/pages/caja.css">

</head>
<body>


<!-- ‚ïê‚ïê‚ïê APERTURA ‚ïê‚ïê‚ïê -->
<div class="geo-block active" id="geoBlock">
    <div class="geo-icon">üìç</div>
    <div class="geo-title" id="geoTitle">Verificando ubicaci√≥n...</div>
    <div class="geo-desc" id="geoDesc">El sistema de caja solo funciona desde las instalaciones del CCPL.</div>
    <div class="geo-coords" id="geoCoords" style="display:none;"></div>
    <button class="geo-retry" id="geoRetry" style="display:none;" onclick="verificarGeo()">üîÑ Reintentar</button>
</div>

<div class="apertura-bg" id="aperturaOverlay">
    <div class="apertura-box">
        <div class="ap-icon">üè¶</div>
        <h2 class="ap-title">Abrir Caja</h2>
        <p class="ap-desc">Ingresa el monto del fondo inicial</p>
        <div class="ap-field"><label>Centro de costo</label><select id="aperturaCentro" class="ap-select"></select></div>
        <div class="ap-field"><label>Monto de apertura (S/)</label><input type="number" id="aperturaMontoInput" class="m-input" value="0" min="0" step="0.01"></div>
        <button class="btn-abrir" onclick="ejecutarApertura()">Abrir Caja</button>
    </div>
</div>

<div class="caja-layout">
    <!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
    <header class="caja-header">
        <div class="header-left">
            <span class="header-logo">CCPL</span>
            <span class="header-title" id="headerTitle">Caja</span>
        </div>
        <div class="header-right">
            <div class="header-pill sesion-indicator" id="sesionIndicator" style="display:none;">
                <span class="sesion-dot"></span>
                <span class="lbl">Caja:</span>
                <span class="val" id="sesionInfo">--</span>
            </div>
            <div class="header-pill"><span class="lbl">Hoy:</span><span class="val" id="totalDia">S/ 0</span></div>
            <div class="header-pill"><span class="lbl">Ops:</span><span class="val" id="opsDia">0</span></div>
            <button class="hdr-btn" id="btnEgreso" onclick="cambiarTab('egresos')" style="display:none;" title="Egresos">üí∏</button>
            <button class="hdr-btn danger" id="btnCerrar" onclick="mostrarCierreCaja()" style="display:none;" title="Cerrar caja">üîí</button>
            <span class="header-time" id="horaActual">--:--</span>
            <div class="hdr-menu">
                <button class="hdr-btn" onclick="toggleMenu()" title="Opciones">‚ò∞</button>
                <div class="hdr-menu-drop" id="headerMenu">
                    <button class="hdr-menu-item" onclick="notificarDesdeCaja()">üîî Notificar</button>
                    <div class="hdr-menu-sep"></div>
                    <button class="hdr-menu-item danger" onclick="cerrarSesionUsuario()">üö™ Cerrar sesi√≥n</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê PANEL IZQUIERDO ‚ïê‚ïê‚ïê -->
    <div class="panel-left">
        <div class="search-card">
            <div class="search-box">
                <span class="search-icon">‚åï</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar por DNI, matr√≠cula o nombre..." autocomplete="off">
                <span class="search-shortcut">F2</span>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="col-card" id="colCard">
                <div class="col-avatar" id="colAvatar">--</div>
                <div class="col-info">
                    <div class="col-name" id="colName">--</div>
                    <div class="col-detail" id="colDetail">--</div>
                </div>
                <span class="badge" id="colBadge"></span>
                <button class="col-clear" onclick="limpiarCol()">‚úï</button>
            </div>
        </div>

        <div class="tabs-bar">
            <button class="tab active" data-t="deudas" onclick="cambiarTab('deudas')" id="tabDeudas">Deudas <span class="tab-count" id="cntDeudas">0</span></button>
            <button class="tab" data-t="catalogo" onclick="cambiarTab('catalogo')" id="tabCatalogo">Cat√°logo <span class="tab-count" id="cntConceptos">0</span></button>
            <button class="tab" data-t="egresos" onclick="cambiarTab('egresos')" id="tabEgresos">Egresos <span class="tab-count" id="cntEgresos">0</span></button>
            <button class="tab" data-t="historial" onclick="cambiarTab('historial')" id="tabHistorial">Historial</button>
            <button class="tab" data-t="comprobantes" onclick="cambiarTab('comprobantes')" id="tabComprobantes">Comprobantes</button>
        </div>

        <div class="content-scroll">
            <div id="panelDeudas"><div class="empty"><div class="empty-icon">üìã</div><div class="empty-title">Busca un colegiado</div><div class="empty-desc">DNI, matr√≠cula o nombre</div></div></div>
            <div id="panelCatalogo" style="display:none;"><div class="section-box blue"><div class="sec-title blue">üì¶ Conceptos de cobro</div><div class="cats-row" id="catsGrid"></div><div id="concLista"></div></div></div>
            <div id="panelEgresos" style="display:none;">
                <div class="section-box amber">
                    <div class="sec-title amber">üí∏ Registrar salida de dinero</div>
                    <div class="egr-form-row">
                        <div class="egr-field" style="flex:1;"><label>Monto (S/)</label><input type="number" id="eMonto" class="egr-input mono" min="0.01" step="0.01" placeholder="0.00"></div>
                        <div class="egr-field" style="flex:1.2;"><label>Tipo</label><select id="eTipo" class="egr-input"><option value="gasto">Gasto / Compra</option><option value="devolucion">Devoluci√≥n a cliente</option><option value="retiro_fondo">Retiro de fondo</option></select></div>
                    </div>
                    <div class="egr-field"><label>Responsable</label><input type="text" id="eResp" class="egr-input" placeholder="Qui√©n recibe el dinero..."></div>
                    <div class="egr-field"><label>Concepto / Motivo</label><input type="text" id="eConc" class="egr-input" placeholder="Compra de papel, movilidad, refrigerios..."></div>
                    <div class="egr-field"><label>Detalle (opcional)</label><input type="text" id="eDet" class="egr-input" placeholder="Notas adicionales..."></div>
                    <button class="btn-reg-egr" onclick="registrarEgreso()">üí∏ Registrar Egreso</button>
                </div>
                <div class="egr-summary" id="egrSummary" style="display:none;">
                    <div class="egr-summary-row"><span>Entregado:</span><span class="mono" id="egrTotEnt">S/ 0</span></div>
                    <div class="egr-summary-row"><span>Facturado:</span><span class="mono" style="color:var(--green)" id="egrTotFact">S/ 0</span></div>
                    <div class="egr-summary-row"><span>Devuelto a caja:</span><span class="mono" style="color:var(--accent)" id="egrTotDev">S/ 0</span></div>
                    <div class="egr-summary-row" id="egrPendRow" style="display:none;"><span>‚ö† Pendientes:</span><span class="mono" style="color:var(--amber)" id="egrPend">0</span></div>
                </div>
                <div id="egrLista"></div>
            </div>
            <div id="panelHistorial" style="display:none;">
                <div class="section-box green">
                    <div class="sec-title green">üìä Historial de operaciones</div>
                    <div class="hist-filters">
                        <input type="date" id="histFecha" style="flex:1;">
                        <select id="histTipo" style="width:100px;">
                            <option value="">Todos</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="yape">Yape</option>
                            <option value="plin">Plin</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transfer.</option>
                            <option value="deposito">Dep√≥sito</option>
                        </select>
                        <button class="hist-btn" onclick="cargarHistorial()">Buscar</button>
                        <button class="hist-btn" style="background:var(--green);" onclick="exportarDia()">üì• Excel</button>
                    </div>
                    <div class="hist-summary" id="histSummary"></div>
                    <div id="histLista"><div class="hist-empty">Selecciona una fecha y presiona Buscar</div></div>
                </div>

                <!-- Agregar un enlace discreto en alg√∫n lugar visible de caja: -->
                <a href="#" onclick="verSesionesAnteriores();return false;" 
                style="font-size:11px;color:var(--text-sec);text-decoration:none;opacity:0.7;">
                üìã Ver cierres anteriores
                </a>

            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                PASO 2: Panel completo (agregar despu√©s del panel de historial)
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

            <div class="tab-content" id="panelComprobantes" style="display:none;">
                <div class="panel-box">
                    <div class="panel-title">üìÑ COMPROBANTES EMITIDOS</div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
                        <input type="text" id="compBuscar" class="m-input" placeholder="DNI, RUC, nombre, serie..." style="flex:1;min-width:180px;" onkeydown="if(event.key==='Enter')buscarComprobantes()">
                        <select id="compTipo" class="ap-select" style="width:110px;">
                            <option value="">Todos</option>
                            <option value="03">Boletas</option>
                            <option value="01">Facturas</option>
                            <option value="07">NC</option>
                        </select>
                        <select id="compEstado" class="ap-select" style="width:110px;">
                            <option value="">Todo estado</option>
                            <option value="accepted">Aceptado</option>
                            <option value="pending">Pendiente</option>
                            <option value="rejected">Rechazado</option>
                            <option value="anulado">Anulado</option>
                        </select>
                        <button class="action-btn btn-primary" onclick="buscarComprobantes()">üîç</button>
                    </div>
                    <div id="compSummary" style="font-size:12px;color:var(--text-sec);margin-bottom:8px;"></div>
                    <div id="compLista" style="max-height:500px;overflow-y:auto;">
                        <div class="hist-empty">Busca comprobantes por DNI, nombre o n√∫mero</div>
                    </div>
                    <div id="compPaginacion" style="display:flex;justify-content:center;gap:6px;margin-top:10px;"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CARRITO ‚ïê‚ïê‚ïê -->
    <div class="panel-right" id="panelRight">
        <button class="cart-close-btn" id="cartCloseBtn" onclick="toggleCart()">‚úï</button>
        <div class="cart-head"><div class="cart-head-title">üßæ Cobro actual <span class="cart-head-badge" id="cartCnt">0</span></div></div>
        <div class="cart-body" id="cartBody"><div class="cart-empty"><div class="cart-empty-icon">üõí</div>Selecciona deudas o conceptos<br>para agregar al cobro</div></div>
        <div class="cart-foot">
            <div class="cart-total-row"><span class="cart-total-lbl">TOTAL</span><span class="cart-total-val"><span class="cart-total-cur">S/</span><span id="cartTot">0.00</span></span></div>
            <div class="metodos-grid">
                <button class="m-btn active" onclick="setMetodo('efectivo')" data-m="efectivo"><span class="m-icon">üíµ</span>Efectivo</button>
                <button class="m-btn" onclick="setMetodo('yape')" data-m="yape"><span class="m-icon">üì±</span>Yape</button>
                <button class="m-btn" onclick="setMetodo('plin')" data-m="plin"><span class="m-icon">üì±</span>Plin</button>
                <button class="m-btn" onclick="setMetodo('tarjeta')" data-m="tarjeta"><span class="m-icon">üí≥</span>Tarjeta</button>
                <button class="m-btn" onclick="setMetodo('transferencia')" data-m="transferencia"><span class="m-icon">üè¶</span>Transfer.</button>
                <button class="m-btn" onclick="setMetodo('deposito')" data-m="deposito"><span class="m-icon">üßæ</span>Dep√≥sito</button>
            </div>
            <input type="text" class="ref-input" id="refInput" placeholder="Nro. de operaci√≥n / voucher">
            <div class="ref-required-hint" id="refHint">‚ö† N¬∞ de operaci√≥n obligatorio</div>
            <div class="comp-row">
                <button class="comp-btn active" onclick="setComp('03')" data-c="03">Boleta</button>
                <button class="comp-btn" onclick="setComp('01')" data-c="01">Factura</button>
            </div>
            <div class="factura-fields" id="facturaFields">
                <div class="ff-row">
                    <div class="ff-label">RUC</div>
                    <div class="ff-ruc-row">
                        <input type="text" class="ff-input" id="ffRuc" maxlength="11" placeholder="20XXXXXXXXX" oninput="this.value=this.value.replace(/\D/g,'')">
                        <button class="ff-ruc-btn" id="ffBuscarRuc" onclick="buscarRuc()">üîç Buscar</button>
                    </div>
                </div>
                <div class="ff-row"><div class="ff-label">Raz√≥n Social</div><input type="text" class="ff-input" id="ffRazonSocial" placeholder="Nombre o Raz√≥n Social"></div>
                <div class="ff-row"><div class="ff-label">Direcci√≥n Fiscal</div><input type="text" class="ff-input" id="ffDireccion" placeholder="Direcci√≥n (opcional)"></div>
            </div>
            <div class="pago-row">
                <button class="pago-btn active" onclick="setFormaPago('contado')" data-fp="contado">üíµ Contado</button>
                <button class="pago-btn" onclick="setFormaPago('credito')" data-fp="credito">üìÖ Cr√©dito</button>
            </div>
            <button class="btn-cobrar" id="btnCobrar" disabled onclick="confirmarCobro()">COBRAR <span class="cobrar-monto" id="btnMonto">S/ 0.00</span></button>
        </div>
    </div>
</div>

<!-- MOBILE FAB -->
<button class="cart-fab" id="cartFab" onclick="toggleCart()">üõí <span class="fab-badge" id="fabBadge" style="display:none;">0</span></button>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="modalConfirm">
    <div class="modal-box">
        <div class="modal-title">Confirmar cobro</div>
        <div class="modal-sub">¬øConfirmar el siguiente cobro?</div>
        <div class="modal-total" id="mTotal">S/ 0.00</div>
        <div class="modal-detail" id="mDetail"></div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModal()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarCobro()">‚úì Confirmar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalCierre">
    <div class="modal-box" style="width:440px;">
        <div class="modal-title">üîí Cierre de Caja</div>
        <div class="cierre-box" id="cierreResumen"></div>
        <div class="c-field"><label>¬øCu√°nto dinero hay en caja? (S/)</label><input type="number" id="cierreMontoInput" class="m-input" min="0" step="0.01" placeholder="0.00" oninput="calcDiff()"></div>
        <div class="c-diff" id="cierreDiff" style="display:none;"></div>
        <div class="c-field" id="cierreObsCont" style="display:none;"><label>Observaciones (obligatorio si dif. > S/ 50)</label><textarea id="cierreObsInput" class="m-textarea" rows="2" placeholder="Explicar..."></textarea></div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalCierre()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarCierre()">üîí Cerrar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalLiquidar">
    <div class="modal-box" style="width:400px;">
        <div class="modal-title">üìÑ Liquidar Egreso</div>
        <div class="modal-sub" id="liqInfo">--</div>
        <div class="c-field"><label>Monto de la factura/boleta (S/)</label><input type="number" id="liqFactura" class="m-input" min="0" step="0.01" placeholder="0.00" oninput="calcVuelto()"></div>
        <div class="c-diff" id="liqVuelto" style="display:none;"></div>
        <div class="c-field"><label>Nro. factura/boleta (opcional)</label><input type="text" id="liqNroDoc" class="egr-input" placeholder="B001-00001234"></div>
        <input type="hidden" id="liqId"><input type="hidden" id="liqOriginal">
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalLiq()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarLiq()">‚úì Liquidar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalAnular">
    <div class="modal-box" style="width:420px;">
        <div class="modal-title" style="color:var(--red);">‚ö†Ô∏è Anular cobro</div>
        <div class="modal-sub" id="anularInfo">--</div>
        <div class="c-field"><label>Motivo de anulaci√≥n</label>
            <select id="anularMotivo" class="ap-select" onchange="toggleMontoParcial()">
                <option value="01">Anulaci√≥n de la operaci√≥n</option>
                <option value="02">Anulaci√≥n por error en RUC</option>
                <option value="03">Correcci√≥n por error en descripci√≥n</option>
                <option value="04">Descuento global</option>
                <option value="05">Descuento por √≠tem</option>
                <option value="06">Devoluci√≥n total</option>
                <option value="07">Devoluci√≥n parcial</option>
            </select>
        </div>
        <div class="c-field" id="anularMontoCont" style="display:none;"><label>Monto a devolver (S/)</label><input type="number" id="anularMonto" class="m-input" min="0.01" step="0.01" placeholder="0.00"></div>
        <div class="c-field"><label>Observaciones (opcional)</label><input type="text" id="anularObs" class="egr-input" placeholder="Detalle adicional..."></div>
        <input type="hidden" id="anularPayId"><input type="hidden" id="anularTotal">
        <div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);border-radius:6px;padding:10px;margin:10px 0;font-size:12px;color:var(--red);">
            ‚ö† Esta acci√≥n emitir√° una Nota de Cr√©dito ante SUNAT y revertir√° las deudas del colegiado. No se puede deshacer.
        </div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalAnular()">Cancelar</button><button class="mbtn mbtn-ok" style="background:var(--red);" onclick="ejecutarAnulacion()">üóë Anular</button></div>
    </div>
</div>

<div class="success-bg" id="successBg">
    <div class="success-box">
        <div class="success-check">‚úì</div>
        <div class="success-title">¬°Cobro registrado!</div>
        <div class="success-amt" id="successAmt">S/ 0</div>
        <div class="success-ref" id="successRef"></div>
        <div class="success-comprobante" id="successComp">
            <div class="success-comp-numero" id="successCompNum"></div>
            <div class="success-comp-loading" id="successCompLoading"><span class="spin"></span> Generando comprobante...</div>
            <div class="success-actions" id="successActions" style="display:none;">
                <a class="success-action-btn primary" id="successCompPdf" href="#" target="_blank">üìÑ Ver PDF</a>
                <button class="success-action-btn secondary" id="successShareBtn" onclick="compartirComprobante()">üì§ Compartir</button>
            </div>
            <div class="success-comp-error" id="successCompErr"></div>
        </div>
        <div class="success-close-hint" id="successCloseHint">Toca en cualquier lugar para cerrar</div>
    </div>
</div>

<div class="toast-box" id="toastBox"></div>

<div id="verifBadge" style="
    display:none;
    align-items:center;
    gap:8px;
    padding:10px 14px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:8px;
    margin:8px 12px;
    font-size:13px;
    transition:all 0.3s ease;
">
    <span id="verifIcon" style="font-size:18px;">üîç</span>
    <span id="verifText" style="flex:1;">Verificando...</span>
    <span id="verifTimer" style="font-size:11px;color:var(--text-sec);"></span>
</div>


!-- Modal de Cierre Exitoso (agregar al final del body) -->
<div id="modalCierreExitoso" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;display:none;align-items:center;justify-content:center;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px 28px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <div style="text-align:center;margin-bottom:16px;">
            <div style="font-size:40px;margin-bottom:8px;">‚úÖ</div>
            <div style="font-size:18px;font-weight:700;color:var(--text);">Caja Cerrada</div>
        </div>

        <div id="cierreResumenBox" style="background:var(--bg);border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.8;">
            <!-- Se llena din√°micamente -->
        </div>

        <div style="display:flex;gap:10px;">
            <button onclick="descargarPDFCierre()" style="flex:1;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:filter 0.15s;" onmouseenter="this.style.filter='brightness(1.15)'" onmouseleave="this.style.filter=''">
                üìÑ Descargar PDF
            </button>
            <button onclick="cerrarModalCierre()" style="padding:12px 20px;background:transparent;color:var(--text-sec);border:1px solid var(--border);border-radius:8px;font-size:14px;cursor:pointer;">
                Cerrar
            </button>
        </div>
    </div>
</div>

    <!-- VERIFICACION DE NOTIFICACIONES BANCARIAS 
    <script src="{{ url_for('static', path='/js/pages/caja.js') }}?v=6"></script>
    -->

    <script>

        // ‚îÄ‚îÄ Variable para guardar el ID de la sesi√≥n cerrada ‚îÄ‚îÄ
let ultimaSesionCerrada = null;

// ‚îÄ‚îÄ Mostrar modal con resumen despu√©s de cerrar ‚îÄ‚îÄ
function mostrarCierreExitoso(sesionId, resumen, mensaje) {
    ultimaSesionCerrada = sesionId;

    const dif = resumen.diferencia || 0;
    const difColor = Math.abs(dif) < 0.01 ? 'var(--green)' : (dif < 0 ? 'var(--red)' : 'var(--yellow)');
    const difIcon = Math.abs(dif) < 0.01 ? '‚úì Cuadra' : (dif < 0 ? '‚ö† Faltante' : '‚ö† Sobrante');

    document.getElementById('cierreResumenBox').innerHTML = `
        <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-sec);">Apertura</span><span>S/ ${(resumen.monto_apertura||0).toFixed(2)}</span></div>
        <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-sec);">(+) Efectivo</span><span>S/ ${(resumen.total_cobros_efectivo||0).toFixed(2)}</span></div>
        <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-sec);">(+) Digital</span><span>S/ ${(resumen.total_cobros_digital||0).toFixed(2)}</span></div>
        <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-sec);">(-) Egresos</span><span>S/ ${(resumen.total_egresos||0).toFixed(2)}</span></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">
        <div style="display:flex;justify-content:space-between;"><span style="font-weight:600;">Esperado</span><span style="font-weight:600;">S/ ${(resumen.total_esperado||0).toFixed(2)}</span></div>
        <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-sec);">Declarado</span><span>S/ ${(resumen.monto_cierre||0).toFixed(2)}</span></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">
        <div style="display:flex;justify-content:space-between;font-size:15px;font-weight:700;">
            <span>Diferencia</span>
            <span style="color:${difColor};">${dif >= 0 ? '+' : ''}${dif.toFixed(2)} ${difIcon}</span>
        </div>
        <div style="text-align:center;margin-top:8px;font-size:11px;color:var(--text-sec);">${resumen.cantidad_operaciones||0} operaciones</div>
    `;

    const modal = document.getElementById('modalCierreExitoso');
    modal.style.display = 'flex';
}

function descargarPDFCierre() {
    if (ultimaSesionCerrada) {
        const url = `/api/caja/cierre-caja/${ultimaSesionCerrada}/pdf`;
        const win = window.open(url, '_blank');
        if (!win || win.closed) {
            // Popup bloqueado ‚Äî usar descarga directa
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.click();
        }
    }
}

function cerrarModalCierre() {
    document.getElementById('modalCierreExitoso').style.display = 'none';
    // Recargar estado de caja
    location.reload();
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODIFICAR la funci√≥n existente de cerrar caja.
   
   Buscar donde hace el POST a /api/caja/cerrar-caja/{id}
   y en el callback de √©xito, REEMPLAZAR el toast por:
   
   if (d.success) {
       mostrarCierreExitoso(sesionId, d.resumen, d.mensaje);
   }
   
   En vez de solo:
   toast(d.mensaje, 'ok');
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* SEGUNDO BLOQUE */

const API = '/api/caja';
let colActual = null, deudasDisp = [], conceptosDisp = [];
let catActiva = null, carrito = [], metodo = 'efectivo', tipoComp = '03', formaPago = 'contado';
let tabAct = 'deudas', sesion = null, totalEsperado = 0;
let pdfPollTimer = null, lastPaymentId = null, lastCompNumero = null, lastCompPdfUrl = null;

// M√©todos que requieren N¬∞ de operaci√≥n obligatorio
const METODOS_REQ_REF = ['yape', 'plin', 'transferencia', 'tarjeta'];

// Placeholders por m√©todo de pago
const REF_PLACEHOLDERS = {
    yape: 'Nro. operaci√≥n Yape (obligatorio)',
    plin: 'Nro. operaci√≥n Plin (obligatorio)',
    transferencia: 'Nro. operaci√≥n / CCI (obligatorio)',
    tarjeta: 'Nro. voucher / √∫ltimos 4 d√≠gitos (obligatorio)',
    deposito: 'Nro. de operaci√≥n / voucher'
};

// ‚îÄ‚îÄ GEOLOCALIZACI√ìN ‚îÄ‚îÄ
const SEDES_CCPL = [
    { nombre: 'Oficina Principal', lat: -3.7486127, lng: -73.2529467, radio: 100 },
    { nombre: 'Centro Recreacional', lat: -3.793031, lng: -73.299236, radio: 100 },
];

function distanciaMetros(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/*
function verificarGeo() {
    const el = document.getElementById('geoBlock');
    const titulo = document.getElementById('geoTitle');
    const desc = document.getElementById('geoDesc');
    const coords = document.getElementById('geoCoords');
    const retry = document.getElementById('geoRetry');
    titulo.textContent = 'Verificando ubicaci√≥n...'; desc.textContent = 'Obteniendo tu posici√≥n GPS...';
    retry.style.display = 'none'; coords.style.display = 'none';

    if (!navigator.geolocation) {
        titulo.textContent = 'üö´ GPS no disponible';
        desc.textContent = 'Tu navegador no soporta geolocalizaci√≥n. Usa Chrome o Firefox actualizado.';
        retry.style.display = 'inline-block'; return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude;
            let sedeOk = null, distMin = Infinity;
            for (const s of SEDES_CCPL) {
                const d = distanciaMetros(lat, lng, s.lat, s.lng);
                if (d < distMin) distMin = d;
                if (d <= s.radio) { sedeOk = s; break; }
            }
            if (sedeOk) {
                el.classList.remove('active');
                iniciarApp();
            } else {
                titulo.textContent = 'üö´ Fuera del √°rea permitida';
                desc.textContent = `Est√°s a ${Math.round(distMin)}m de la sede m√°s cercana. El sistema de caja solo funciona dentro de las instalaciones del CCPL (radio: 100m).`;
                coords.textContent = `Tu posici√≥n: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                coords.style.display = 'block';
                retry.style.display = 'inline-block';
            }
        },
        (err) => {
            if (err.code === 1) {
                titulo.textContent = 'üìç Permiso denegado';
                desc.textContent = 'Debes permitir el acceso a tu ubicaci√≥n para usar la caja. Haz clic en el √≠cono de candado üîí en la barra de direcciones y activa la ubicaci√≥n.';
            } else if (err.code === 2) {
                titulo.textContent = 'üìç Ubicaci√≥n no disponible';
                desc.textContent = 'No se pudo obtener tu ubicaci√≥n. Verifica que el GPS est√© activado.';
            } else {
                titulo.textContent = 'üìç Tiempo de espera agotado';
                desc.textContent = 'La obtenci√≥n de ubicaci√≥n tard√≥ demasiado. Intenta de nuevo.';
            }
            retry.style.display = 'inline-block';
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
}
*/

function iniciarApp() {
    actualizarReloj(); setInterval(actualizarReloj, 30000);
    verificarSesion(); cargarCats(); cargarConceptos();
    document.getElementById('searchInput').focus();
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('geoBlock').classList.remove('active'); iniciarApp(); // verificarGeo(); üëàüëÄüëÅ‚Äçüó®
    document.addEventListener('keydown', e => {
        if (e.key === 'F2') { e.preventDefault(); const s = document.getElementById('searchInput'); s.focus(); s.select(); }
        if (e.key === 'Escape') { cerrarModal(); cerrarModalCierre(); cerrarModalLiq(); cerrarModalAnular(); cerrarSuccess(); document.getElementById('searchResults').classList.remove('active'); }
        if (e.key === 'F9' && carrito.length) { e.preventDefault(); confirmarCobro(); }
    });
    // Limpiar error del ref input al escribir
    document.getElementById('refInput').addEventListener('input', () => {
        document.getElementById('refInput').classList.remove('error');
        document.getElementById('refHint').classList.remove('visible');
    });
});

function actualizarReloj() { document.getElementById('horaActual').textContent = new Date().toLocaleTimeString('es-PE', { hour:'2-digit', minute:'2-digit' }); }
async function cargarResumen() { try { const r = await fetch(`${API}/resumen-dia`); const d = await r.json(); document.getElementById('totalDia').textContent = `S/ ${d.total_cobrado.toFixed(2)}`; document.getElementById('opsDia').textContent = d.cantidad_operaciones; } catch(e) {} }

// ‚îÄ‚îÄ SESI√ìN ‚îÄ‚îÄ
async function verificarSesion() {
    try { const r = await fetch(`${API}/sesion-actual?centro_costo_id=1`); const d = await r.json();
        if (d.caja_abierta && d.sesion) { sesion = d.sesion; abrirCajaUI(); } else { mostrarApertura(); }
    } catch(e) {} cargarResumen();
}
function mostrarApertura() {
    document.getElementById('aperturaOverlay').classList.add('active');
    document.getElementById('aperturaCentro').innerHTML = '<option value="1">Oficina Principal</option><option value="2">Restaurante</option><option value="3">Cafet√≠n</option><option value="4">Hotel</option><option value="5">Bazar / Merchandising</option><option value="6">Centro Recreacional</option>';
    setTimeout(() => { document.getElementById('aperturaMontoInput').focus(); document.getElementById('aperturaMontoInput').select(); }, 300);
}
async function ejecutarApertura() {
    const m = parseFloat(document.getElementById('aperturaMontoInput').value) || 0;
    const c = parseInt(document.getElementById('aperturaCentro').value) || 1;
    try { const r = await fetch(`${API}/abrir-caja`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ monto_apertura:m, centro_costo_id:c }) }); const d = await r.json();
        if (d.success) { document.getElementById('aperturaOverlay').classList.remove('active'); toast(d.mensaje,'ok'); verificarSesion(); } else toast(d.detail?.error||d.detail||'Error','err');
    } catch(e) { toast('Error','err'); }
}
function abrirCajaUI() {
    document.getElementById('aperturaOverlay').classList.remove('active');
    document.getElementById('sesionIndicator').style.display = 'flex';
    document.getElementById('sesionInfo').textContent = `${sesion.centro_costo} ¬∑ ${sesion.hora_apertura}`;
    document.getElementById('headerTitle').textContent = `Caja ‚Äî ${sesion.centro_costo}`;
    document.getElementById('btnCerrar').style.display = 'block';
    document.getElementById('btnEgreso').style.display = 'block';
}

// ‚îÄ‚îÄ CIERRE ‚îÄ‚îÄ
function mostrarCierreCaja() {
    if (!sesion) return;
    fetch(`${API}/sesion-actual?centro_costo_id=${sesion.centro_costo_id||1}`).then(r=>r.json()).then(d => {
        if (!d.sesion) return;
        sesion = d.sesion; totalEsperado = sesion.total_esperado;
        document.getElementById('cierreResumen').innerHTML = `
            <div class="c-row"><span>Apertura</span><span class="cmonto">S/ ${sesion.monto_apertura.toFixed(2)}</span></div>
            <div class="c-row"><span>Cobros efectivo</span><span class="cmonto" style="color:var(--green)">+ S/ ${sesion.total_cobros_efectivo.toFixed(2)}</span></div>
            <div class="c-row"><span>Cobros digitales</span><span class="cmonto" style="color:var(--accent)">S/ ${sesion.total_cobros_digital.toFixed(2)}</span></div>
            <div class="c-row"><span>Egresos (neto)</span><span class="cmonto" style="color:var(--red)">- S/ ${sesion.total_egresos.toFixed(2)}</span></div>
            <div class="c-row"><span>Operaciones</span><span class="cmonto">${sesion.cantidad_operaciones}</span></div>
            <div class="c-row total"><span>Esperado en caja</span><span class="cmonto" style="color:var(--green)">S/ ${sesion.total_esperado.toFixed(2)}</span></div>`;
        document.getElementById('cierreMontoInput').value = '';
        document.getElementById('cierreDiff').style.display = 'none';
        document.getElementById('cierreObsCont').style.display = 'none';
        document.getElementById('modalCierre').classList.add('active');
        document.getElementById('cierreMontoInput').focus();
    });
}
function calcDiff() {
    const v = parseFloat(document.getElementById('cierreMontoInput').value); const el = document.getElementById('cierreDiff');
    if (isNaN(v)) { el.style.display='none'; document.getElementById('cierreObsCont').style.display='none'; return; }
    const d = v - totalEsperado; el.style.display = 'block';
    if (Math.abs(d)<0.01) { el.className='c-diff ok'; el.textContent='‚úì Caja cuadrada'; document.getElementById('cierreObsCont').style.display='none'; }
    else if (d>0) { el.className='c-diff over'; el.textContent=`Sobrante: + S/ ${d.toFixed(2)}`; document.getElementById('cierreObsCont').style.display=Math.abs(d)>50?'block':'none'; }
    else { el.className='c-diff under'; el.textContent=`Faltante: - S/ ${Math.abs(d).toFixed(2)}`; document.getElementById('cierreObsCont').style.display=Math.abs(d)>50?'block':'none'; }
}
function cerrarModalCierre() { document.getElementById('modalCierre').classList.remove('active'); }
async function ejecutarCierre() {
    const m = parseFloat(document.getElementById('cierreMontoInput').value); if (isNaN(m)) { toast('Ingresa monto','err'); return; }
    const obs = document.getElementById('cierreObsInput').value.trim();
    if (Math.abs(m-totalEsperado)>50&&!obs) { toast('Dif >S/50: observaci√≥n obligatoria','err'); return; }
    try { const r = await fetch(`${API}/cerrar-caja/${sesion.id}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ monto_cierre:m, observaciones:obs||null }) }); const d = await r.json();
        if (d.success) { cerrarModalCierre(); toast(d.mensaje,'ok'); sesion=null; document.getElementById('sesionIndicator').style.display='none'; document.getElementById('btnCerrar').style.display='none'; document.getElementById('btnEgreso').style.display='none'; setTimeout(()=>mostrarApertura(),1500); }
        else toast(d.detail||'Error','err');
    } catch(e) { toast('Error','err'); }
}

// ‚îÄ‚îÄ B√öSQUEDA ‚îÄ‚îÄ
let sT;
document.getElementById('searchInput').addEventListener('input', e => { clearTimeout(sT); const q=e.target.value.trim(); if(q.length<2){document.getElementById('searchResults').classList.remove('active');return;} sT=setTimeout(()=>buscar(q),300); });
document.getElementById('searchInput').addEventListener('focus', e => { if(e.target.value.trim().length>=2) document.getElementById('searchResults').classList.add('active'); });
document.addEventListener('click', e => { if(!e.target.closest('.search-card')) document.getElementById('searchResults').classList.remove('active'); });
async function buscar(q) { try { const r=await fetch(`${API}/buscar-colegiado?q=${encodeURIComponent(q)}`); renderRes(await r.json()); } catch(e){toast('Error','err');} }
function renderRes(arr) {
    const c=document.getElementById('searchResults');
    if(!arr.length){c.innerHTML='<div style="padding:12px;color:var(--text-muted);text-align:center;font-size:11px;">Sin resultados</div>';c.classList.add('active');return;}
    c.innerHTML=arr.map(r=>`<div class="search-result-item" onclick='selCol(${JSON.stringify(r)})'><div class="result-info"><div class="result-name">${r.apellidos_nombres}</div><div class="result-meta">DNI ${r.dni} ¬∑ Mat. ${r.codigo_matricula||'-'} <span class="badge badge-${r.habilitado?'ok':'no'}">${r.habilitado?'H√ÅBIL':'INH√ÅBIL'}</span></div></div><div class="result-deuda ${r.total_deuda>0?'tiene':'no-tiene'}">${r.total_deuda>0?`S/ ${r.total_deuda.toFixed(2)}`:'Al d√≠a ‚úì'}</div></div>`).join('');
    c.classList.add('active');
}
function selCol(col) {
    colActual=col; document.getElementById('searchResults').classList.remove('active'); document.getElementById('searchInput').value='';
    document.getElementById('colCard').classList.add('active');
    document.getElementById('colAvatar').textContent=col.apellidos_nombres.split(' ').slice(0,2).map(n=>n[0]).join('');
    document.getElementById('colName').textContent=col.apellidos_nombres;
    document.getElementById('colDetail').textContent=`DNI ${col.dni} ¬∑ Mat. ${col.codigo_matricula||'-'} ¬∑ Deuda: S/ ${col.total_deuda.toFixed(2)}`;
    const b=document.getElementById('colBadge'); b.textContent=col.habilitado?'H√ÅBIL':'INH√ÅBIL'; b.className=`badge badge-${col.habilitado?'ok':'no'}`;
    cargarDeudas(col.id); cambiarTab('deudas');
}
function limpiarCol() {
    colActual=null; deudasDisp=[]; document.getElementById('colCard').classList.remove('active');
    document.getElementById('panelDeudas').innerHTML='<div class="empty"><div class="empty-icon">üìã</div><div class="empty-title">Busca un colegiado</div><div class="empty-desc">DNI, matr√≠cula o nombre</div></div>';
    document.getElementById('cntDeudas').textContent='0'; carrito=carrito.filter(i=>i.tipo!=='deuda'); renderCarrito(); document.getElementById('searchInput').focus();
}

// ‚îÄ‚îÄ DEUDAS ‚îÄ‚îÄ
async function cargarDeudas(id) { try { const r=await fetch(`${API}/deudas/${id}`); const d=await r.json(); deudasDisp=d.deudas||[]; renderDeudas(); } catch(e){toast('Error','err');} }
function renderDeudas() {
    const p=document.getElementById('panelDeudas'); document.getElementById('cntDeudas').textContent=deudasDisp.length;
    if(!deudasDisp.length){p.innerHTML='<div class="empty"><div class="empty-icon">‚úÖ</div><div class="empty-title">Sin deudas pendientes</div></div>';return;}
    const sel=carrito.filter(i=>i.tipo==='deuda').map(i=>i.deuda_id);
    p.innerHTML=`<div class="section-box red"><div class="sec-title red">üìã Deudas pendientes</div><button class="btn-sel-all" onclick="selTodas()">Seleccionar todas (${deudasDisp.length})</button>${deudasDisp.map(d=>`<div class="deuda-row ${sel.includes(d.id)?'selected':''}" onclick="togDeuda(${d.id})"><div class="d-check">${sel.includes(d.id)?'‚úì':''}</div><div class="d-info"><div class="d-concepto">${d.concepto}</div><div class="d-periodo">${d.periodo||''} ${d.fecha_vencimiento?'¬∑ Vence: '+d.fecha_vencimiento:''}</div></div><div class="d-monto">S/ ${d.saldo.toFixed(2)}</div></div>`).join('')}</div>`;
}
function togDeuda(id) { const i=carrito.findIndex(x=>x.tipo==='deuda'&&x.deuda_id===id); if(i>=0) carrito.splice(i,1); else { const d=deudasDisp.find(x=>x.id===id); if(d) carrito.push({tipo:'deuda',deuda_id:d.id,descripcion:`${d.concepto} ${d.periodo||''}`.trim(),monto:d.saldo}); } renderDeudas(); renderCarrito(); }
function selTodas() { carrito=carrito.filter(i=>i.tipo!=='deuda'); deudasDisp.forEach(d=>carrito.push({tipo:'deuda',deuda_id:d.id,descripcion:`${d.concepto} ${d.periodo||''}`.trim(),monto:d.saldo})); renderDeudas(); renderCarrito(); }

// ‚îÄ‚îÄ CAT√ÅLOGO ‚îÄ‚îÄ
async function cargarCats() { try { const r=await fetch(`${API}/categorias`); const c=await r.json(); document.getElementById('catsGrid').innerHTML=`<span class="cat-chip active" onclick="filtCat(null,this)">Todos</span>`+c.map(x=>`<span class="cat-chip" onclick="filtCat('${x.codigo}',this)">${x.nombre} (${x.total})</span>`).join(''); } catch(e){} }
async function cargarConceptos(cat) { try { let u=`${API}/conceptos`; if(cat) u+=`?categoria=${cat}`; const r=await fetch(u); conceptosDisp=await r.json(); document.getElementById('cntConceptos').textContent=conceptosDisp.length; renderConc(); } catch(e){} }
function filtCat(c,el) { catActiva=c; document.querySelectorAll('.cat-chip').forEach(x=>x.classList.remove('active')); if(el)el.classList.add('active'); cargarConceptos(c); }
function renderConc() { document.getElementById('concLista').innerHTML=conceptosDisp.map(c=>`<div class="concepto-row" onclick="addConc(${c.id})"><div><div class="c-nombre">${c.nombre_corto||c.nombre}</div><div class="c-cat">${c.categoria}${c.maneja_stock?` ¬∑ Stock: ${c.stock_actual}`:''}</div></div><div class="c-precio">${c.monto_base>0?`S/ ${c.monto_base.toFixed(2)}`:'Variable'}</div></div>`).join(''); }
function addConc(id) {
    const c=conceptosDisp.find(x=>x.id===id); if(!c) return;
    if(c.requiere_colegiado&&!colActual){toast('Selecciona un colegiado','err');return;}
    let m=c.monto_base; if(c.permite_monto_libre||m===0){const i=prompt(`Monto para "${c.nombre}":`,m>0?m:'');if(!i)return;m=parseFloat(i);if(isNaN(m)||m<=0){toast('Monto inv√°lido','err');return;}}
    carrito.push({tipo:'concepto',concepto_id:c.id,descripcion:c.nombre_corto||c.nombre,cantidad:1,monto_unitario:m,monto:m}); renderCarrito(); toast(`${c.nombre_corto||c.nombre} agregado`,'ok');
}

// ‚îÄ‚îÄ CARRITO ‚îÄ‚îÄ
function renderCarrito() {
    const t=carrito.reduce((s,i)=>s+i.monto,0); document.getElementById('cartCnt').textContent=carrito.length;
    document.getElementById('cartTot').textContent=t.toFixed(2); document.getElementById('btnMonto').textContent=`S/ ${t.toFixed(2)}`;
    document.getElementById('btnCobrar').disabled=!carrito.length;
    const fb=document.getElementById('fabBadge'); if(carrito.length){fb.style.display='block';fb.textContent=carrito.length;}else fb.style.display='none';
    if(!carrito.length){document.getElementById('cartBody').innerHTML='<div class="cart-empty"><div class="cart-empty-icon">üõí</div>Selecciona deudas o conceptos<br>para agregar al cobro</div>';return;}
    document.getElementById('cartBody').innerHTML=carrito.map((x,i)=>`<div class="cart-item"><div class="ci-info"><div class="ci-name">${x.descripcion}</div><div class="ci-type">${x.tipo==='deuda'?'Deuda':'Concepto'}</div></div><div class="ci-amt">S/ ${x.monto.toFixed(2)}</div><button class="ci-rm" onclick="rmItem(${i})">‚úï</button></div>`).join('');
}
function rmItem(i) { const x=carrito[i]; carrito.splice(i,1); if(x.tipo==='deuda') renderDeudas(); renderCarrito(); }
function toggleCart() { document.getElementById('panelRight').classList.toggle('open'); }

// ‚îÄ‚îÄ PAGO ‚îÄ‚îÄ
function requiereReferencia(m) { return METODOS_REQ_REF.includes(m); }

function setMetodo(m) {
    metodo = m;
    document.querySelectorAll('.m-btn').forEach(b => b.classList.toggle('active', b.dataset.m === m));
    const r = document.getElementById('refInput');
    const hint = document.getElementById('refHint');
    // Limpiar estado de error al cambiar m√©todo
    r.classList.remove('error');
    hint.classList.remove('visible');

    if (m !== 'efectivo') {
        r.classList.add('visible');
        r.placeholder = REF_PLACEHOLDERS[m] || 'Nro. de operaci√≥n / voucher';
        r.focus();
    } else {
        r.classList.remove('visible');
        r.value = '';
    }
}

function setComp(t) {
    tipoComp = t;
    document.querySelectorAll('.comp-btn').forEach(b => b.classList.toggle('active', b.dataset.c === t));
    const ff = document.getElementById('facturaFields');
    if (t === '01') {
        ff.classList.add('active');
        document.getElementById('ffRuc').focus();
    } else {
        ff.classList.remove('active');
    }
}
function setFormaPago(fp) {
    formaPago = fp;
    document.querySelectorAll('.pago-btn').forEach(b => b.classList.toggle('active', b.dataset.fp === fp));
}
async function buscarRuc() {
    const ruc = document.getElementById('ffRuc').value.trim();
    if (ruc.length !== 11) { toast('RUC debe tener 11 d√≠gitos', 'err'); return; }
    const btn = document.getElementById('ffBuscarRuc');
    btn.disabled = true; btn.textContent = '‚è≥';
    try {
        const r = await fetch(`${API}/consulta-ruc/${ruc}`);
        if (r.ok) {
            const d = await r.json();
            if (d.razon_social) {
                document.getElementById('ffRazonSocial').value = d.razon_social;
                document.getElementById('ffDireccion').value = d.direccion || '';
                toast('RUC encontrado', 'ok');
            } else {
                toast('RUC no encontrado', 'err');
            }
        } else { toast('Error consultando RUC', 'err'); }
    } catch(e) { toast('Error de conexi√≥n', 'err'); }
    btn.disabled = false; btn.textContent = 'üîç Buscar';
}
function cambiarTab(t) {
    tabAct=t; document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.t===t));
    document.getElementById('panelDeudas').style.display=t==='deudas'?'block':'none';
    document.getElementById('panelCatalogo').style.display=t==='catalogo'?'block':'none';
    document.getElementById('panelEgresos').style.display=t==='egresos'?'block':'none';
    document.getElementById('panelHistorial').style.display=t==='historial'?'block':'none';
    document.getElementById('panelComprobantes').style.display=t==='comprobantes'?'block':'none';
    if(t==='egresos') cargarEgresos();
    if(t==='historial') { if(!document.getElementById('histFecha').value) { const ah=new Date(); ah.setMinutes(ah.getMinutes()-ah.getTimezoneOffset()-300); document.getElementById('histFecha').value=ah.toISOString().split('T')[0]; } cargarHistorial(); }
    if(t==='comprobantes' && !document.getElementById('compLista').querySelector('.comp-row')) { buscarComprobantes(); }
}
function confirmarCobro() {
    if(!carrito.length) return;

    // ‚îÄ‚îÄ Validar N¬∞ operaci√≥n obligatorio ‚îÄ‚îÄ
    if (requiereReferencia(metodo)) {
        const ref = document.getElementById('refInput').value.trim();
        if (!ref) {
            const refEl = document.getElementById('refInput');
            const hintEl = document.getElementById('refHint');
            refEl.classList.add('error');
            hintEl.classList.add('visible');
            refEl.focus();
            toast(`Ingresa el N¬∞ de operaci√≥n para ${metodo.charAt(0).toUpperCase() + metodo.slice(1)}`, 'err');
            return;
        }
    }

    // ‚îÄ‚îÄ Validar datos de Factura ‚îÄ‚îÄ
    if (tipoComp === '01') {
        const ruc = document.getElementById('ffRuc').value.trim();
        const razon = document.getElementById('ffRazonSocial').value.trim();
        if (!ruc || ruc.length !== 11) {
            document.getElementById('ffRuc').classList.add('error');
            document.getElementById('ffRuc').focus();
            toast('Ingresa un RUC v√°lido (11 d√≠gitos)', 'err');
            return;
        }
        document.getElementById('ffRuc').classList.remove('error');
        if (!razon) {
            document.getElementById('ffRazonSocial').classList.add('error');
            document.getElementById('ffRazonSocial').focus();
            toast('Ingresa la Raz√≥n Social', 'err');
            return;
        }
        document.getElementById('ffRazonSocial').classList.remove('error');
    }

    const t=carrito.reduce((s,i)=>s+i.monto,0);
    const ref = document.getElementById('refInput').value.trim();
    const fpLabel = formaPago === 'credito' ? 'üìÖ Cr√©dito' : 'üíµ Contado';
    let clienteLabel = colActual ? colActual.apellidos_nombres : 'P√∫blico general';
    if (tipoComp === '01') { clienteLabel = document.getElementById('ffRazonSocial').value.trim() + ' (RUC: ' + document.getElementById('ffRuc').value.trim() + ')'; }
    document.getElementById('mTotal').textContent=`S/ ${t.toFixed(2)}`;
    document.getElementById('mDetail').innerHTML=`<div><span>Cliente:</span><span>${clienteLabel}</span></div><div><span>Items:</span><span>${carrito.length}</span></div><div><span>M√©todo:</span><span>${metodo}${ref ? ' ¬∑ Op: ' + ref : ''}</span></div><div><span>Comprobante:</span><span>${tipoComp==='01'?'Factura':'Boleta'} ¬∑ ${fpLabel}</span></div>`;
    document.getElementById('modalConfirm').classList.add('active');
}
function cerrarModal() { document.getElementById('modalConfirm').classList.remove('active'); }
async function ejecutarCobro() {
    cerrarModal(); const total=carrito.reduce((s,i)=>s+i.monto,0); const ref=document.getElementById('refInput').value.trim();
    const payload={colegiado_id:colActual?.id||null,items:carrito.map(i=>({tipo:i.tipo,deuda_id:i.deuda_id||null,concepto_id:i.concepto_id||null,descripcion:i.descripcion,cantidad:i.cantidad||1,monto_unitario:i.monto_unitario||i.monto,monto_total:i.monto})),total,metodo_pago:metodo,referencia_pago:ref||null,tipo_comprobante:tipoComp,forma_pago:formaPago};
    // Agregar datos de factura si aplica
    if (tipoComp === '01') {
        payload.cliente_ruc = document.getElementById('ffRuc').value.trim();
        payload.cliente_razon_social = document.getElementById('ffRazonSocial').value.trim();
        payload.cliente_direccion = document.getElementById('ffDireccion').value.trim();
    }
    try { const r=await fetch(`${API}/cobrar`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const d=await r.json();
        if(d.success){
            document.getElementById('successAmt').textContent=`S/ ${total.toFixed(2)}`;
            document.getElementById('successRef').textContent=`${metodo.toUpperCase()} ${ref?'¬∑ Op: '+ref:''} ¬∑ ${colActual?.apellidos_nombres||'P√∫blico general'}`;

            // Comprobante electr√≥nico
            const compEl = document.getElementById('successComp');
            const compNum = document.getElementById('successCompNum');
            const compLoading = document.getElementById('successCompLoading');
            const compActions = document.getElementById('successActions');
            const compPdf = document.getElementById('successCompPdf');
            const compErr = document.getElementById('successCompErr');
            compErr.textContent = '';
            lastCompPdfUrl = null;

            // Guardar payment_id para polling
            lastPaymentId = d.payment_id || null;

            if (d.comprobante_numero) {
                lastCompNumero = d.comprobante_numero;
                compNum.textContent = 'üìÑ ' + d.comprobante_numero;
                compEl.classList.add('active');

                if (d.comprobante_pdf && lastPaymentId) {
                    // PDF reportado disponible ‚Äî usar proxy URL
                    const proxyUrl = `${API}/comprobante/${lastPaymentId}/pdf`;
                    lastCompPdfUrl = proxyUrl;
                    compPdf.href = proxyUrl;
                    compLoading.style.display = 'none';
                    compActions.style.display = 'flex';
                } else if (lastPaymentId) {
                    // PDF a√∫n no disponible ‚Äî iniciar polling
                    compLoading.style.display = 'flex';
                    compActions.style.display = 'none';
                    startPdfPolling(lastPaymentId);
                }
            } else {
                compEl.classList.remove('active');
                if (!d.comprobante_emitido && d.comprobante_mensaje) {
                    compErr.textContent = d.comprobante_mensaje;
                    compEl.classList.add('active');
                    compLoading.style.display = 'none';
                    compActions.style.display = 'none';
                }
            }

            document.getElementById('successBg').classList.add('active');
            carrito = []; renderCarrito();
            if (colActual) cargarDeudas(colActual.id);
            cargarResumen();

            // Limpiar ref input
            document.getElementById('refInput').value = '';
            document.getElementById('refInput').classList.remove('error');
            document.getElementById('refHint').classList.remove('visible');

            // Limpiar campos factura y resetear
            document.getElementById('ffRuc').value = '';
            document.getElementById('ffRazonSocial').value = '';
            document.getElementById('ffDireccion').value = '';
            setComp('03'); // Volver a Boleta por defecto
            setFormaPago('contado'); // Volver a Contado por defecto

            // Si no hay comprobante, auto-cerrar despu√©s de 2.5s
            if (!d.comprobante_numero) { setTimeout(cerrarSuccess, 2500); }
        }
        else toast(d.detail||'Error','err');
    } catch(e){toast('Error','err');}
}
function cerrarSuccess() {
    stopPdfPolling();
    document.getElementById('successBg').classList.remove('active');
    document.getElementById('successComp').classList.remove('active');
    document.getElementById('successActions').style.display = 'none';
    document.getElementById('successCompLoading').style.display = 'none';
    document.getElementById('searchInput').focus();
}
document.getElementById('successBg').addEventListener('click', e => {
    // No cerrar si se hizo clic en un bot√≥n de acci√≥n
    if (e.target.closest('.success-action-btn')) return;
    cerrarSuccess();
});

// ‚îÄ‚îÄ POLLING PDF ‚îÄ‚îÄ
function startPdfPolling(paymentId) {
    stopPdfPolling();
    let intentos = 0;
    const maxIntentos = 15; // 15 x 2s = 30 segundos m√°ximo
    pdfPollTimer = setInterval(async () => {
        intentos++;
        try {
            const r = await fetch(`${API}/comprobante/${paymentId}`);
            if (r.ok) {
                const d = await r.json();
                if (d.pdf_url) {
                    lastCompPdfUrl = d.pdf_url;
                    document.getElementById('successCompPdf').href = d.pdf_url;
                    document.getElementById('successCompLoading').style.display = 'none';
                    document.getElementById('successActions').style.display = 'flex';
                    stopPdfPolling();
                    return;
                }
            }
        } catch(e) {}
        if (intentos >= maxIntentos) {
            stopPdfPolling();
            document.getElementById('successCompLoading').innerHTML = '‚ö† PDF en proceso. Revisa en Historial.';
        }
    }, 2000);
}
function stopPdfPolling() { if (pdfPollTimer) { clearInterval(pdfPollTimer); pdfPollTimer = null; } }

// ‚îÄ‚îÄ COMPARTIR COMPROBANTE ‚îÄ‚îÄ
async function compartirComprobante() {
    const numero = lastCompNumero || 'Comprobante';
    const pdfUrl = lastCompPdfUrl;
    const texto = `${numero} ‚Äî CCPL\nTotal: ${document.getElementById('successAmt').textContent}\n${pdfUrl || ''}`;

    // Intentar Web Share API (m√≥vil)
    if (navigator.share && pdfUrl) {
        try {
            await navigator.share({ title: numero, text: texto, url: pdfUrl });
            return;
        } catch(e) { /* usuario cancel√≥ o no soportado */ }
    }

    // Fallback: copiar al clipboard
    try {
        await navigator.clipboard.writeText(pdfUrl || texto);
        toast('Link copiado al portapapeles', 'ok');
    } catch(e) {
        // √öltimo fallback
        const ta = document.createElement('textarea');
        ta.value = pdfUrl || texto;
        document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        toast('Link copiado', 'ok');
    }
}

// ‚îÄ‚îÄ VER COMPROBANTE DESDE HISTORIAL ‚îÄ‚îÄ
async function verComprobante(paymentId) {
    window.open(`${API}/comprobante/${paymentId}/pdf`, '_blank');
}

// ‚îÄ‚îÄ EGRESOS ‚îÄ‚îÄ
async function cargarEgresos() { try { const r=await fetch(`${API}/egresos-actual?centro_costo_id=1`); renderEgr(await r.json()); } catch(e){} }
function renderEgr(data) {
    const {egresos,totales}=data; document.getElementById('cntEgresos').textContent=egresos.length;
    const s=document.getElementById('egrSummary');
    if(egresos.length){s.style.display='block';document.getElementById('egrTotEnt').textContent=`S/ ${totales.entregado.toFixed(2)}`;document.getElementById('egrTotFact').textContent=`S/ ${totales.facturado.toFixed(2)}`;document.getElementById('egrTotDev').textContent=`S/ ${totales.devuelto.toFixed(2)}`;const pr=document.getElementById('egrPendRow');if(totales.pendientes>0){pr.style.display='flex';document.getElementById('egrPend').textContent=totales.pendientes;}else pr.style.display='none';}else s.style.display='none';
    const tl={gasto:'üõí Gasto',devolucion:'‚Ü©Ô∏è Devoluci√≥n',retiro_fondo:'üè¶ Retiro'};
    const l=document.getElementById('egrLista');
    if(!egresos.length){l.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:11px;">Sin egresos en esta sesi√≥n</div>';return;}
    l.innerHTML=egresos.map(e=>`<div class="egr-item ${e.estado}"><div class="egr-item-top"><div class="egr-item-concepto">${e.concepto}</div><div class="egr-item-monto">- S/ ${e.monto.toFixed(2)}</div></div><div class="egr-item-meta"><span>üë§ ${e.responsable}</span><span>üïê ${e.hora}</span><span>${tl[e.tipo]||e.tipo}</span><span class="egr-badge ${e.estado}">${e.estado==='pendiente'?'‚è≥ Pendiente':'‚úì Liquidado'}</span></div>${e.estado==='liquidado'?`<div class="egr-liq-detail"><div><span>Factura${e.numero_documento?' ('+e.numero_documento+')':''}:</span><span class="mono">S/ ${(e.monto_factura??0).toFixed(2)}</span></div>${e.monto_devuelto>0?`<div><span>Vuelto a caja:</span><span class="mono" style="color:var(--green)">+ S/ ${e.monto_devuelto.toFixed(2)}</span></div>`:''}</div>`:`<button class="btn-liquidar" onclick="abrirLiq(${e.id},${e.monto},'${e.concepto.replace(/'/g,"\\'")}','${e.responsable.replace(/'/g,"\\'")}')">üìÑ Liquidar (trajo factura)</button>`}</div>`).join('');
}
async function registrarEgreso() {
    const m=parseFloat(document.getElementById('eMonto').value),resp=document.getElementById('eResp').value.trim(),conc=document.getElementById('eConc').value.trim(),det=document.getElementById('eDet').value.trim(),tipo=document.getElementById('eTipo').value;
    if(!m||m<=0){toast('Ingresa monto','err');return;}if(!resp){toast('Ingresa responsable','err');return;}if(!conc){toast('Ingresa concepto','err');return;}
    try{const r=await fetch(`${API}/egreso?centro_costo_id=1`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({monto:m,responsable:resp,concepto:conc,detalle:det||null,tipo})});const d=await r.json();
        if(d.success){toast(d.mensaje,'ok');['eMonto','eResp','eConc','eDet'].forEach(x=>document.getElementById(x).value='');document.getElementById('eTipo').value='gasto';cargarEgresos();}else toast(d.detail||'Error','err');
    }catch(e){toast('Error','err');}
}

// ‚îÄ‚îÄ LIQUIDAR ‚îÄ‚îÄ
function abrirLiq(id,monto,concepto,responsable) {
    document.getElementById('liqId').value=id; document.getElementById('liqOriginal').value=monto;
    document.getElementById('liqInfo').innerHTML=`<strong>${concepto}</strong><br>Responsable: ${responsable}<br>Entregado: <strong>S/ ${monto.toFixed(2)}</strong>`;
    document.getElementById('liqFactura').value=''; document.getElementById('liqNroDoc').value=''; document.getElementById('liqVuelto').style.display='none';
    document.getElementById('modalLiquidar').classList.add('active'); document.getElementById('liqFactura').focus();
}
function calcVuelto() {
    const o=parseFloat(document.getElementById('liqOriginal').value)||0, f=parseFloat(document.getElementById('liqFactura').value), el=document.getElementById('liqVuelto');
    if(isNaN(f)){el.style.display='none';return;} const v=o-f; el.style.display='block';
    if(v>0){el.className='c-diff over';el.textContent=`Vuelto a caja: + S/ ${v.toFixed(2)}`;}
    else if(v===0){el.className='c-diff ok';el.textContent='‚úì Monto exacto';}
    else{el.className='c-diff under';el.textContent='‚ö† Factura mayor al entregado';}
}
function cerrarModalLiq() { document.getElementById('modalLiquidar').classList.remove('active'); }
async function ejecutarLiq() {
    const id=document.getElementById('liqId').value, mf=parseFloat(document.getElementById('liqFactura').value), nd=document.getElementById('liqNroDoc').value.trim();
    if(isNaN(mf)||mf<0){toast('Ingresa monto factura','err');return;}
    try{const r=await fetch(`${API}/egreso/${id}/liquidar`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({monto_factura:mf,numero_documento:nd||null})});const d=await r.json();
        if(d.success){cerrarModalLiq();toast(d.mensaje,'ok');cargarEgresos();}else toast(d.detail||'Error','err');
    }catch(e){toast('Error','err');}
}

// ‚îÄ‚îÄ HISTORIAL ‚îÄ‚îÄ
async function cargarHistorial() {
    const fecha = document.getElementById('histFecha').value;
    const tipo = document.getElementById('histTipo').value;
    if(!fecha) return;
    try {
        let url = `${API}/historial-cobros?fecha=${fecha}`;
        if(tipo) url += `&metodo_pago=${tipo}`;
        const r = await fetch(url);
        const d = await r.json();
        renderHistorial(d);
    } catch(e) { document.getElementById('histLista').innerHTML = '<div class="hist-empty">Error cargando historial</div>'; }
}

function renderHistorial(data) {
    const ops = data.operaciones || data.cobros || data || [];
    const lista = document.getElementById('histLista');
    const summ = document.getElementById('histSummary');

    // Summary
    if(ops.length) {
        const activos = ops.filter(o=>o.status!=='anulado'&&o.status!=='refunded');
        const anulados = ops.length - activos.length;
        const totalEfect = activos.filter(o=>o.metodo_pago==='efectivo').reduce((s,o)=>s+(o.amount||o.total||0),0);
        const totalDigit = activos.filter(o=>o.metodo_pago!=='efectivo').reduce((s,o)=>s+(o.amount||o.total||0),0);
        const totalGen = activos.reduce((s,o)=>s+(o.amount||o.total||0),0);
        summ.innerHTML = `
            <div class="hist-stat"><div class="hist-stat-val">${activos.length}${anulados?` <span style="font-size:11px;color:var(--red)">(-${anulados})</span>`:''}</div><div class="hist-stat-lbl">Operaciones</div></div>
            <div class="hist-stat"><div class="hist-stat-val">S/ ${totalGen.toFixed(2)}</div><div class="hist-stat-lbl">Total cobrado</div></div>
            <div class="hist-stat"><div class="hist-stat-val">S/ ${totalEfect.toFixed(2)}</div><div class="hist-stat-lbl">Efectivo</div></div>
            <div class="hist-stat"><div class="hist-stat-val">S/ ${totalDigit.toFixed(2)}</div><div class="hist-stat-lbl">Digital</div></div>`;
    } else { summ.innerHTML = ''; }

    if(!ops.length) { lista.innerHTML = '<div class="hist-empty">Sin operaciones en esta fecha</div>'; return; }

    lista.innerHTML = ops.map(o => {
        const hora = o.reviewed_at ? new Date(o.reviewed_at).toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'}) : (o.hora||'--:--');
        const monto = o.amount || o.total || 0;
        const desc = o.notes || o.descripcion || 'Cobro';
        const compNum = o.numero_comprobante || o.comprobante_numero || '';
        const esAnulado = o.status === 'anulado' || o.status === 'refunded';

        // ‚îÄ‚îÄ Detectar NC parcial en notas ‚îÄ‚îÄ
        const ncParcialMatch = desc.match(/\[NC PARCIAL S\/([\d.]+)\]/);
        const ncNumMatch = desc.match(/\[NC:\s*([^\]]+)\]/);
        const tieneNC = ncParcialMatch || ncNumMatch || esAnulado;
        const ncMonto = ncParcialMatch ? ncParcialMatch[1] : null;
        const ncNumero = ncNumMatch ? ncNumMatch[1].trim() : null;

        // ‚îÄ‚îÄ Descripci√≥n limpia (sin tags internos) ‚îÄ‚îÄ
        const descLimpia = desc.replace('[CAJA] ','').replace(/\[NC PARCIAL S\/[\d.]+\][^\[]*/g,'').replace(/\[NC:[^\]]+\]/g,'').replace(/\[ANULADO\][^\[]*/g,'').trim();

        // ‚îÄ‚îÄ Badge NC parcial ‚îÄ‚îÄ
        let ncBadge = '';
        if(ncParcialMatch && !esAnulado) {
            ncBadge = `<span style="display:inline-block;background:rgba(251,191,36,0.15);color:#fbbf24;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:6px;">NC parcial S/ ${ncMonto}</span>`;
        }
        if(ncNumero) {
            ncBadge += `<span style="display:inline-block;background:rgba(99,102,241,0.12);color:#818cf8;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:4px;">üìÑ ${ncNumero}</span>`;
        }

        // ‚îÄ‚îÄ Tooltip detallado ‚îÄ‚îÄ
        let tooltip = descLimpia;
        if(ncMonto) tooltip += ` | NC Parcial: S/ ${ncMonto}`;
        if(ncNumero) tooltip += ` | ${ncNumero}`;
        if(esAnulado) tooltip += ' | ANULADO';

        return `<div class="hist-item${esAnulado?' anulado':''}" title="${tooltip}">
            <span class="hist-hora">${hora}</span>
            <div style="flex:1;overflow:hidden;">
                <div class="hist-desc">${descLimpia}${ncBadge}</div>
                ${compNum ? `<div class="hist-comp">üìÑ ${compNum}</div>` : ''}
                ${esAnulado ? '<span class="hist-badge-anulado">anulado</span>' : ''}
            </div>
            <span class="hist-metodo">${o.metodo_pago || o.payment_method || ''}</span>
            <span class="hist-monto${esAnulado?' hist-monto-tachado':''}">S/ ${monto.toFixed(2)}</span>
            ${compNum && !esAnulado ? `<button class="hist-pdf" onclick="verComprobante(${o.id})" title="Ver comprobante PDF">üìÑ</button>` : ''}
            ${!esAnulado ? `<button class="hist-anular" onclick="mostrarAnular(${o.id},'${descLimpia.replace(/'/g,"\\'")}',${monto})" title="${tieneNC && !esAnulado ? 'Ya tiene NC parcial' : 'Anular cobro'}">Anular</button>` : ''}
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ MEN√ö / LOGOUT / CAMBIAR CAJA ‚îÄ‚îÄ
function toggleMenu() {
    const m = document.getElementById('headerMenu');
    m.classList.toggle('active');
    if(m.classList.contains('active')) {
        setTimeout(()=> document.addEventListener('click', cerrarMenuFuera, {once:true}), 10);
    }
}
function cerrarMenuFuera(e) {
    const m = document.getElementById('headerMenu');
    if(!e.target.closest('.hdr-menu')) m.classList.remove('active');
}

function notificarDesdeCaja() {
    document.getElementById('headerMenu').classList.remove('active');
    toast('Notificaciones: pr√≥ximamente','ok');
}

function cerrarSesionUsuario() {
    document.getElementById('headerMenu').classList.remove('active');
    if(sesion) {
        if(!confirm('Tienes una caja abierta. Debes cerrarla antes de salir.\n¬øIr al cierre de caja?')) return;
        mostrarCierreCaja();
        return;
    }
    window.location.href = '/logout';
}

// ‚îÄ‚îÄ EXPORTAR ‚îÄ‚îÄ
function exportarDia() {
    const fecha = document.getElementById('histFecha').value;
    if(!fecha) { toast('Selecciona una fecha','err'); return; }
    window.open(`/api/reportes/exportar-dia?fecha=${fecha}`, '_blank');
}

// ‚îÄ‚îÄ ANULACI√ìN ‚îÄ‚îÄ
function mostrarAnular(payId, desc, monto) {
    document.getElementById('anularPayId').value = payId;
    document.getElementById('anularTotal').value = monto;
    document.getElementById('anularInfo').innerHTML = `<strong>S/ ${monto.toFixed(2)}</strong> ‚Äî ${desc.replace('[CAJA] ','')}`;
    document.getElementById('anularMotivo').value = '01';
    document.getElementById('anularObs').value = '';
    document.getElementById('anularMonto').value = '';
    document.getElementById('anularMontoCont').style.display = 'none';
    document.getElementById('modalAnular').classList.add('active');
}
function cerrarModalAnular() { document.getElementById('modalAnular').classList.remove('active'); }

function toggleMontoParcial() {
    const m = document.getElementById('anularMotivo').value;
    const necesitaMonto = ['04', '05', '07'].includes(m);
    document.getElementById('anularMontoCont').style.display = necesitaMonto ? 'block' : 'none';
    if (necesitaMonto) document.getElementById('anularMonto').focus();
}

async function ejecutarAnulacion() {
    const payId = document.getElementById('anularPayId').value;
    let motivo = document.getElementById('anularMotivo').value;
    const obs = document.getElementById('anularObs').value.trim();
    let motivoTexto = document.getElementById('anularMotivo').selectedOptions[0].text;
    const totalOriginal = parseFloat(document.getElementById('anularTotal').value) || 0;

    let montoAnular = totalOriginal;
    const motivosParciales = ['04', '05', '07'];
    if(motivosParciales.includes(motivo)) {
        montoAnular = parseFloat(document.getElementById('anularMonto').value) || 0;
        if(montoAnular <= 0) { toast('Ingresa el monto','err'); return; }
        if(montoAnular > totalOriginal) { toast(`El monto no puede superar S/ ${totalOriginal.toFixed(2)}`,'err'); return; }
        if(motivo === '07' && Math.abs(montoAnular - totalOriginal) < 0.01) { motivo = '06'; motivoTexto = 'Devoluci√≥n total'; }
    }

    const esParcial = motivosParciales.includes(motivo);
    if(!confirm(`¬øConfirmas la ${esParcial?'operaci√≥n por S/ '+montoAnular.toFixed(2):'ANULACI√ìN'}?\nMotivo: ${motivoTexto}`)) return;

    try {
        const r = await fetch(`${API}/anular-cobro`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ payment_id: parseInt(payId), motivo_codigo: motivo, motivo_texto: motivoTexto, monto: montoAnular, observaciones: obs })
        });
        const d = await r.json();
        if(d.success) {
            cerrarModalAnular();
            toast('Cobro anulado' + (d.nota_credito ? ` ¬∑ NC: ${d.nota_credito} (en proceso SUNAT)` : ''), 'ok');
            cargarHistorial();
            cargarResumen();
        } else {
            toast(d.detail || d.error || 'Error al anular', 'err');
        }
    } catch(e) { toast('Error de conexi√≥n', 'err'); }
}

function toast(msg,type='ok'){const el=document.createElement('div');el.className=`toast toast-${type}`;el.textContent=msg;document.getElementById('toastBox').appendChild(el);setTimeout(()=>el.remove(),3000);}


// ‚îÄ‚îÄ COMPROBANTES ‚îÄ‚îÄ
let compPageActual = 1;

async function buscarComprobantes(page = 1) {
    compPageActual = page;
    const buscar = document.getElementById('compBuscar').value.trim();
    const tipo = document.getElementById('compTipo').value;
    const estado = document.getElementById('compEstado').value;

    let url = `${API}/comprobantes?page=${page}&limit=20`;
    if (buscar) url += `&buscar=${encodeURIComponent(buscar)}`;
    if (tipo) url += `&tipo=${tipo}`;
    if (estado) url += `&estado=${estado}`;

    try {
        const r = await fetch(url);
        const d = await r.json();
        renderComprobantes(d);
    } catch (e) {
        document.getElementById('compLista').innerHTML = '<div class="hist-empty">Error cargando comprobantes</div>';
    }
}

function renderComprobantes(data) {
    const lista = document.getElementById('compLista');
    const pag = document.getElementById('compPaginacion');
    const summ = document.getElementById('compSummary');
    const comps = data.comprobantes || [];

    // Summary
    if (data.total > 0) {
        summ.innerHTML = `<div style="font-size:12px;color:var(--text-sec);">${data.total} comprobante(s) encontrado(s) ‚Äî P√°gina ${data.page}/${data.pages}</div>`;
    } else {
        summ.innerHTML = '';
    }

    if (!comps.length) {
        lista.innerHTML = '<div class="hist-empty">No se encontraron comprobantes</div>';
        pag.innerHTML = '';
        return;
    }

    const tipoIcons = { '01': 'üßæ', '03': 'üßæ', '07': '‚Ü©Ô∏è', '08': '‚ÜóÔ∏è' };
    const tipoNames = { '01': 'Factura', '03': 'Boleta', '07': 'NC', '08': 'ND' };
    const statusBadge = (s) => {
        const map = {
            'accepted': ['Aceptado', '#22c55e', 'rgba(34,197,94,0.1)'],
            'pending': ['Pendiente', '#f59e0b', 'rgba(245,158,11,0.1)'],
            'encolado': ['Encolado', '#f59e0b', 'rgba(245,158,11,0.1)'],
            'rejected': ['Rechazado', '#ef4444', 'rgba(239,68,68,0.1)'],
            'anulado': ['Anulado', '#6b7280', 'rgba(107,114,128,0.1)'],
            'error': ['Error', '#ef4444', 'rgba(239,68,68,0.1)'],
        };
        const [label, color, bg] = map[s] || ['?', '#888', 'rgba(136,136,136,0.1)'];
        return `<span style="display:inline-block;font-size:10px;padding:2px 8px;border-radius:4px;color:${color};background:${bg};font-weight:600;">${label}</span>`;
    };

    lista.innerHTML = comps.map(c => {
        const icon = tipoIcons[c.tipo] || 'üìÑ';
        const tipoNombre = tipoNames[c.tipo] || c.tipo;
        const esNC = c.tipo === '07' || c.tipo === '08';

        return `<div class="comp-row" style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s;" onmouseenter="this.style.background='rgba(255,255,255,0.03)'" onmouseleave="this.style.background='transparent'">
            <div style="min-width:28px;text-align:center;font-size:16px;" title="${tipoNombre}">${icon}</div>
            <div style="flex:1;overflow:hidden;">
                <div style="font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    ${c.numero_formato}
                    ${esNC ? '<span style="font-size:10px;color:#818cf8;margin-left:4px;">NC</span>' : ''}
                </div>
                <div style="font-size:11px;color:var(--text-sec);margin-top:2px;">
                    ${c.cliente_nombre || 'Sin cliente'}
                    ${c.cliente_doc ? `<span style="opacity:0.5;margin-left:4px;">${c.cliente_doc}</span>` : ''}
                </div>
                <div style="font-size:10px;color:var(--text-sec);opacity:0.6;margin-top:1px;">${c.fecha}</div>
            </div>
            <div style="text-align:right;min-width:80px;">
                <div style="font-size:14px;font-weight:600;color:${esNC ? '#f59e0b' : 'var(--green)'};">S/ ${c.total.toFixed(2)}</div>
                ${statusBadge(c.status)}
            </div>
            <div style="display:flex;gap:4px;min-width:70px;justify-content:flex-end;">
                ${c.pdf_url ? `<button class="hist-pdf" onclick="window.open('/api/caja/comprobante/${c.payment_id}/pdf','_blank')" title="Ver PDF">üìÑ</button>` : ''}
                ${c.status === 'accepted' && !esNC ? `<button class="hist-anular" onclick="mostrarAnular(${c.payment_id},'${(c.cliente_nombre||'').replace(/'/g,"\\'")} - ${c.numero_formato}',${c.total})" title="Emitir NC">Anular</button>` : ''}
            </div>
        </div>`;
    }).join('');

    // Paginaci√≥n
    if (data.pages > 1) {
        let pagHTML = '';
        if (data.page > 1) pagHTML += `<button class="pag-btn" onclick="buscarComprobantes(${data.page - 1})">‚Äπ</button>`;
        for (let i = Math.max(1, data.page - 2); i <= Math.min(data.pages, data.page + 2); i++) {
            pagHTML += `<button class="pag-btn${i === data.page ? ' pag-active' : ''}" onclick="buscarComprobantes(${i})">${i}</button>`;
        }
        if (data.page < data.pages) pagHTML += `<button class="pag-btn" onclick="buscarComprobantes(${data.page + 1})">‚Ä∫</button>`;
        pag.innerHTML = pagHTML;
    } else {
        pag.innerHTML = '';
    }
}

    async function verSesionesAnteriores() {
        try {
            const r = await fetch('/api/caja/sesiones-caja?estado=cerrada&limit=10');
            const d = await r.json();
            const sesiones = d.sesiones || [];

            if (!sesiones.length) {
                toast('No hay sesiones cerradas', 'info');
                return;
            }

            const items = sesiones.map(s => {
                const dif = s.diferencia || 0;
                const difStr = Math.abs(dif) < 0.01 ? '‚úì' : `${dif >= 0 ? '+' : ''}${dif.toFixed(2)}`;
                return `${s.fecha} ‚Äî ${s.cajero} ‚Äî S/ ${s.total_cobros.toFixed(2)} ‚Äî ${difStr}`;
            });

            const sel = prompt(
                'Sesiones cerradas (ingrese n√∫mero para descargar PDF):\n\n' +
                sesiones.map((s, i) => `${i + 1}. ${items[i]}`).join('\n')
            );

            if (sel && !isNaN(sel)) {
                const idx = parseInt(sel) - 1;
                if (idx >= 0 && idx < sesiones.length) {
                    const url = `/api/caja/cierre-caja/${sesiones[idx].id}/pdf`;
                    const win = window.open(url, '_blank');
                    if (!win || win.closed) {
                        const a = document.createElement('a');
                        a.href = url;
                        a.target = '_blank';
                        a.click();
                    }
                }
            }
        } catch (e) {
            toast('Error cargando sesiones', 'error');
        }
    }

/* TERCER BLOQUE */

// Instancia para CAJA
const verifCaja = new VerificadorPago({
    intervalo: 10000,    // Cada 10 seg
    maxIntentos: 12,     // 2 minutos

    onVerificado: (data) => {
        const badge = document.getElementById('verifBadge');
        badge.className = 'verif-ok';
        document.getElementById('verifIcon').textContent = '‚úÖ';
        document.getElementById('verifText').innerHTML = 
            `<strong>Pago verificado</strong> ‚Äî ${data.banco.toUpperCase()} ${data.codigo_operacion ? '#' + data.codigo_operacion : ''}`;
        document.getElementById('verifTimer').textContent = data.fecha || '';

        // Toast
        if (typeof toast === 'function') toast(data.message, 'ok');

        // Ocultar despu√©s de 10 seg
        setTimeout(() => { badge.style.display = 'none'; }, 10000);
    },

    onTimeout: (monto, metodo, paymentId) => {
        const badge = document.getElementById('verifBadge');
        badge.className = 'verif-fail';
        document.getElementById('verifIcon').textContent = '‚ö†Ô∏è';
        document.getElementById('verifText').innerHTML = 
            `No verificado a√∫n ‚Äî <a href="#" onclick="reiniciarVerifCaja(${monto},'${metodo}',${paymentId});return false;" style="color:var(--accent);">Reintentar</a>`;
        document.getElementById('verifTimer').textContent = '';
    },

    onProgreso: (intento, max) => {
        const segs = (max - intento) * 10;
        document.getElementById('verifTimer').textContent = `${segs}s`;
        document.getElementById('verifIcon').textContent = 'üîç';
        document.getElementById('verifIcon').className = 'verif-pulsing';
    },
});

/**
 * Llamar despu√©s de registrar cobro digital exitoso.
 * 
 * INTEGRAR en la funci√≥n que procesa el cobro, por ejemplo:
 * 
 * async function registrarCobro(...) {
 *     const r = await fetch('/api/caja/cobrar', {...});
 *     const d = await r.json();
 *     if (d.success) {
 *         toast('Cobro registrado ‚úì', 'ok');
 *         // >>> AGREGAR ESTA L√çNEA <<<
 *         if (['yape','plin','transferencia'].includes(metodoPago)) {
 *             verificarPagoDigital(d.monto || monto, metodoPago, d.payment_id);
 *         }
 *     }
 * }
 */
function verificarPagoDigital(monto, metodo, paymentId) {
    const badge = document.getElementById('verifBadge');
    badge.style.display = 'flex';
    badge.className = '';
    document.getElementById('verifIcon').textContent = 'üîç';
    document.getElementById('verifIcon').className = 'verif-pulsing';
    document.getElementById('verifText').textContent = `Verificando pago S/ ${monto.toFixed(2)} (${metodo})...`;
    document.getElementById('verifTimer').textContent = '120s';

    verifCaja.iniciar(monto, metodo, paymentId);
}

function reiniciarVerifCaja(monto, metodo, paymentId) {
    verificarPagoDigital(monto, metodo, paymentId);
}

/* CUARTO BLOQUE */

    </script>
</body>
</html>