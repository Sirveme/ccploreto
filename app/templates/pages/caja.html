<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caja - CCPL</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1117;
            --bg-card: #1a1d27;
            --bg-card-hover: #222633;
            --bg-input: #161922;
            --border: #2a2e3b;
            --border-focus: #4f7df3;
            --text: #e8eaf0;
            --text-dim: #8b8fa3;
            --text-muted: #5a5e72;
            --accent: #4f7df3;
            --accent-soft: rgba(79, 125, 243, 0.12);
            --green: #34d399;
            --green-soft: rgba(52, 211, 153, 0.12);
            --green-dark: #059669;
            --red: #f87171;
            --red-soft: rgba(248, 113, 113, 0.1);
            --amber: #fbbf24;
            --amber-soft: rgba(251, 191, 36, 0.1);
            --radius: 10px;
            --radius-sm: 6px;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        .caja-layout { display: grid; grid-template-columns: 1fr 380px; grid-template-rows: 56px 1fr; height: 100vh; gap: 0; }

        /* HEADER */
        .caja-header { grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-logo { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 15px; color: var(--accent); letter-spacing: -0.5px; }
        .header-divider { width: 1px; height: 24px; background: var(--border); }
        .header-title { font-weight: 600; font-size: 14px; color: var(--text-dim); }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-stat { display: flex; align-items: center; gap: 8px; padding: 6px 14px; background: var(--bg); border-radius: 20px; font-size: 13px; }
        .header-stat .label { color: var(--text-dim); }
        .header-stat .value { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--green); }
        .header-time { font-family: 'JetBrains Mono', monospace; font-weight: 500; font-size: 13px; color: var(--text-dim); }

        .sesion-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .btn-cerrar-caja-header { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 14px; transition: all 0.15s; }
        .btn-cerrar-caja-header:hover { border-color: var(--red); }

        /* PANEL LEFT */
        .panel-left { display: flex; flex-direction: column; padding: 16px; gap: 12px; overflow: hidden; }

        /* SEARCH */
        .search-box { position: relative; }
        .search-input { width: 100%; padding: 14px 16px 14px 44px; background: var(--bg-card); border: 1.5px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: var(--border-focus); }
        .search-input::placeholder { color: var(--text-muted); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 18px; }
        .search-shortcut { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); padding: 3px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); max-height: 320px; overflow-y: auto; z-index: 100; box-shadow: var(--shadow); display: none; }
        .search-results.active { display: block; }
        .search-result-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; transition: background 0.15s; border-bottom: 1px solid var(--border); }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--bg-card-hover); }
        .result-info { flex: 1; }
        .result-name { font-weight: 600; font-size: 14px; }
        .result-meta { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
        .result-deuda { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; }
        .result-deuda.tiene-deuda { color: var(--red); }
        .result-deuda.sin-deuda { color: var(--green); }
        .badge-habil { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-habil.habil { background: var(--green-soft); color: var(--green); }
        .badge-habil.inhabil { background: var(--red-soft); color: var(--red); }

        /* COLEGIADO CARD */
        .colegiado-card { display: none; align-items: center; gap: 14px; padding: 14px 16px; background: var(--accent-soft); border: 1px solid rgba(79, 125, 243, 0.25); border-radius: var(--radius); }
        .colegiado-card.active { display: flex; }
        .colegiado-avatar { width: 42px; height: 42px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: white; flex-shrink: 0; }
        .colegiado-info { flex: 1; }
        .colegiado-nombre { font-weight: 600; font-size: 14px; }
        .colegiado-detalle { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
        .colegiado-clear { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 6px; border-radius: 6px; font-size: 18px; transition: color 0.15s; }
        .colegiado-clear:hover { color: var(--red); }

        /* TABS */
        .tabs-container { display: flex; gap: 4px; padding: 3px; background: var(--bg-card); border-radius: var(--radius); }
        .tab-btn { flex: 1; padding: 8px 12px; background: transparent; border: none; color: var(--text-dim); font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 13px; border-radius: 7px; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-btn .count { display: inline-block; padding: 1px 6px; background: rgba(255,255,255,0.15); border-radius: 8px; font-size: 11px; margin-left: 6px; }
        .tab-btn:not(.active) .count { background: var(--bg); }

        /* CONTENT SCROLL */
        .content-scroll { flex: 1; overflow-y: auto; padding-right: 4px; }
        .content-scroll::-webkit-scrollbar { width: 4px; }
        .content-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* DEUDAS */
        .deuda-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.15s; }
        .deuda-item:hover { border-color: var(--accent); background: var(--bg-card-hover); }
        .deuda-item.selected { border-color: var(--green); background: var(--green-soft); }
        .deuda-check { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; font-size: 12px; color: transparent; }
        .deuda-item.selected .deuda-check { border-color: var(--green); background: var(--green); color: white; }
        .deuda-info { flex: 1; }
        .deuda-concepto { font-weight: 500; font-size: 13px; }
        .deuda-periodo { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .deuda-monto { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 14px; white-space: nowrap; }
        .btn-seleccionar-todas { display: block; width: 100%; padding: 8px; background: var(--accent-soft); border: 1px dashed var(--accent); border-radius: var(--radius-sm); color: var(--accent); font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; margin-bottom: 8px; transition: all 0.2s; }
        .btn-seleccionar-todas:hover { background: var(--accent); color: white; }

        /* CAT√ÅLOGO */
        .categorias-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .cat-chip { padding: 6px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; color: var(--text-dim); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .cat-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        .cat-chip:hover:not(.active) { border-color: var(--text-dim); }
        .concepto-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.15s; }
        .concepto-item:hover { border-color: var(--accent); }
        .concepto-nombre { font-weight: 500; font-size: 13px; }
        .concepto-cat { font-size: 11px; color: var(--text-dim); }
        .concepto-precio { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 13px; color: var(--green); }

        /* PANEL RIGHT: CART */
        .panel-right { display: flex; flex-direction: column; background: var(--bg-card); border-left: 1px solid var(--border); }
        .cart-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .cart-title { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .cart-badge { background: var(--accent); color: white; padding: 1px 8px; border-radius: 10px; font-size: 12px; font-weight: 700; }
        .cart-items { flex: 1; overflow-y: auto; padding: 12px 16px; }
        .cart-items::-webkit-scrollbar { width: 4px; }
        .cart-items::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .cart-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; }
        .cart-empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.3; }
        .cart-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); animation: fadeSlideIn 0.2s ease; }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-size: 13px; font-weight: 500; }
        .cart-item-detail { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .cart-item-monto { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 13px; white-space: nowrap; }
        .cart-item-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; font-size: 14px; transition: color 0.15s; }
        .cart-item-remove:hover { color: var(--red); }

        /* CART FOOTER */
        .cart-footer { padding: 16px 20px; border-top: 1px solid var(--border); background: var(--bg); }
        .cart-total { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 16px; }
        .cart-total-label { font-weight: 600; font-size: 14px; color: var(--text-dim); }
        .cart-total-amount { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 28px; color: var(--green); }
        .cart-total-currency { font-size: 16px; color: var(--text-dim); margin-right: 4px; }
        .metodos-pago { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 14px; }
        .metodo-btn { padding: 8px 6px; background: var(--bg-card); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text-dim); font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.15s; }
        .metodo-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
        .metodo-btn:hover:not(.active) { border-color: var(--text-dim); }
        .metodo-icon { font-size: 18px; display: block; margin-bottom: 4px; }
        .ref-input { width: 100%; padding: 10px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; outline: none; margin-bottom: 12px; display: none; }
        .ref-input.visible { display: block; }
        .ref-input:focus { border-color: var(--border-focus); }
        .tipo-comprobante { display: flex; gap: 6px; margin-bottom: 14px; }
        .tipo-comp-btn { flex: 1; padding: 8px; background: var(--bg-card); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text-dim); font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.15s; }
        .tipo-comp-btn.active { border-color: var(--green); color: var(--green); background: var(--green-soft); }
        .btn-cobrar { width: 100%; padding: 16px; background: var(--green-dark); border: none; border-radius: var(--radius); color: white; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; letter-spacing: 0.3px; }
        .btn-cobrar:hover { background: #047857; transform: translateY(-1px); }
        .btn-cobrar:active { transform: translateY(0); }
        .btn-cobrar:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; transform: none; }
        .btn-cobrar .monto-cobrar { font-family: 'JetBrains Mono', monospace; }

        /* EMPTY */
        .empty-state { text-align: center; padding: 60px 30px; color: var(--text-muted); }
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.2; }
        .empty-title { font-size: 15px; font-weight: 600; color: var(--text-dim); margin-bottom: 6px; }
        .empty-desc { font-size: 13px; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px; width: 420px; max-width: 90vw; animation: modalIn 0.25s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .modal-body { font-size: 14px; color: var(--text-dim); margin-bottom: 24px; }
        .modal-total { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; color: var(--green); text-align: center; margin: 20px 0; }
        .modal-detail { padding: 14px; background: var(--bg); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-dim); margin-bottom: 20px; }
        .modal-detail div { display: flex; justify-content: space-between; padding: 4px 0; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: var(--radius-sm); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .modal-btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        .modal-btn-cancel:hover { border-color: var(--text-dim); }
        .modal-btn-confirm { background: var(--green-dark); border: none; color: white; }
        .modal-btn-confirm:hover { background: #047857; }

        /* SUCCESS */
        .success-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 2000; align-items: center; justify-content: center; }
        .success-overlay.active { display: flex; }
        .success-card { text-align: center; padding: 48px; animation: successIn 0.4s ease; }
        @keyframes successIn { from { opacity: 0; transform: scale(0.8); } 50% { transform: scale(1.05); } to { opacity: 1; transform: scale(1); } }
        .success-check { width: 80px; height: 80px; border-radius: 50%; background: var(--green); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px; color: white; }
        .success-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .success-amount { font-family: 'JetBrains Mono', monospace; font-size: 36px; font-weight: 700; color: var(--green); margin-bottom: 16px; }
        .success-ref { font-size: 14px; color: var(--text-dim); }

        /* TOAST */
        .toast-container { position: fixed; top: 68px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 20px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; animation: toastIn 0.3s ease; box-shadow: var(--shadow); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        .toast-error { background: #991b1b; color: #fecaca; }
        .toast-success { background: #065f46; color: #a7f3d0; }

        /* APERTURA OVERLAY */
        .apertura-overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 5000; align-items: center; justify-content: center; }
        .apertura-overlay.active { display: flex; }
        .apertura-card { text-align: center; padding: 48px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; width: 400px; max-width: 90vw; animation: modalIn 0.3s ease; }
        .apertura-icon { font-size: 56px; margin-bottom: 16px; }
        .apertura-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .apertura-desc { font-size: 14px; color: var(--text-dim); margin-bottom: 28px; }
        .apertura-campo { text-align: left; margin-bottom: 16px; }
        .apertura-campo label { display: block; font-size: 12px; font-weight: 600; color: var(--text-dim); margin-bottom: 6px; }
        .apertura-input, .apertura-select { width: 100%; padding: 14px 16px; background: var(--bg); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; text-align: center; outline: none; }
        .apertura-select { font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; text-align: left; }
        .apertura-input:focus, .apertura-select:focus { border-color: var(--border-focus); }
        .btn-abrir-caja { width: 100%; padding: 16px; margin-top: 8px; background: var(--accent); border: none; border-radius: var(--radius); color: white; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-abrir-caja:hover { background: #3d6be0; transform: translateY(-1px); }

        /* CIERRE */
        .cierre-resumen { background: var(--bg); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 16px; }
        .cierre-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
        .cierre-row.total { border-top: 1px solid var(--border); margin-top: 8px; padding-top: 10px; font-weight: 700; font-size: 15px; }
        .cierre-row .monto { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .cierre-campo { margin-bottom: 14px; }
        .cierre-campo label { display: block; font-size: 12px; font-weight: 600; color: var(--text-dim); margin-bottom: 6px; }
        .cierre-diferencia { padding: 12px; border-radius: var(--radius-sm); text-align: center; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 16px; margin-bottom: 14px; }
        .cierre-diferencia.sobrante { background: var(--green-soft); color: var(--green); }
        .cierre-diferencia.faltante { background: var(--red-soft); color: var(--red); }
        .cierre-diferencia.cuadrado { background: var(--accent-soft); color: var(--accent); }
    </style>
</head>
<body>
    <!-- APERTURA -->
    <div class="apertura-overlay" id="aperturaOverlay">
        <div class="apertura-card">
            <div class="apertura-icon">üè¶</div>
            <h2 class="apertura-title">Abrir Caja</h2>
            <p class="apertura-desc">Ingresa el monto del fondo inicial para comenzar</p>
            <div class="apertura-campo">
                <label>Centro de costo</label>
                <select id="aperturaCentro" class="apertura-select"></select>
            </div>
            <div class="apertura-campo">
                <label>Monto de apertura (S/)</label>
                <input type="number" id="aperturaMontoInput" class="apertura-input" value="0" min="0" step="0.01">
            </div>
            <button class="btn-abrir-caja" onclick="ejecutarApertura()">Abrir Caja</button>
        </div>
    </div>

    <div class="caja-layout">
        <header class="caja-header">
            <div class="header-left">
                <span class="header-logo">CCPL</span>
                <div class="header-divider"></div>
                <span class="header-title" id="headerTitle">Caja</span>
            </div>
            <div class="header-right">
                <div class="header-stat sesion-indicator" id="sesionIndicator" style="display:none;">
                    <span class="sesion-dot"></span>
                    <span class="label">Caja:</span>
                    <span class="value" id="sesionInfo">--</span>
                </div>
                <div class="header-stat">
                    <span class="label">Hoy:</span>
                    <span class="value" id="totalDia">S/ 0.00</span>
                </div>
                <div class="header-stat">
                    <span class="label">Ops:</span>
                    <span class="value" id="opsDia">0</span>
                </div>

                <button class="btn-cerrar-caja-header" id="btnEgreso" 
                        onclick="mostrarEgreso()" style="display:none;" title="Registrar egreso/gasto">
                    üí∏
                </button>

                <button class="btn-cerrar-caja-header" id="btnCerrarCajaHeader" onclick="mostrarCierreCaja()" style="display:none;" title="Cerrar caja">üîí</button>
                <span class="header-time" id="horaActual">--:--</span>
            </div>
        </header>

        <!-- PANEL IZQUIERDO -->
        <div class="panel-left">
            <div class="search-box">
                <span class="search-icon">‚åï</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar por DNI, matr√≠cula o nombre..." autocomplete="off">
                <span class="search-shortcut">F2</span>
                <div class="search-results" id="searchResults"></div>
            </div>

            <div class="colegiado-card" id="colegiadoCard">
                <div class="colegiado-avatar" id="colegiadoAvatar">--</div>
                <div class="colegiado-info">
                    <div class="colegiado-nombre" id="colegiadoNombre">--</div>
                    <div class="colegiado-detalle" id="colegiadoDetalle">--</div>
                </div>
                <span class="badge-habil" id="colegiadoBadge"></span>
                <button class="colegiado-clear" onclick="limpiarColegiado()" title="Quitar">‚úï</button>
            </div>

            <div class="tabs-container">
                <button class="tab-btn active" onclick="cambiarTab('deudas')" id="tabDeudas">Deudas <span class="count" id="countDeudas">0</span></button>
                <button class="tab-btn" onclick="cambiarTab('catalogo')" id="tabCatalogo">Cat√°logo <span class="count" id="countConceptos">0</span></button>
            </div>

            <div class="content-scroll" id="contentScroll">
                <div id="panelDeudas">
                    <div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Busca un colegiado</div><div class="empty-desc">Ingresa DNI, matr√≠cula o nombre para ver sus deudas</div></div>
                </div>
                <div id="panelCatalogo" style="display:none;">
                    <div class="categorias-grid" id="categoriasGrid"></div>
                    <div id="conceptosLista"></div>
                </div>
            </div>
        </div>

        <!-- PANEL DERECHO: CARRITO -->
        <div class="panel-right">
            <div class="cart-header">
                <div class="cart-title">Cobro actual <span class="cart-badge" id="cartCount">0</span></div>
            </div>
            <div class="cart-items" id="cartItems">
                <div class="cart-empty"><div class="cart-empty-icon">üõí</div>Selecciona deudas o conceptos<br>para agregar al cobro</div>
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span class="cart-total-label">TOTAL</span>
                    <span class="cart-total-amount"><span class="cart-total-currency">S/</span><span id="cartTotal">0.00</span></span>
                </div>
                <div class="metodos-pago">
                    <button class="metodo-btn active" onclick="setMetodo('efectivo')" data-metodo="efectivo"><span class="metodo-icon">üíµ</span>Efectivo</button>
                    <button class="metodo-btn" onclick="setMetodo('yape')" data-metodo="yape"><span class="metodo-icon">üì±</span>Yape</button>
                    <button class="metodo-btn" onclick="setMetodo('plin')" data-metodo="plin"><span class="metodo-icon">üì±</span>Plin</button>
                    <button class="metodo-btn" onclick="setMetodo('tarjeta')" data-metodo="tarjeta"><span class="metodo-icon">üí≥</span>Tarjeta</button>
                    <button class="metodo-btn" onclick="setMetodo('transferencia')" data-metodo="transferencia"><span class="metodo-icon">üè¶</span>Transfer.</button>
                    <button class="metodo-btn" onclick="setMetodo('deposito')" data-metodo="deposito"><span class="metodo-icon">üßæ</span>Dep√≥sito</button>
                </div>
                <input type="text" class="ref-input" id="refInput" placeholder="Nro. de operaci√≥n / voucher">
                <div class="tipo-comprobante">
                    <button class="tipo-comp-btn active" onclick="setTipoComp('03')" data-tipo="03">Boleta</button>
                    <button class="tipo-comp-btn" onclick="setTipoComp('01')" data-tipo="01">Factura</button>
                </div>
                <button class="btn-cobrar" id="btnCobrar" disabled onclick="confirmarCobro()">COBRAR <span class="monto-cobrar" id="btnMonto">S/ 0.00</span></button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIRMAR COBRO -->
    <div class="modal-overlay" id="modalConfirm">
        <div class="modal">
            <div class="modal-title">Confirmar cobro</div>
            <div class="modal-body">¬øConfirmar el siguiente cobro?</div>
            <div class="modal-total" id="modalTotal">S/ 0.00</div>
            <div class="modal-detail" id="modalDetail"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" onclick="ejecutarCobro()">‚úì Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL CIERRE DE CAJA -->
    <div class="modal-overlay" id="modalCierre">
        <div class="modal" style="width:480px;">
            <div class="modal-title">Cierre de Caja</div>
            <div class="cierre-resumen" id="cierreResumen"></div>
            <div class="cierre-campo">
                <label>¬øCu√°nto dinero hay en caja? (S/)</label>
                <input type="number" id="cierreMontoInput" class="apertura-input" min="0" step="0.01" placeholder="0.00" oninput="calcularDiferencia()">
            </div>
            <div class="cierre-diferencia" id="cierreDiferencia" style="display:none;"></div>
            <div class="cierre-campo" id="cierreObsContainer" style="display:none;">
                <label>Observaciones (obligatorio por diferencia &gt; S/ 50)</label>
                <textarea id="cierreObsInput" class="apertura-input" rows="2" style="font-size:14px;text-align:left;" placeholder="Explicar la diferencia..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="cerrarModalCierre()">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" onclick="ejecutarCierre()">üîí Cerrar Caja</button>
            </div>
        </div>
    </div>

    <!-- SUCCESS -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-card">
            <div class="success-check">‚úì</div>
            <div class="success-title">¬°Cobro registrado!</div>
            <div class="success-amount" id="successAmount">S/ 0.00</div>
            <div class="success-ref" id="successRef"></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API = '/api/caja';
        let colegiadoActual = null;
        let deudasDisponibles = [];
        let conceptosDisponibles = [];
        let categoriaActiva = null;
        let carrito = [];
        let metodoPago = 'efectivo';
        let tipoComprobante = '03';
        let tabActual = 'deudas';
        let sesionActual = null;
        let totalEsperadoCierre = 0;

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            actualizarReloj();
            setInterval(actualizarReloj, 30000);
            verificarSesionCaja();
            cargarCategorias();
            cargarConceptos();
            document.getElementById('searchInput').focus();

            document.addEventListener('keydown', (e) => {
                if (e.key === 'F2') { e.preventDefault(); document.getElementById('searchInput').focus(); document.getElementById('searchInput').select(); }
                if (e.key === 'Escape') { cerrarModal(); cerrarModalCierre(); cerrarSuccess(); document.getElementById('searchResults').classList.remove('active'); }
                if (e.key === 'F9' && carrito.length > 0) { e.preventDefault(); confirmarCobro(); }
            });
        });

        function actualizarReloj() {
            document.getElementById('horaActual').textContent = new Date().toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
        }

        async function cargarResumenDia() {
            try {
                const res = await fetch(`${API}/resumen-dia`);
                const data = await res.json();
                document.getElementById('totalDia').textContent = `S/ ${data.total_cobrado.toFixed(2)}`;
                document.getElementById('opsDia').textContent = data.cantidad_operaciones;
            } catch (e) {}
        }

        // ‚îÄ‚îÄ SESI√ìN DE CAJA ‚îÄ‚îÄ
        async function verificarSesionCaja() {
            try {
                const res = await fetch(`${API}/sesion-actual?centro_costo_id=1`);
                const data = await res.json();
                if (data.caja_abierta && data.sesion) {
                    sesionActual = data.sesion;
                    mostrarCajaAbierta();
                } else {
                    mostrarPanelApertura();
                }
            } catch (e) {
                console.warn('No se pudo verificar sesi√≥n:', e);
            }
            cargarResumenDia();
        }

        function mostrarPanelApertura() {
            const overlay = document.getElementById('aperturaOverlay');
            overlay.classList.add('active');
            const select = document.getElementById('aperturaCentro');
            select.innerHTML = `
                <option value="1">Oficina Principal</option>
                <option value="2">Restaurante</option>
                <option value="3">Cafet√≠n</option>
                <option value="4">Hotel</option>
                <option value="5">Bazar / Merchandising</option>
                <option value="6">Centro Recreacional</option>
            `;
            setTimeout(() => { document.getElementById('aperturaMontoInput').focus(); document.getElementById('aperturaMontoInput').select(); }, 300);
        }

        async function ejecutarApertura() {
            const monto = parseFloat(document.getElementById('aperturaMontoInput').value) || 0;
            const centroId = parseInt(document.getElementById('aperturaCentro').value) || 1;
            try {
                const res = await fetch(`${API}/abrir-caja`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ monto_apertura: monto, centro_costo_id: centroId }) });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('aperturaOverlay').classList.remove('active');
                    toast(data.mensaje, 'success');
                    verificarSesionCaja();
                } else { toast(data.detail?.error || data.detail || 'Error al abrir caja', 'error'); }
            } catch (e) { toast('Error de conexi√≥n', 'error'); }
        }

        function mostrarEgreso() {
            const monto = prompt('Monto del egreso (S/):');
            if (!monto) return;
            const montoNum = parseFloat(monto);
            if (isNaN(montoNum) || montoNum <= 0) { toast('Monto inv√°lido', 'error'); return; }
            
            const concepto = prompt('Concepto (ej: Compra de papel, taxi):');
            if (!concepto) return;

            fetch(`${API}/egreso?centro_costo_id=1`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ monto: montoNum, concepto: concepto })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) toast(data.mensaje, 'success');
                else toast(data.detail || 'Error', 'error');
            })
            .catch(() => toast('Error de conexi√≥n', 'error'));
        }

        function mostrarCajaAbierta() {
            document.getElementById('aperturaOverlay').classList.remove('active');
            document.getElementById('sesionIndicator').style.display = 'flex';
            document.getElementById('sesionInfo').textContent = `${sesionActual.centro_costo} ¬∑ ${sesionActual.hora_apertura}`;
            document.getElementById('headerTitle').textContent = `Caja ‚Äî ${sesionActual.centro_costo}`;
            document.getElementById('btnCerrarCajaHeader').style.display = 'block';
            document.getElementById('btnEgreso').style.display = 'block';
        }

        // ‚îÄ‚îÄ CIERRE ‚îÄ‚îÄ
        function mostrarCierreCaja() {
            if (!sesionActual) return;
            fetch(`${API}/sesion-actual?centro_costo_id=${sesionActual.centro_costo_id || 1}`)
                .then(r => r.json()).then(data => {
                    if (data.sesion) {
                        sesionActual = data.sesion;
                        totalEsperadoCierre = sesionActual.total_esperado;
                        document.getElementById('cierreResumen').innerHTML = `
                            <div class="cierre-row"><span>Apertura</span><span class="monto">S/ ${sesionActual.monto_apertura.toFixed(2)}</span></div>
                            <div class="cierre-row"><span>Cobros efectivo</span><span class="monto" style="color:var(--green)">+ S/ ${sesionActual.total_cobros_efectivo.toFixed(2)}</span></div>
                            <div class="cierre-row"><span>Cobros digitales</span><span class="monto" style="color:var(--accent)">S/ ${sesionActual.total_cobros_digital.toFixed(2)}</span></div>
                            <div class="cierre-row"><span>Egresos</span><span class="monto" style="color:var(--red)">- S/ ${sesionActual.total_egresos.toFixed(2)}</span></div>
                            <div class="cierre-row"><span>Operaciones</span><span class="monto">${sesionActual.cantidad_operaciones}</span></div>
                            <div class="cierre-row total"><span>Esperado en caja</span><span class="monto" style="color:var(--green)">S/ ${sesionActual.total_esperado.toFixed(2)}</span></div>
                        `;
                        document.getElementById('cierreMontoInput').value = '';
                        document.getElementById('cierreDiferencia').style.display = 'none';
                        document.getElementById('cierreObsContainer').style.display = 'none';
                        document.getElementById('modalCierre').classList.add('active');
                        document.getElementById('cierreMontoInput').focus();
                    }
                });
        }

        function calcularDiferencia() {
            const declarado = parseFloat(document.getElementById('cierreMontoInput').value) || 0;
            const dif = declarado - totalEsperadoCierre;
            const el = document.getElementById('cierreDiferencia');
            if (document.getElementById('cierreMontoInput').value === '') { el.style.display = 'none'; document.getElementById('cierreObsContainer').style.display = 'none'; return; }
            el.style.display = 'block';
            if (Math.abs(dif) < 0.01) { el.className = 'cierre-diferencia cuadrado'; el.textContent = '‚úì Caja cuadrada'; document.getElementById('cierreObsContainer').style.display = 'none'; }
            else if (dif > 0) { el.className = 'cierre-diferencia sobrante'; el.textContent = `Sobrante: + S/ ${dif.toFixed(2)}`; document.getElementById('cierreObsContainer').style.display = Math.abs(dif) > 50 ? 'block' : 'none'; }
            else { el.className = 'cierre-diferencia faltante'; el.textContent = `Faltante: - S/ ${Math.abs(dif).toFixed(2)}`; document.getElementById('cierreObsContainer').style.display = Math.abs(dif) > 50 ? 'block' : 'none'; }
        }

        function cerrarModalCierre() { document.getElementById('modalCierre').classList.remove('active'); }

        async function ejecutarCierre() {
            const monto = parseFloat(document.getElementById('cierreMontoInput').value);
            if (isNaN(monto)) { toast('Ingresa el monto', 'error'); return; }
            const obs = document.getElementById('cierreObsInput').value.trim();
            if (Math.abs(monto - totalEsperadoCierre) > 50 && !obs) { toast('Diferencia > S/ 50 ‚Äî observaci√≥n obligatoria', 'error'); return; }
            try {
                const res = await fetch(`${API}/cerrar-caja/${sesionActual.id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ monto_cierre: monto, observaciones: obs || null }) });
                const data = await res.json();
                if (data.success) { cerrarModalCierre(); toast(data.mensaje, 'success'); sesionActual = null; document.getElementById('sesionIndicator').style.display = 'none'; document.getElementById('btnCerrarCajaHeader').style.display = 'none'; setTimeout(() => mostrarPanelApertura(), 1500); }
                else { toast(data.detail || 'Error', 'error'); }
            } catch (e) { toast('Error de conexi√≥n', 'error'); }
        }

        // ‚îÄ‚îÄ B√öSQUEDA ‚îÄ‚îÄ
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const q = e.target.value.trim();
            if (q.length < 2) { document.getElementById('searchResults').classList.remove('active'); return; }
            searchTimeout = setTimeout(() => buscarColegiado(q), 300);
        });
        document.getElementById('searchInput').addEventListener('focus', (e) => { if (e.target.value.trim().length >= 2) document.getElementById('searchResults').classList.add('active'); });
        document.addEventListener('click', (e) => { if (!e.target.closest('.search-box')) document.getElementById('searchResults').classList.remove('active'); });

        async function buscarColegiado(q) {
            try {
                const res = await fetch(`${API}/buscar-colegiado?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                mostrarResultados(data);
            } catch (e) { toast('Error buscando', 'error'); }
        }

        function mostrarResultados(resultados) {
            const c = document.getElementById('searchResults');
            if (!resultados.length) { c.innerHTML = '<div style="padding:16px;color:var(--text-muted);text-align:center;font-size:13px;">Sin resultados</div>'; c.classList.add('active'); return; }
            c.innerHTML = resultados.map(r => `
                <div class="search-result-item" onclick='seleccionarColegiado(${JSON.stringify(r)})'>
                    <div class="result-info">
                        <div class="result-name">${r.apellidos_nombres}</div>
                        <div class="result-meta">DNI ${r.dni} ¬∑ Mat. ${r.codigo_matricula || '-'} <span class="badge-habil ${r.habilitado ? 'habil' : 'inhabil'}">${r.habilitado ? 'H√ÅBIL' : 'INH√ÅBIL'}</span></div>
                    </div>
                    <div class="result-deuda ${r.total_deuda > 0 ? 'tiene-deuda' : 'sin-deuda'}">${r.total_deuda > 0 ? `S/ ${r.total_deuda.toFixed(2)}` : 'Al d√≠a ‚úì'}</div>
                </div>`).join('');
            c.classList.add('active');
        }

        function seleccionarColegiado(col) {
            colegiadoActual = col;
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('searchInput').value = '';
            const card = document.getElementById('colegiadoCard'); card.classList.add('active');
            document.getElementById('colegiadoAvatar').textContent = col.apellidos_nombres.split(' ').slice(0, 2).map(n => n[0]).join('');
            document.getElementById('colegiadoNombre').textContent = col.apellidos_nombres;
            document.getElementById('colegiadoDetalle').textContent = `DNI ${col.dni} ¬∑ Mat. ${col.codigo_matricula || '-'} ¬∑ Deuda: S/ ${col.total_deuda.toFixed(2)}`;
            const badge = document.getElementById('colegiadoBadge'); badge.textContent = col.habilitado ? 'H√ÅBIL' : 'INH√ÅBIL'; badge.className = `badge-habil ${col.habilitado ? 'habil' : 'inhabil'}`;
            cargarDeudas(col.id);
            cambiarTab('deudas');
        }

        function limpiarColegiado() {
            colegiadoActual = null; deudasDisponibles = [];
            document.getElementById('colegiadoCard').classList.remove('active');
            document.getElementById('panelDeudas').innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Busca un colegiado</div><div class="empty-desc">Ingresa DNI, matr√≠cula o nombre</div></div>';
            document.getElementById('countDeudas').textContent = '0';
            carrito = carrito.filter(i => i.tipo !== 'deuda');
            renderCarrito();
            document.getElementById('searchInput').focus();
        }

        // ‚îÄ‚îÄ DEUDAS ‚îÄ‚îÄ
        async function cargarDeudas(id) {
            try { const res = await fetch(`${API}/deudas/${id}`); const data = await res.json(); deudasDisponibles = data.deudas || []; renderDeudas(); } catch (e) { toast('Error cargando deudas', 'error'); }
        }

        function renderDeudas() {
            const panel = document.getElementById('panelDeudas');
            document.getElementById('countDeudas').textContent = deudasDisponibles.length;
            if (!deudasDisponibles.length) { panel.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-title">Sin deudas pendientes</div></div>'; return; }
            const sel = carrito.filter(i => i.tipo === 'deuda').map(i => i.deuda_id);
            panel.innerHTML = `<button class="btn-seleccionar-todas" onclick="seleccionarTodas()">Seleccionar todas (${deudasDisponibles.length})</button>` +
                deudasDisponibles.map(d => `<div class="deuda-item ${sel.includes(d.id) ? 'selected' : ''}" onclick="toggleDeuda(${d.id})"><div class="deuda-check">${sel.includes(d.id) ? '‚úì' : ''}</div><div class="deuda-info"><div class="deuda-concepto">${d.concepto}</div><div class="deuda-periodo">${d.periodo || ''} ${d.fecha_vencimiento ? '¬∑ Vence: ' + d.fecha_vencimiento : ''}</div></div><div class="deuda-monto">S/ ${d.saldo.toFixed(2)}</div></div>`).join('');
        }

        function toggleDeuda(id) {
            const idx = carrito.findIndex(i => i.tipo === 'deuda' && i.deuda_id === id);
            if (idx >= 0) carrito.splice(idx, 1);
            else { const d = deudasDisponibles.find(x => x.id === id); if (d) carrito.push({ tipo: 'deuda', deuda_id: d.id, descripcion: `${d.concepto} ${d.periodo || ''}`.trim(), monto: d.saldo }); }
            renderDeudas(); renderCarrito();
        }

        function seleccionarTodas() {
            carrito = carrito.filter(i => i.tipo !== 'deuda');
            for (const d of deudasDisponibles) carrito.push({ tipo: 'deuda', deuda_id: d.id, descripcion: `${d.concepto} ${d.periodo || ''}`.trim(), monto: d.saldo });
            renderDeudas(); renderCarrito();
        }

        // ‚îÄ‚îÄ CAT√ÅLOGO ‚îÄ‚îÄ
        async function cargarCategorias() {
            try { const res = await fetch(`${API}/categorias`); const cats = await res.json(); document.getElementById('categoriasGrid').innerHTML = `<span class="cat-chip active" onclick="filtrarCategoria(null, this)">Todos</span>` + cats.map(c => `<span class="cat-chip" onclick="filtrarCategoria('${c.codigo}', this)">${c.nombre} (${c.total})</span>`).join(''); } catch (e) {}
        }

        async function cargarConceptos(cat = null) {
            try { let url = `${API}/conceptos`; if (cat) url += `?categoria=${cat}`; const res = await fetch(url); conceptosDisponibles = await res.json(); document.getElementById('countConceptos').textContent = conceptosDisponibles.length; renderConceptos(); } catch (e) {}
        }

        function filtrarCategoria(cat, el) { categoriaActiva = cat; document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active')); if (el) el.classList.add('active'); cargarConceptos(cat); }

        function renderConceptos() {
            document.getElementById('conceptosLista').innerHTML = conceptosDisponibles.map(c => `<div class="concepto-item" onclick="agregarConcepto(${c.id})"><div><div class="concepto-nombre">${c.nombre_corto || c.nombre}</div><div class="concepto-cat">${c.categoria}${c.maneja_stock ? ` ¬∑ Stock: ${c.stock_actual}` : ''}</div></div><div class="concepto-precio">${c.monto_base > 0 ? `S/ ${c.monto_base.toFixed(2)}` : 'Variable'}</div></div>`).join('');
        }

        function agregarConcepto(id) {
            const c = conceptosDisponibles.find(x => x.id === id); if (!c) return;
            if (c.requiere_colegiado && !colegiadoActual) { toast('Selecciona un colegiado primero', 'error'); return; }
            let monto = c.monto_base;
            if (c.permite_monto_libre || monto === 0) { const input = prompt(`Monto para "${c.nombre}":`, monto > 0 ? monto : ''); if (!input) return; monto = parseFloat(input); if (isNaN(monto) || monto <= 0) { toast('Monto inv√°lido', 'error'); return; } }
            carrito.push({ tipo: 'concepto', concepto_id: c.id, descripcion: c.nombre_corto || c.nombre, cantidad: 1, monto_unitario: monto, monto: monto });
            renderCarrito(); toast(`${c.nombre_corto || c.nombre} agregado`, 'success');
        }

        // ‚îÄ‚îÄ CARRITO ‚îÄ‚îÄ
        function renderCarrito() {
            const total = carrito.reduce((s, i) => s + i.monto, 0);
            document.getElementById('cartCount').textContent = carrito.length;
            document.getElementById('cartTotal').textContent = total.toFixed(2);
            document.getElementById('btnMonto').textContent = `S/ ${total.toFixed(2)}`;
            document.getElementById('btnCobrar').disabled = carrito.length === 0;
            if (!carrito.length) { document.getElementById('cartItems').innerHTML = '<div class="cart-empty"><div class="cart-empty-icon">üõí</div>Selecciona deudas o conceptos<br>para agregar al cobro</div>'; return; }
            document.getElementById('cartItems').innerHTML = carrito.map((item, idx) => `<div class="cart-item"><div class="cart-item-info"><div class="cart-item-name">${item.descripcion}</div><div class="cart-item-detail">${item.tipo === 'deuda' ? 'Deuda' : 'Concepto'}</div></div><div class="cart-item-monto">S/ ${item.monto.toFixed(2)}</div><button class="cart-item-remove" onclick="quitarItem(${idx})">‚úï</button></div>`).join('');
        }

        function quitarItem(idx) { const item = carrito[idx]; carrito.splice(idx, 1); if (item.tipo === 'deuda') renderDeudas(); renderCarrito(); }

        // ‚îÄ‚îÄ PAGO ‚îÄ‚îÄ
        function setMetodo(m) { metodoPago = m; document.querySelectorAll('.metodo-btn').forEach(b => b.classList.toggle('active', b.dataset.metodo === m)); const ref = document.getElementById('refInput'); ['transferencia', 'deposito', 'tarjeta'].includes(m) ? (ref.classList.add('visible'), ref.focus()) : ref.classList.remove('visible'); }
        function setTipoComp(t) { tipoComprobante = t; document.querySelectorAll('.tipo-comp-btn').forEach(b => b.classList.toggle('active', b.dataset.tipo === t)); }
        function cambiarTab(tab) { tabActual = tab; document.getElementById('tabDeudas').classList.toggle('active', tab === 'deudas'); document.getElementById('tabCatalogo').classList.toggle('active', tab === 'catalogo'); document.getElementById('panelDeudas').style.display = tab === 'deudas' ? 'block' : 'none'; document.getElementById('panelCatalogo').style.display = tab === 'catalogo' ? 'block' : 'none'; }

        function confirmarCobro() {
            if (!carrito.length) return;
            const total = carrito.reduce((s, i) => s + i.monto, 0);
            document.getElementById('modalTotal').textContent = `S/ ${total.toFixed(2)}`;
            document.getElementById('modalDetail').innerHTML = `<div><span>Colegiado:</span><span>${colegiadoActual ? colegiadoActual.apellidos_nombres : 'P√∫blico general'}</span></div><div><span>Items:</span><span>${carrito.length}</span></div><div><span>M√©todo:</span><span>${metodoPago}</span></div><div><span>Comprobante:</span><span>${tipoComprobante === '01' ? 'Factura' : 'Boleta'}</span></div>`;
            document.getElementById('modalConfirm').classList.add('active');
        }

        function cerrarModal() { document.getElementById('modalConfirm').classList.remove('active'); }

        async function ejecutarCobro() {
            cerrarModal();
            const total = carrito.reduce((s, i) => s + i.monto, 0);
            const ref = document.getElementById('refInput').value.trim();
            const payload = { colegiado_id: colegiadoActual?.id || null, items: carrito.map(i => ({ tipo: i.tipo, deuda_id: i.deuda_id || null, concepto_id: i.concepto_id || null, descripcion: i.descripcion, cantidad: i.cantidad || 1, monto_unitario: i.monto_unitario || i.monto, monto_total: i.monto })), total, metodo_pago: metodoPago, referencia_pago: ref || null, tipo_comprobante: tipoComprobante };
            try {
                const res = await fetch(`${API}/cobrar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('successAmount').textContent = `S/ ${total.toFixed(2)}`;
                    document.getElementById('successRef').textContent = `${metodoPago.toUpperCase()} ${ref ? '¬∑ Op: ' + ref : ''} ¬∑ ${colegiadoActual?.apellidos_nombres || 'P√∫blico general'}`;
                    document.getElementById('successOverlay').classList.add('active');
                    carrito = []; renderCarrito(); if (colegiadoActual) cargarDeudas(colegiadoActual.id); cargarResumenDia();
                    setTimeout(cerrarSuccess, 2500);
                } else { toast(data.detail || 'Error en el cobro', 'error'); }
            } catch (e) { toast('Error de conexi√≥n', 'error'); }
        }

        function cerrarSuccess() { document.getElementById('successOverlay').classList.remove('active'); document.getElementById('searchInput').focus(); }
        document.getElementById('successOverlay').addEventListener('click', cerrarSuccess);

        function toast(msg, type = 'success') { const el = document.createElement('div'); el.className = `toast toast-${type}`; el.textContent = msg; document.getElementById('toastContainer').appendChild(el); setTimeout(() => el.remove(), 3000); }
    </script>
</body>
</html>