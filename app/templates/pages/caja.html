<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caja - CCPL</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/pages/caja.css">

</head>
<body>

<!-- â•â•â• APERTURA â•â•â• -->
<div class="geo-block active" id="geoBlock">
    <div class="geo-icon">ğŸ“</div>
    <div class="geo-title" id="geoTitle">Verificando ubicaciÃ³n...</div>
    <div class="geo-desc" id="geoDesc">El sistema de caja solo funciona desde las instalaciones del CCPL.</div>
    <div class="geo-coords" id="geoCoords" style="display:none;"></div>
    <button class="geo-retry" id="geoRetry" style="display:none;" onclick="verificarGeo()">ğŸ”„ Reintentar</button>
</div>

<div class="apertura-bg" id="aperturaOverlay">
    <div class="apertura-box">
        <div class="ap-icon">ğŸ¦</div>
        <h2 class="ap-title">Abrir Caja</h2>
        <p class="ap-desc">Ingresa el monto del fondo inicial</p>
        <div class="ap-field"><label>Centro de costo</label><select id="aperturaCentro" class="ap-select"></select></div>
        <div class="ap-field"><label>Monto de apertura (S/)</label><input type="number" id="aperturaMontoInput" class="m-input" value="0" min="0" step="0.01"></div>
        <button class="btn-abrir" onclick="ejecutarApertura()">Abrir Caja</button>
    </div>
</div>

<div class="caja-layout">
    <!-- â•â•â• HEADER â•â•â• -->
    <header class="caja-header">
        <div class="header-left">
            <span class="header-logo">CCPL</span>
            <span class="header-title" id="headerTitle">Caja</span>
        </div>
        <div class="header-right">
            <div class="header-pill sesion-indicator" id="sesionIndicator" style="display:none;">
                <span class="sesion-dot"></span>
                <span class="lbl">Caja:</span>
                <span class="val" id="sesionInfo">--</span>
            </div>
            <div class="header-pill"><span class="lbl">Hoy:</span><span class="val" id="totalDia">S/ 0</span></div>
            <div class="header-pill"><span class="lbl">Ops:</span><span class="val" id="opsDia">0</span></div>
            <button class="hdr-btn" id="btnEgreso" onclick="cambiarTab('egresos')" style="display:none;" title="Egresos">ğŸ’¸</button>
            <button class="hdr-btn danger" id="btnCerrar" onclick="mostrarCierreCaja()" style="display:none;" title="Cerrar caja">ğŸ”’</button>
            <span class="header-time" id="horaActual">--:--</span>
            <div class="hdr-menu">
                <button class="hdr-btn" onclick="toggleMenu()" title="Opciones">â˜°</button>
                <div class="hdr-menu-drop" id="headerMenu">
                    <button class="hdr-menu-item" onclick="notificarDesdeCaja()">ğŸ”” Notificar</button>
                    <div class="hdr-menu-sep"></div>
                    <button class="hdr-menu-item danger" onclick="cerrarSesionUsuario()">ğŸšª Cerrar sesiÃ³n</button>
                </div>
            </div>
        </div>
    </header>

    <!-- â•â•â• PANEL IZQUIERDO â•â•â• -->
    <div class="panel-left">
        <div class="search-card">
            <div class="search-box">
                <span class="search-icon">âŒ•</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar por DNI, matrÃ­cula o nombre..." autocomplete="off">
                <span class="search-shortcut">F2</span>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="col-card" id="colCard">
                <div class="col-avatar" id="colAvatar">--</div>
                <div class="col-info">
                    <div class="col-name" id="colName">--</div>
                    <div class="col-detail" id="colDetail">--</div>
                </div>
                <span class="badge" id="colBadge"></span>
                <button class="col-clear" onclick="limpiarCol()">âœ•</button>
            </div>
        </div>

        <div class="tabs-bar">
            <button class="tab active" data-t="deudas" onclick="cambiarTab('deudas')" id="tabDeudas">Deudas <span class="tab-count" id="cntDeudas">0</span></button>
            <button class="tab" data-t="catalogo" onclick="cambiarTab('catalogo')" id="tabCatalogo">CatÃ¡logo <span class="tab-count" id="cntConceptos">0</span></button>
            <button class="tab" data-t="egresos" onclick="cambiarTab('egresos')" id="tabEgresos">Egresos <span class="tab-count" id="cntEgresos">0</span></button>
            <button class="tab" data-t="historial" onclick="cambiarTab('historial')" id="tabHistorial">Historial</button>
            <button class="tab" data-t="comprobantes" onclick="cambiarTab('comprobantes')" id="tabComprobantes">Comprobantes</button>
        </div>

        <div class="content-scroll">
            <div id="panelDeudas"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Busca un colegiado</div><div class="empty-desc">DNI, matrÃ­cula o nombre</div></div></div>
            <div id="panelCatalogo" style="display:none;"><div class="section-box blue"><div class="sec-title blue">ğŸ“¦ Conceptos de cobro</div><div class="cats-row" id="catsGrid"></div><div id="concLista"></div></div></div>
            <div id="panelEgresos" style="display:none;">
                <div class="section-box amber">
                    <div class="sec-title amber">ğŸ’¸ Registrar salida de dinero</div>
                    <div class="egr-form-row">
                        <div class="egr-field" style="flex:1;"><label>Monto (S/)</label><input type="number" id="eMonto" class="egr-input mono" min="0.01" step="0.01" placeholder="0.00"></div>
                        <div class="egr-field" style="flex:1.2;"><label>Tipo</label><select id="eTipo" class="egr-input"><option value="gasto">Gasto / Compra</option><option value="devolucion">DevoluciÃ³n a cliente</option><option value="retiro_fondo">Retiro de fondo</option></select></div>
                    </div>
                    <div class="egr-field"><label>Responsable</label><input type="text" id="eResp" class="egr-input" placeholder="QuiÃ©n recibe el dinero..."></div>
                    <div class="egr-field"><label>Concepto / Motivo</label><input type="text" id="eConc" class="egr-input" placeholder="Compra de papel, movilidad, refrigerios..."></div>
                    <div class="egr-field"><label>Detalle (opcional)</label><input type="text" id="eDet" class="egr-input" placeholder="Notas adicionales..."></div>
                    <button class="btn-reg-egr" onclick="registrarEgreso()">ğŸ’¸ Registrar Egreso</button>
                </div>
                <div class="egr-summary" id="egrSummary" style="display:none;">
                    <div class="egr-summary-row"><span>Entregado:</span><span class="mono" id="egrTotEnt">S/ 0</span></div>
                    <div class="egr-summary-row"><span>Facturado:</span><span class="mono" style="color:var(--green)" id="egrTotFact">S/ 0</span></div>
                    <div class="egr-summary-row"><span>Devuelto a caja:</span><span class="mono" style="color:var(--accent)" id="egrTotDev">S/ 0</span></div>
                    <div class="egr-summary-row" id="egrPendRow" style="display:none;"><span>âš  Pendientes:</span><span class="mono" style="color:var(--amber)" id="egrPend">0</span></div>
                </div>
                <div id="egrLista"></div>
            </div>
            <div id="panelHistorial" style="display:none;">
                <div class="section-box green">
                    <div class="sec-title green">ğŸ“Š Historial de operaciones</div>
                    <div class="hist-filters">
                        <input type="date" id="histFecha" style="flex:1;">
                        <select id="histTipo" style="width:100px;">
                            <option value="">Todos</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="yape">Yape</option>
                            <option value="plin">Plin</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transfer.</option>
                            <option value="deposito">DepÃ³sito</option>
                        </select>
                        <button class="hist-btn" onclick="cargarHistorial()">Buscar</button>
                        <button class="hist-btn" style="background:var(--green);" onclick="exportarDia()">ğŸ“¥ Excel</button>
                    </div>
                    <div class="hist-summary" id="histSummary"></div>
                    <div id="histLista"><div class="hist-empty">Selecciona una fecha y presiona Buscar</div></div>
                </div>

                <!-- Agregar un enlace discreto en algÃºn lugar visible de caja: -->
                <a href="#" onclick="verSesionesAnteriores();return false;" 
                style="font-size:11px;color:var(--text-sec);text-decoration:none;opacity:0.7;">
                ğŸ“‹ Ver cierres anteriores
                </a>

            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                PASO 2: Panel completo (agregar despuÃ©s del panel de historial)
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

            <div class="tab-content" id="panelComprobantes" style="display:none;">
                <div class="panel-box">
                    <div class="panel-title">ğŸ“„ COMPROBANTES EMITIDOS</div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
                        <input type="text" id="compBuscar" class="m-input" placeholder="DNI, RUC, nombre, serie..." style="flex:1;min-width:180px;" onkeydown="if(event.key==='Enter')buscarComprobantes()">
                        <select id="compTipo" class="ap-select" style="width:110px;">
                            <option value="">Todos</option>
                            <option value="03">Boletas</option>
                            <option value="01">Facturas</option>
                            <option value="07">NC</option>
                        </select>
                        <select id="compEstado" class="ap-select" style="width:110px;">
                            <option value="">Todo estado</option>
                            <option value="accepted">Aceptado</option>
                            <option value="pending">Pendiente</option>
                            <option value="rejected">Rechazado</option>
                            <option value="anulado">Anulado</option>
                        </select>
                        <button class="action-btn btn-primary" onclick="buscarComprobantes()">ğŸ”</button>
                    </div>
                    <div id="compSummary" style="font-size:12px;color:var(--text-sec);margin-bottom:8px;"></div>
                    <div id="compLista" style="max-height:500px;overflow-y:auto;">
                        <div class="hist-empty">Busca comprobantes por DNI, nombre o nÃºmero</div>
                    </div>
                    <div id="compPaginacion" style="display:flex;justify-content:center;gap:6px;margin-top:10px;"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- â•â•â• CARRITO â•â•â• -->
    <div class="panel-right" id="panelRight">
        <button class="cart-close-btn" id="cartCloseBtn" onclick="toggleCart()">âœ•</button>
        <div class="cart-head"><div class="cart-head-title">ğŸ§¾ Cobro actual <span class="cart-head-badge" id="cartCnt">0</span></div></div>
        <div class="cart-body" id="cartBody"><div class="cart-empty"><div class="cart-empty-icon">ğŸ›’</div>Selecciona deudas o conceptos<br>para agregar al cobro</div></div>
        <div class="cart-foot">
            <div class="cart-total-row"><span class="cart-total-lbl">TOTAL</span><span class="cart-total-val"><span class="cart-total-cur">S/</span><span id="cartTot">0.00</span></span></div>
            <div class="metodos-grid">
                <button class="m-btn active" onclick="setMetodo('efectivo')" data-m="efectivo"><span class="m-icon">ğŸ’µ</span>Efectivo</button>
                <button class="m-btn" onclick="setMetodo('yape')" data-m="yape"><span class="m-icon">ğŸ“±</span>Yape</button>
                <button class="m-btn" onclick="setMetodo('plin')" data-m="plin"><span class="m-icon">ğŸ“±</span>Plin</button>
                <button class="m-btn" onclick="setMetodo('tarjeta')" data-m="tarjeta"><span class="m-icon">ğŸ’³</span>Tarjeta</button>
                <button class="m-btn" onclick="setMetodo('transferencia')" data-m="transferencia"><span class="m-icon">ğŸ¦</span>Transfer.</button>
                <button class="m-btn" onclick="setMetodo('deposito')" data-m="deposito"><span class="m-icon">ğŸ§¾</span>DepÃ³sito</button>
            </div>
            <input type="text" class="ref-input" id="refInput" placeholder="Nro. de operaciÃ³n / voucher">
            <div class="ref-required-hint" id="refHint">âš  NÂ° de operaciÃ³n obligatorio</div>
            <div class="comp-row">
                <button class="comp-btn active" onclick="setComp('03')" data-c="03">Boleta</button>
                <button class="comp-btn" onclick="setComp('01')" data-c="01">Factura</button>
            </div>
            <div class="factura-fields" id="facturaFields">
                <div class="ff-row">
                    <div class="ff-label">RUC</div>
                    <div class="ff-ruc-row">
                        <input type="text" class="ff-input" id="ffRuc" maxlength="11" placeholder="20XXXXXXXXX" oninput="this.value=this.value.replace(/\D/g,'')">
                        <button class="ff-ruc-btn" id="ffBuscarRuc" onclick="buscarRuc()">ğŸ” Buscar</button>
                    </div>
                </div>
                <div class="ff-row"><div class="ff-label">RazÃ³n Social</div><input type="text" class="ff-input" id="ffRazonSocial" placeholder="Nombre o RazÃ³n Social"></div>
                <div class="ff-row"><div class="ff-label">DirecciÃ³n Fiscal</div><input type="text" class="ff-input" id="ffDireccion" placeholder="DirecciÃ³n (opcional)"></div>
            </div>
            <div class="pago-row">
                <button class="pago-btn active" onclick="setFormaPago('contado')" data-fp="contado">ğŸ’µ Contado</button>
                <button class="pago-btn" onclick="setFormaPago('credito')" data-fp="credito">ğŸ“… CrÃ©dito</button>
            </div>
            <button class="btn-cobrar" id="btnCobrar" disabled onclick="confirmarCobro()">COBRAR <span class="cobrar-monto" id="btnMonto">S/ 0.00</span></button>
        </div>
    </div>
</div>

<!-- MOBILE FAB -->
<button class="cart-fab" id="cartFab" onclick="toggleCart()">ğŸ›’ <span class="fab-badge" id="fabBadge" style="display:none;">0</span></button>

<!-- â•â•â• MODALS â•â•â• -->
<div class="modal-bg" id="modalConfirm">
    <div class="modal-box">
        <div class="modal-title">Confirmar cobro</div>
        <div class="modal-sub">Â¿Confirmar el siguiente cobro?</div>
        <div class="modal-total" id="mTotal">S/ 0.00</div>
        <div class="modal-detail" id="mDetail"></div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModal()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarCobro()">âœ“ Confirmar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalCierre">
    <div class="modal-box" style="width:440px;">
        <div class="modal-title">ğŸ”’ Cierre de Caja</div>
        <div class="cierre-box" id="cierreResumen"></div>
        <div class="c-field"><label>Â¿CuÃ¡nto dinero hay en caja? (S/)</label><input type="number" id="cierreMontoInput" class="m-input" min="0" step="0.01" placeholder="0.00" oninput="calcDiff()"></div>
        <div class="c-diff" id="cierreDiff" style="display:none;"></div>
        <div class="c-field" id="cierreObsCont" style="display:none;"><label>Observaciones (obligatorio si dif. > S/ 50)</label><textarea id="cierreObsInput" class="m-textarea" rows="2" placeholder="Explicar..."></textarea></div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalCierre()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarCierre()">ğŸ”’ Cerrar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalLiquidar">
    <div class="modal-box" style="width:400px;">
        <div class="modal-title">ğŸ“„ Liquidar Egreso</div>
        <div class="modal-sub" id="liqInfo">--</div>
        <div class="c-field"><label>Monto de la factura/boleta (S/)</label><input type="number" id="liqFactura" class="m-input" min="0" step="0.01" placeholder="0.00" oninput="calcVuelto()"></div>
        <div class="c-diff" id="liqVuelto" style="display:none;"></div>
        <div class="c-field"><label>Nro. factura/boleta (opcional)</label><input type="text" id="liqNroDoc" class="egr-input" placeholder="B001-00001234"></div>
        <input type="hidden" id="liqId"><input type="hidden" id="liqOriginal">
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalLiq()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarLiq()">âœ“ Liquidar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalAnular">
    <div class="modal-box" style="width:420px;">
        <div class="modal-title" style="color:var(--red);">âš ï¸ Anular cobro</div>
        <div class="modal-sub" id="anularInfo">--</div>
        <div class="c-field"><label>Motivo de anulaciÃ³n</label>
            <select id="anularMotivo" class="ap-select" onchange="toggleMontoParcial()">
                <option value="01">AnulaciÃ³n de la operaciÃ³n</option>
                <option value="02">AnulaciÃ³n por error en RUC</option>
                <option value="03">CorrecciÃ³n por error en descripciÃ³n</option>
                <option value="04">Descuento global</option>
                <option value="05">Descuento por Ã­tem</option>
                <option value="06">DevoluciÃ³n total</option>
                <option value="07">DevoluciÃ³n parcial</option>
            </select>
        </div>
        <div class="c-field" id="anularMontoCont" style="display:none;"><label>Monto a devolver (S/)</label><input type="number" id="anularMonto" class="m-input" min="0.01" step="0.01" placeholder="0.00"></div>
        <div class="c-field"><label>Observaciones (opcional)</label><input type="text" id="anularObs" class="egr-input" placeholder="Detalle adicional..."></div>
        <input type="hidden" id="anularPayId"><input type="hidden" id="anularTotal">
        <div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);border-radius:6px;padding:10px;margin:10px 0;font-size:12px;color:var(--red);">
            âš  Esta acciÃ³n emitirÃ¡ una Nota de CrÃ©dito ante SUNAT y revertirÃ¡ las deudas del colegiado. No se puede deshacer.
        </div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalAnular()">Cancelar</button><button class="mbtn mbtn-ok" style="background:var(--red);" onclick="ejecutarAnulacion()">ğŸ—‘ Anular</button></div>
    </div>
</div>

<div class="success-bg" id="successBg">
    <div class="success-box">
        <div class="success-check">âœ“</div>
        <div class="success-title">Â¡Cobro registrado!</div>
        <div class="success-amt" id="successAmt">S/ 0</div>
        <div class="success-ref" id="successRef"></div>
        <div class="success-comprobante" id="successComp">
            <div class="success-comp-numero" id="successCompNum"></div>
            <div class="success-comp-loading" id="successCompLoading"><span class="spin"></span> Generando comprobante...</div>
            <div class="success-actions" id="successActions" style="display:none;">
                <a class="success-action-btn primary" id="successCompPdf" href="#" target="_blank">ğŸ“„ Ver PDF</a>
                <button class="success-action-btn secondary" id="successShareBtn" onclick="compartirComprobante()">ğŸ“¤ Compartir</button>
            </div>
            <div class="success-comp-error" id="successCompErr"></div>
        </div>
        <div class="success-close-hint" id="successCloseHint">Toca en cualquier lugar para cerrar</div>
    </div>
</div>

<div class="toast-box" id="toastBox"></div>

<div id="verifBadge" style="
    display:none;
    align-items:center;
    gap:8px;
    padding:10px 14px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:8px;
    margin:8px 12px;
    font-size:13px;
    transition:all 0.3s ease;
">
    <span id="verifIcon" style="font-size:18px;">ğŸ”</span>
    <span id="verifText" style="flex:1;">Verificando...</span>
    <span id="verifTimer" style="font-size:11px;color:var(--text-sec);"></span>
</div>


!-- Modal de Cierre Exitoso (agregar al final del body) -->
<div id="modalCierreExitoso" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;display:none;align-items:center;justify-content:center;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px 28px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <div style="text-align:center;margin-bottom:16px;">
            <div style="font-size:40px;margin-bottom:8px;">âœ…</div>
            <div style="font-size:18px;font-weight:700;color:var(--text);">Caja Cerrada</div>
        </div>

        <div id="cierreResumenBox" style="background:var(--bg);border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.8;">
            <!-- Se llena dinÃ¡micamente -->
        </div>

        <div style="display:flex;gap:10px;">
            <button onclick="descargarPDFCierre()" style="flex:1;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:filter 0.15s;" onmouseenter="this.style.filter='brightness(1.15)'" onmouseleave="this.style.filter=''">
                ğŸ“„ Descargar PDF
            </button>
            <button onclick="cerrarModalCierre()" style="padding:12px 20px;background:transparent;color:var(--text-sec);border:1px solid var(--border);border-radius:8px;font-size:14px;cursor:pointer;">
                Cerrar
            </button>
        </div>
    </div>
</div>

    <!-- VERIFICACION DE NOTIFICACIONES BANCARIAS -->
    <script src="{{ url_for('static', path='/js/pages/caja.js') }}?v=5"></script>
</body>
</html>