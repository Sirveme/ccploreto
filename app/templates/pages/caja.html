<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caja - CCPL</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0c0e14;
            --bg-card: #151821;
            --bg-elevated: #1a1e2a;
            --bg-inset: #10121a;
            --border: #252a38;
            --border-focus: #4f7df3;
            --text: #e8eaf0;
            --text-dim: #8b8fa3;
            --text-muted: #505469;

            --accent: #4f7df3;
            --accent-soft: rgba(79, 125, 243, 0.10);
            --accent-border: rgba(79, 125, 243, 0.25);

            --green: #34d399;
            --green-soft: rgba(52, 211, 153, 0.08);
            --green-dark: #059669;
            --green-border: rgba(52, 211, 153, 0.25);

            --red: #f87171;
            --red-soft: rgba(248, 113, 113, 0.08);
            --red-border: rgba(248, 113, 113, 0.22);

            --amber: #fbbf24;
            --amber-soft: rgba(251, 191, 36, 0.08);
            --amber-border: rgba(251, 191, 36, 0.22);

            --purple: #a78bfa;
            --purple-soft: rgba(167, 139, 250, 0.08);
            --purple-border: rgba(167, 139, 250, 0.22);

            --radius: 12px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.25);
            --shadow: 0 4px 12px rgba(0,0,0,0.35);
            --shadow-lg: 0 8px 28px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh; height: 100dvh;
            overflow: hidden;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .caja-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 54px 1fr;
            height: 100vh; height: 100dvh;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .caja-header {
            grid-column: 1 / -1;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            background: linear-gradient(180deg, #1a1e28 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.35);
            z-index: 10;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-logo {
            font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 14px;
            color: var(--accent); background: var(--accent-soft);
            padding: 4px 10px; border-radius: 6px; border: 1px solid var(--accent-border);
        }
        .header-title { font-weight: 600; font-size: 12px; color: var(--text-dim); }
        .header-right { display: flex; align-items: center; gap: 6px; }
        .header-pill {
            display: flex; align-items: center; gap: 5px; padding: 4px 10px;
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 18px; font-size: 11px;
        }
        .header-pill .lbl { color: var(--text-muted); }
        .header-pill .val { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--green); }
        .header-time {
            font-family: 'JetBrains Mono', monospace; font-weight: 500;
            font-size: 11px; color: var(--text-muted);
        }
        .sesion-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--green); flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        .hdr-btn {
            background: rgba(255,255,255,0.04); border: 1px solid var(--border);
            border-radius: 8px; padding: 5px 8px; cursor: pointer;
            font-size: 13px; transition: all 0.15s; color: var(--text-dim);
        }
        .hdr-btn:hover { background: rgba(255,255,255,0.08); border-color: var(--text-dim); }
        .hdr-btn.danger:hover { border-color: var(--red); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PANEL IZQUIERDO
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .panel-left {
            display: flex; flex-direction: column;
            padding: 12px; gap: 10px; overflow: hidden;
            background: var(--bg);
        }

        /* â”€â”€ BÃºsqueda â”€â”€ */
        .search-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 12px;
            box-shadow: var(--shadow-sm);
        }
        .search-box { position: relative; }
        .search-input {
            width: 100%; padding: 11px 12px 11px 38px;
            background: var(--bg-inset); border: 1.5px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text);
            font-family: 'DM Sans', sans-serif; font-size: 14px;
            outline: none; transition: all 0.2s;
        }
        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        .search-input::placeholder { color: var(--text-muted); }
        .search-icon {
            position: absolute; left: 12px; top: 50%;
            transform: translateY(-50%); color: var(--text-muted); font-size: 15px;
        }
        .search-shortcut {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            padding: 2px 6px; background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: 4px; font-family: 'JetBrains Mono', monospace;
            font-size: 9px; color: var(--text-muted);
        }
        .search-results {
            position: absolute; top: calc(100% + 4px); left: -12px; right: -12px;
            background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: var(--radius); max-height: 300px; overflow-y: auto;
            z-index: 100; box-shadow: var(--shadow-lg); display: none;
        }
        .search-results.active { display: block; }
        .search-result-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; cursor: pointer; transition: background 0.12s;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(255,255,255,0.05); }
        .result-info { flex: 1; min-width: 0; }
        .result-name { font-weight: 600; font-size: 13px; }
        .result-meta { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        .result-deuda { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; flex-shrink: 0; margin-left: 8px; }
        .result-deuda.tiene { color: var(--red); }
        .result-deuda.no-tiene { color: var(--green); }

        .badge {
            display: inline-block; padding: 1px 6px; border-radius: 8px;
            font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge-ok { background: var(--green-soft); color: var(--green); border: 1px solid var(--green-border); }
        .badge-no { background: var(--red-soft); color: var(--red); border: 1px solid var(--red-border); }

        /* â”€â”€ Colegiado seleccionado â”€â”€ */
        .col-card {
            display: none; align-items: center; gap: 10px;
            padding: 8px 10px; margin-top: 8px;
            background: linear-gradient(135deg, var(--accent-soft), rgba(79,125,243,0.03));
            border: 1px solid var(--accent-border); border-radius: var(--radius-sm);
        }
        .col-card.active { display: flex; }
        .col-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #3455b0);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 13px; color: white; flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(79,125,243,0.25);
        }
        .col-info { flex: 1; min-width: 0; }
        .col-name { font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-detail { font-size: 10px; color: var(--text-dim); margin-top: 1px; }
        .col-clear {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; padding: 4px; font-size: 15px;
        }
        .col-clear:hover { color: var(--red); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TABS â€” cada uno con su color
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tabs-bar {
            display: flex; gap: 3px; padding: 3px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-sm);
        }
        .tab {
            flex: 1; padding: 8px 6px; background: transparent; border: none;
            color: var(--text-muted); font-family: 'DM Sans', sans-serif;
            font-weight: 600; font-size: 12px; border-radius: 9px;
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .tab.active { color: white; }
        .tab[data-t="deudas"].active { background: linear-gradient(135deg, #dc2626, #b91c1c); box-shadow: 0 2px 8px rgba(220,38,38,0.25); }
        .tab[data-t="catalogo"].active { background: linear-gradient(135deg, var(--accent), #3455b0); box-shadow: 0 2px 8px rgba(79,125,243,0.25); }
        .tab[data-t="egresos"].active { background: linear-gradient(135deg, #d97706, #b45309); box-shadow: 0 2px 8px rgba(217,119,6,0.25); }
        .tab-count {
            display: inline-block; padding: 0px 5px; border-radius: 8px;
            font-size: 10px; margin-left: 3px; background: rgba(255,255,255,0.15);
        }
        .tab:not(.active) .tab-count { background: var(--bg); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CONTENT SCROLL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .content-scroll { flex: 1; overflow-y: auto; }
        .content-scroll::-webkit-scrollbar { width: 3px; }
        .content-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SECTION CARDS (cada secciÃ³n con borde lateral de color)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .section-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 8px;
        }
        .section-box.red    { border-left: 3px solid var(--red-border); }
        .section-box.blue   { border-left: 3px solid var(--accent-border); }
        .section-box.amber  { border-left: 3px solid var(--amber-border); }
        .section-box.green  { border-left: 3px solid var(--green-border); }
        .section-box.purple { border-left: 3px solid var(--purple-border); }

        .sec-title {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.8px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 6px;
        }
        .sec-title.red { color: var(--red); }
        .sec-title.blue { color: var(--accent); }
        .sec-title.amber { color: var(--amber); }
        .sec-title.green { color: var(--green); }

        /* â”€â”€ Deudas â”€â”€ */
        .deuda-row {
            display: flex; align-items: center; gap: 8px;
            padding: 9px 10px; background: var(--bg-inset);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            margin-bottom: 4px; cursor: pointer; transition: all 0.15s;
        }
        .deuda-row:hover { border-color: var(--red-border); }
        .deuda-row.selected { border-color: var(--green-border); background: var(--green-soft); }
        .d-check {
            width: 17px; height: 17px; border: 2px solid var(--border);
            border-radius: 4px; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0; font-size: 10px; color: transparent;
        }
        .deuda-row.selected .d-check { border-color: var(--green); background: var(--green); color: white; }
        .d-info { flex: 1; min-width: 0; }
        .d-concepto { font-weight: 500; font-size: 12px; }
        .d-periodo { font-size: 10px; color: var(--text-dim); margin-top: 1px; }
        .d-monto { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 13px; white-space: nowrap; }
        .btn-sel-all {
            display: block; width: 100%; padding: 7px; margin-bottom: 6px;
            background: var(--red-soft); border: 1px dashed var(--red-border);
            border-radius: var(--radius-sm); color: var(--red);
            font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 11px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-sel-all:hover { background: var(--red); color: white; border-style: solid; }

        /* â”€â”€ CatÃ¡logo â”€â”€ */
        .cats-row { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
        .cat-chip {
            padding: 4px 10px; background: var(--bg-inset); border: 1px solid var(--border);
            border-radius: 14px; color: var(--text-dim); font-size: 10px; font-weight: 500;
            cursor: pointer; transition: all 0.15s;
        }
        .cat-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        .cat-chip:hover:not(.active) { border-color: var(--accent); color: var(--accent); }

        .concepto-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px; background: var(--bg-inset); border: 1px solid var(--border);
            border-radius: var(--radius-sm); margin-bottom: 4px; cursor: pointer; transition: all 0.15s;
        }
        .concepto-row:hover { border-color: var(--accent-border); background: var(--accent-soft); }
        .c-nombre { font-weight: 500; font-size: 12px; }
        .c-cat { font-size: 10px; color: var(--text-dim); }
        .c-precio { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px; color: var(--green); }

        /* â”€â”€ Egresos â”€â”€ */
        .egr-form-row { display: flex; gap: 8px; }
        .egr-field { margin-bottom: 8px; }
        .egr-field label {
            display: block; font-size: 9px; font-weight: 700; color: var(--text-muted);
            margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.4px;
        }
        .egr-input {
            width: 100%; padding: 8px 10px; background: var(--bg-inset);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px;
            outline: none; transition: all 0.15s;
        }
        .egr-input:focus { border-color: var(--amber); box-shadow: 0 0 0 2px var(--amber-soft); }
        .egr-input.mono { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 16px; }
        select.egr-input { cursor: pointer; }

        .btn-reg-egr {
            width: 100%; padding: 10px; margin-top: 2px;
            background: linear-gradient(135deg, var(--amber-soft), rgba(217,119,6,0.06));
            border: 1.5px solid var(--amber-border); border-radius: var(--radius-sm);
            color: var(--amber); font-family: 'DM Sans', sans-serif;
            font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s;
        }
        .btn-reg-egr:hover { background: var(--amber); color: var(--bg); border-color: var(--amber); }

        /* Resumen egresos */
        .egr-summary {
            background: var(--bg-inset); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 8px 10px; margin-bottom: 8px;
        }
        .egr-summary-row {
            display: flex; justify-content: space-between;
            padding: 2px 0; font-size: 11px; color: var(--text-dim);
        }
        .mono { font-family: 'JetBrains Mono', monospace; font-weight: 600; }

        /* Egreso items */
        .egr-item {
            padding: 10px; background: var(--bg-inset); border: 1px solid var(--border);
            border-radius: var(--radius-sm); margin-bottom: 5px;
        }
        .egr-item.pendiente { border-left: 3px solid var(--amber); }
        .egr-item.liquidado { border-left: 3px solid var(--green); opacity: 0.85; }
        .egr-item-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .egr-item-concepto { font-weight: 600; font-size: 12px; flex: 1; }
        .egr-item-monto { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 13px; color: var(--red); flex-shrink: 0; }
        .egr-item-meta {
            font-size: 10px; color: var(--text-dim);
            display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px;
        }
        .egr-badge {
            display: inline-block; padding: 1px 6px; border-radius: 6px;
            font-size: 9px; font-weight: 700; text-transform: uppercase;
        }
        .egr-badge.pendiente { background: var(--amber-soft); color: var(--amber); border: 1px solid var(--amber-border); }
        .egr-badge.liquidado { background: var(--green-soft); color: var(--green); border: 1px solid var(--green-border); }

        .btn-liquidar {
            margin-top: 8px; padding: 6px 14px;
            background: linear-gradient(135deg, var(--green-soft), rgba(52,211,153,0.04));
            border: 1px solid var(--green-border); border-radius: var(--radius-sm);
            color: var(--green); font-family: 'DM Sans', sans-serif;
            font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .btn-liquidar:hover { background: var(--green); color: white; border-color: var(--green); }

        .egr-liq-detail {
            margin-top: 6px; padding: 6px 8px;
            background: rgba(52,211,153,0.03); border: 1px solid var(--green-border);
            border-radius: var(--radius-sm); font-size: 10px; color: var(--text-dim);
        }
        .egr-liq-detail div { display: flex; justify-content: space-between; padding: 1px 0; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PANEL DERECHO â€” CARRITO (borde verde)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .panel-right {
            display: flex; flex-direction: column;
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-inset) 100%);
            border-left: 1px solid var(--border);
        }
        .cart-head {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(52,211,153,0.04), transparent);
            border-left: 3px solid var(--green-border);
        }
        .cart-head-title {
            font-weight: 700; font-size: 13px; color: var(--green);
            display: flex; align-items: center; gap: 8px;
        }
        .cart-head-badge {
            background: var(--green-dark); color: white;
            padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 700;
        }
        .cart-body { flex: 1; overflow-y: auto; padding: 8px 14px; }
        .cart-body::-webkit-scrollbar { width: 3px; }
        .cart-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .cart-empty { text-align: center; padding: 32px 14px; color: var(--text-muted); font-size: 12px; }
        .cart-empty-icon { font-size: 28px; margin-bottom: 8px; opacity: 0.2; }

        .cart-item {
            display: flex; align-items: flex-start; gap: 6px;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03);
            animation: slideIn 0.2s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(6px); } to { opacity: 1; transform: translateX(0); } }
        .ci-info { flex: 1; min-width: 0; }
        .ci-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ci-type { font-size: 9px; color: var(--text-dim); margin-top: 1px; }
        .ci-amt { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px; white-space: nowrap; }
        .ci-rm {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; padding: 2px; font-size: 12px;
        }
        .ci-rm:hover { color: var(--red); }

        /* CART FOOTER */
        .cart-foot {
            padding: 12px 16px; border-top: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.35));
        }
        .cart-total-row {
            display: flex; justify-content: space-between;
            align-items: baseline; margin-bottom: 10px;
        }
        .cart-total-lbl { font-weight: 600; font-size: 12px; color: var(--text-dim); }
        .cart-total-val {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700; font-size: 24px; color: var(--green);
        }
        .cart-total-cur { font-size: 14px; color: var(--text-dim); margin-right: 2px; }

        .metodos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 8px; }
        .m-btn {
            padding: 6px 3px; background: var(--bg-inset); border: 1.5px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text-muted);
            font-family: 'DM Sans', sans-serif; font-size: 10px; font-weight: 600;
            cursor: pointer; text-align: center; transition: all 0.15s;
        }
        .m-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
        .m-btn:hover:not(.active) { border-color: var(--text-muted); }
        .m-icon { font-size: 15px; display: block; margin-bottom: 1px; }

        .ref-input {
            width: 100%; padding: 7px 10px; background: var(--bg-inset);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 12px;
            outline: none; margin-bottom: 8px; display: none;
        }
        .ref-input.visible { display: block; }
        .ref-input:focus { border-color: var(--accent); }

        .comp-row { display: flex; gap: 4px; margin-bottom: 8px; }
        .comp-btn {
            flex: 1; padding: 6px; background: var(--bg-inset);
            border: 1.5px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text-muted); font-family: 'DM Sans', sans-serif;
            font-size: 11px; font-weight: 600; cursor: pointer; text-align: center;
        }
        .comp-btn.active { border-color: var(--green-border); color: var(--green); background: var(--green-soft); }

        .btn-cobrar {
            width: 100%; padding: 13px;
            background: linear-gradient(135deg, var(--green-dark), #047857);
            border: none; border-radius: var(--radius);
            color: white; font-family: 'DM Sans', sans-serif;
            font-size: 14px; font-weight: 700; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 14px rgba(5,150,105,0.3);
        }
        .btn-cobrar:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(5,150,105,0.4); }
        .btn-cobrar:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-cobrar .cobrar-monto { font-family: 'JetBrains Mono', monospace; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EMPTY
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .empty { text-align: center; padding: 36px 16px; color: var(--text-muted); }
        .empty-icon { font-size: 36px; margin-bottom: 10px; opacity: 0.2; }
        .empty-title { font-size: 13px; font-weight: 600; color: var(--text-dim); margin-bottom: 3px; }
        .empty-desc { font-size: 11px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODALS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-bg {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
            z-index: 1000; align-items: center; justify-content: center; padding: 16px;
        }
        .modal-bg.active { display: flex; }
        .modal-box {
            background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: 16px; padding: 24px; width: 400px; max-width: 100%;
            animation: mIn 0.25s ease; box-shadow: var(--shadow-lg);
        }
        @keyframes mIn { from { opacity: 0; transform: scale(0.95) translateY(6px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .modal-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 16px; }
        .modal-total { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; color: var(--green); text-align: center; margin: 14px 0; }
        .modal-detail { padding: 10px; background: var(--bg-inset); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-dim); margin-bottom: 14px; }
        .modal-detail div { display: flex; justify-content: space-between; padding: 3px 0; }
        .modal-btns { display: flex; gap: 8px; }
        .mbtn {
            flex: 1; padding: 10px; border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif; font-size: 13px;
            font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .mbtn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        .mbtn-cancel:hover { border-color: var(--text-dim); }
        .mbtn-ok { background: linear-gradient(135deg, var(--green-dark), #047857); border: none; color: white; }
        .mbtn-ok:hover { opacity: 0.9; }

        /* Modal input */
        .m-input {
            width: 100%; padding: 11px; background: var(--bg-inset);
            border: 1.5px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text); font-family: 'JetBrains Mono', monospace;
            font-size: 18px; font-weight: 700; text-align: center; outline: none;
        }
        .m-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
        .m-textarea {
            width: 100%; padding: 8px 10px; background: var(--bg-inset);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 12px;
            outline: none; resize: vertical;
        }

        /* Cierre */
        .cierre-box { background: var(--bg-inset); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 12px; }
        .c-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; }
        .c-row.total { border-top: 1px solid var(--border); margin-top: 6px; padding-top: 8px; font-weight: 700; font-size: 14px; }
        .c-row .cmonto { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .c-field { margin-bottom: 10px; }
        .c-field label { display: block; font-size: 10px; font-weight: 600; color: var(--text-dim); margin-bottom: 4px; }
        .c-diff {
            padding: 10px; border-radius: var(--radius-sm); text-align: center;
            font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 14px; margin-bottom: 10px;
        }
        .c-diff.ok { background: var(--accent-soft); color: var(--accent); border: 1px solid var(--accent-border); }
        .c-diff.over { background: var(--green-soft); color: var(--green); border: 1px solid var(--green-border); }
        .c-diff.under { background: var(--red-soft); color: var(--red); border: 1px solid var(--red-border); }

        /* Success */
        .success-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .success-bg.active { display: flex; }
        .success-box { text-align: center; padding: 36px; animation: sIn 0.4s ease; }
        @keyframes sIn { from { opacity: 0; transform: scale(0.8); } 50% { transform: scale(1.03); } to { opacity: 1; transform: scale(1); } }
        .success-check { width: 68px; height: 68px; border-radius: 50%; background: linear-gradient(135deg, var(--green), #047857); display: flex; align-items: center; justify-content: center; margin: 0 auto 14px; font-size: 34px; color: white; box-shadow: 0 6px 20px rgba(52,211,153,0.3); }
        .success-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .success-amt { font-family: 'JetBrains Mono', monospace; font-size: 30px; font-weight: 700; color: var(--green); margin-bottom: 10px; }
        .success-ref { font-size: 12px; color: var(--text-dim); }
        .success-comprobante { margin-top: 14px; padding: 10px 16px; background: rgba(79,125,243,0.1); border: 1px solid rgba(79,125,243,0.25); border-radius: 8px; display: none; }
        .success-comprobante.active { display: block; }
        .success-comp-numero { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 14px; color: var(--accent); margin-bottom: 6px; }
        .success-comp-link { display: inline-flex; align-items: center; gap: 6px; padding: 8px 18px; background: var(--accent); color: white; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600; transition: all 0.15s; }
        .success-comp-link:hover { background: #3d6be0; transform: translateY(-1px); }
        .success-comp-error { font-size: 11px; color: var(--amber); margin-top: 4px; }

        /* GEO BLOCK */
        .geo-block { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 40px; }
        .geo-block.active { display: flex; }
        .geo-icon { font-size: 64px; margin-bottom: 16px; }
        .geo-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .geo-desc { font-size: 14px; color: var(--text-dim); max-width: 400px; line-height: 1.5; margin-bottom: 20px; }
        .geo-coords { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); padding: 8px 14px; background: var(--bg-card); border-radius: 6px; }
        .geo-retry { margin-top: 16px; padding: 10px 24px; background: var(--accent); border: none; border-radius: 8px; color: white; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; }
        .geo-checking { font-size: 14px; color: var(--text-dim); }

        /* HISTORIAL */
        .hist-filters { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .hist-filters input, .hist-filters select { padding: 8px 10px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 12px; outline: none; }
        .hist-filters input:focus, .hist-filters select:focus { border-color: var(--border-focus); }
        .hist-btn { padding: 8px 14px; background: var(--accent); border: none; border-radius: 6px; color: white; font-weight: 600; font-size: 12px; cursor: pointer; }
        .hist-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 5px; font-size: 13px; cursor: pointer; transition: border-color 0.15s; }
        .hist-item:hover { border-color: var(--accent); }
        .hist-hora { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); width: 42px; flex-shrink: 0; }
        .hist-desc { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .hist-metodo { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: var(--bg); color: var(--text-dim); text-transform: uppercase; font-weight: 600; }
        .hist-monto { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 13px; color: var(--green); white-space: nowrap; }
        .hist-comp { font-size: 10px; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
        .hist-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap: 8px; margin-bottom: 14px; }
        .hist-stat { padding: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; text-align: center; }
        .hist-stat-val { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 18px; color: var(--green); }
        .hist-stat-lbl { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .hist-empty { text-align: center; padding: 30px; color: var(--text-muted); font-size: 13px; }
        .hist-anular { padding: 4px 10px; background: var(--red-soft); border: 1px solid rgba(248,113,113,0.3); border-radius: 4px; color: var(--red); font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .hist-anular:hover { background: var(--red); color: white; }
        .hist-item.anulado { opacity: 0.5; border-color: var(--red); }
        .hist-item.anulado .hist-monto { color: var(--red); text-decoration: line-through; }
        .hist-badge-anulado { font-size: 9px; padding: 1px 6px; border-radius: 8px; background: var(--red); color: white; font-weight: 700; text-transform: uppercase; }

        /* LOGOUT / CAMBIAR CAJA */
        .hdr-menu { position: relative; }
        .hdr-menu-drop { display: none; position: absolute; right: 0; top: 100%; margin-top: 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; min-width: 180px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 200; overflow: hidden; }
        .hdr-menu-drop.active { display: block; }
        .hdr-menu-item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; font-size: 13px; color: var(--text-dim); cursor: pointer; transition: background 0.15s; border: none; background: none; width: 100%; text-align: left; font-family: 'DM Sans', sans-serif; }
        .hdr-menu-item:hover { background: var(--bg-card-hover); color: var(--text); }
        .hdr-menu-item.danger { color: var(--red); }
        .hdr-menu-sep { height: 1px; background: var(--border); margin: 4px 0; }

        /* Toast */
        .toast-box { position: fixed; top: 60px; right: 14px; z-index: 3000; display: flex; flex-direction: column; gap: 5px; }
        .toast {
            padding: 9px 16px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 500;
            animation: tIn 0.3s ease; box-shadow: var(--shadow);
        }
        @keyframes tIn { from { opacity: 0; transform: translateX(16px); } to { opacity: 1; transform: translateX(0); } }
        .toast-err { background: #7f1d1d; color: #fecaca; border: 1px solid var(--red-border); }
        .toast-ok { background: #064e3b; color: #a7f3d0; border: 1px solid var(--green-border); }

        /* Apertura */
        .apertura-bg { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 5000; align-items: center; justify-content: center; }
        .apertura-bg.active { display: flex; }
        .apertura-box {
            text-align: center; padding: 36px; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: 20px; width: 370px; max-width: 92vw;
            animation: mIn 0.3s ease; box-shadow: var(--shadow-lg);
        }
        .ap-icon { font-size: 44px; margin-bottom: 10px; }
        .ap-title { font-size: 19px; font-weight: 700; margin-bottom: 5px; }
        .ap-desc { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
        .ap-field { text-align: left; margin-bottom: 12px; }
        .ap-field label { display: block; font-size: 10px; font-weight: 600; color: var(--text-muted); margin-bottom: 3px; }
        .ap-select {
            width: 100%; padding: 10px; background: var(--bg-inset); border: 1.5px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text); font-size: 13px; outline: none;
        }
        .btn-abrir {
            width: 100%; padding: 13px; margin-top: 4px;
            background: linear-gradient(135deg, var(--accent), #3455b0);
            border: none; border-radius: var(--radius); color: white;
            font-size: 15px; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 14px rgba(79,125,243,0.3); transition: all 0.2s;
        }
        .btn-abrir:hover { transform: translateY(-1px); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE FAB + RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .cart-fab {
            display: none; position: fixed; bottom: 16px; right: 16px; z-index: 50;
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, var(--green-dark), #047857);
            border: none; color: white; font-size: 22px; cursor: pointer;
            box-shadow: 0 4px 16px rgba(5,150,105,0.4); transition: all 0.2s;
            align-items: center; justify-content: center;
        }
        .cart-fab .fab-badge {
            position: absolute; top: -2px; right: -2px;
            background: var(--red); color: white; font-size: 10px; font-weight: 700;
            padding: 1px 5px; border-radius: 8px; min-width: 16px; text-align: center;
        }
        .cart-close-btn {
            display: none; position: absolute; top: 10px; right: 10px;
            background: none; border: none; color: var(--text-dim); font-size: 18px; cursor: pointer;
        }

        @media (max-width: 900px) {
            .caja-layout { grid-template-columns: 1fr; }
            .panel-right {
                position: fixed; top: 54px; right: 0; bottom: 0;
                width: 380px; max-width: 88vw; z-index: 40;
                transform: translateX(100%); transition: transform 0.3s ease;
                box-shadow: -6px 0 20px rgba(0,0,0,0.5);
            }
            .panel-right.open { transform: translateX(0); }
            .cart-fab { display: flex; }
            .cart-close-btn { display: block; }
        }

        @media (max-width: 600px) {
            .header-pill:not(.sesion-indicator) { display: none; }
            .header-title { font-size: 11px; }
            .panel-left { padding: 8px; gap: 6px; }
            .search-card { padding: 8px; }
            .search-input { padding: 9px 10px 9px 34px; font-size: 13px; }
            .search-shortcut { display: none; }
            .panel-right { width: 100%; max-width: 100%; }
            .cart-fab { bottom: 12px; right: 12px; width: 52px; height: 52px; }
        }
    </style>
</head>
<body>

<!-- â•â•â• APERTURA â•â•â• -->
<div class="geo-block active" id="geoBlock">
    <div class="geo-icon">ğŸ“</div>
    <div class="geo-title" id="geoTitle">Verificando ubicaciÃ³n...</div>
    <div class="geo-desc" id="geoDesc">El sistema de caja solo funciona desde las instalaciones del CCPL.</div>
    <div class="geo-coords" id="geoCoords" style="display:none;"></div>
    <button class="geo-retry" id="geoRetry" style="display:none;" onclick="verificarGeo()">ğŸ”„ Reintentar</button>
</div>

<div class="apertura-bg" id="aperturaOverlay">
    <div class="apertura-box">
        <div class="ap-icon">ğŸ¦</div>
        <h2 class="ap-title">Abrir Caja</h2>
        <p class="ap-desc">Ingresa el monto del fondo inicial</p>
        <div class="ap-field"><label>Centro de costo</label><select id="aperturaCentro" class="ap-select"></select></div>
        <div class="ap-field"><label>Monto de apertura (S/)</label><input type="number" id="aperturaMontoInput" class="m-input" value="0" min="0" step="0.01"></div>
        <button class="btn-abrir" onclick="ejecutarApertura()">Abrir Caja</button>
    </div>
</div>

<div class="caja-layout">
    <!-- â•â•â• HEADER â•â•â• -->
    <header class="caja-header">
        <div class="header-left">
            <span class="header-logo">CCPL</span>
            <span class="header-title" id="headerTitle">Caja</span>
        </div>
        <div class="header-right">
            <div class="header-pill sesion-indicator" id="sesionIndicator" style="display:none;">
                <span class="sesion-dot"></span>
                <span class="lbl">Caja:</span>
                <span class="val" id="sesionInfo">--</span>
            </div>
            <div class="header-pill"><span class="lbl">Hoy:</span><span class="val" id="totalDia">S/ 0</span></div>
            <div class="header-pill"><span class="lbl">Ops:</span><span class="val" id="opsDia">0</span></div>
            <button class="hdr-btn" id="btnEgreso" onclick="cambiarTab('egresos')" style="display:none;" title="Egresos">ğŸ’¸</button>
            <button class="hdr-btn danger" id="btnCerrar" onclick="mostrarCierreCaja()" style="display:none;" title="Cerrar caja">ğŸ”’</button>
            <span class="header-time" id="horaActual">--:--</span>
            <div class="hdr-menu">
                <button class="hdr-btn" onclick="toggleMenu()" title="Opciones">â˜°</button>
                <div class="hdr-menu-drop" id="headerMenu">
                    <button class="hdr-menu-item" onclick="notificarDesdeCaja()">ğŸ”” Notificar</button>
                    <div class="hdr-menu-sep"></div>
                    <button class="hdr-menu-item danger" onclick="cerrarSesionUsuario()">ğŸšª Cerrar sesiÃ³n</button>
                </div>
            </div>
        </div>
    </header>

    <!-- â•â•â• PANEL IZQUIERDO â•â•â• -->
    <div class="panel-left">
        <div class="search-card">
            <div class="search-box">
                <span class="search-icon">âŒ•</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar por DNI, matrÃ­cula o nombre..." autocomplete="off">
                <span class="search-shortcut">F2</span>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="col-card" id="colCard">
                <div class="col-avatar" id="colAvatar">--</div>
                <div class="col-info">
                    <div class="col-name" id="colName">--</div>
                    <div class="col-detail" id="colDetail">--</div>
                </div>
                <span class="badge" id="colBadge"></span>
                <button class="col-clear" onclick="limpiarCol()">âœ•</button>
            </div>
        </div>

        <div class="tabs-bar">
            <button class="tab active" data-t="deudas" onclick="cambiarTab('deudas')" id="tabDeudas">Deudas <span class="tab-count" id="cntDeudas">0</span></button>
            <button class="tab" data-t="catalogo" onclick="cambiarTab('catalogo')" id="tabCatalogo">CatÃ¡logo <span class="tab-count" id="cntConceptos">0</span></button>
            <button class="tab" data-t="egresos" onclick="cambiarTab('egresos')" id="tabEgresos">Egresos <span class="tab-count" id="cntEgresos">0</span></button>
            <button class="tab" data-t="historial" onclick="cambiarTab('historial')" id="tabHistorial">Historial</button>
        </div>

        <div class="content-scroll">
            <div id="panelDeudas"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Busca un colegiado</div><div class="empty-desc">DNI, matrÃ­cula o nombre</div></div></div>
            <div id="panelCatalogo" style="display:none;"><div class="section-box blue"><div class="sec-title blue">ğŸ“¦ Conceptos de cobro</div><div class="cats-row" id="catsGrid"></div><div id="concLista"></div></div></div>
            <div id="panelEgresos" style="display:none;">
                <div class="section-box amber">
                    <div class="sec-title amber">ğŸ’¸ Registrar salida de dinero</div>
                    <div class="egr-form-row">
                        <div class="egr-field" style="flex:1;"><label>Monto (S/)</label><input type="number" id="eMonto" class="egr-input mono" min="0.01" step="0.01" placeholder="0.00"></div>
                        <div class="egr-field" style="flex:1.2;"><label>Tipo</label><select id="eTipo" class="egr-input"><option value="gasto">Gasto / Compra</option><option value="devolucion">DevoluciÃ³n a cliente</option><option value="retiro_fondo">Retiro de fondo</option></select></div>
                    </div>
                    <div class="egr-field"><label>Responsable</label><input type="text" id="eResp" class="egr-input" placeholder="QuiÃ©n recibe el dinero..."></div>
                    <div class="egr-field"><label>Concepto / Motivo</label><input type="text" id="eConc" class="egr-input" placeholder="Compra de papel, movilidad, refrigerios..."></div>
                    <div class="egr-field"><label>Detalle (opcional)</label><input type="text" id="eDet" class="egr-input" placeholder="Notas adicionales..."></div>
                    <button class="btn-reg-egr" onclick="registrarEgreso()">ğŸ’¸ Registrar Egreso</button>
                </div>
                <div class="egr-summary" id="egrSummary" style="display:none;">
                    <div class="egr-summary-row"><span>Entregado:</span><span class="mono" id="egrTotEnt">S/ 0</span></div>
                    <div class="egr-summary-row"><span>Facturado:</span><span class="mono" style="color:var(--green)" id="egrTotFact">S/ 0</span></div>
                    <div class="egr-summary-row"><span>Devuelto a caja:</span><span class="mono" style="color:var(--accent)" id="egrTotDev">S/ 0</span></div>
                    <div class="egr-summary-row" id="egrPendRow" style="display:none;"><span>âš  Pendientes:</span><span class="mono" style="color:var(--amber)" id="egrPend">0</span></div>
                </div>
                <div id="egrLista"></div>
            </div>
            <div id="panelHistorial" style="display:none;">
                <div class="section-box green">
                    <div class="sec-title green">ğŸ“Š Historial de operaciones</div>
                    <div class="hist-filters">
                        <input type="date" id="histFecha" style="flex:1;">
                        <select id="histTipo" style="width:100px;">
                            <option value="">Todos</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="yape">Yape</option>
                            <option value="plin">Plin</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transfer.</option>
                            <option value="deposito">DepÃ³sito</option>
                        </select>
                        <button class="hist-btn" onclick="cargarHistorial()">Buscar</button>
                        <button class="hist-btn" style="background:var(--green);" onclick="exportarDia()">ğŸ“¥ Excel</button>
                    </div>
                    <div class="hist-summary" id="histSummary"></div>
                    <div id="histLista"><div class="hist-empty">Selecciona una fecha y presiona Buscar</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â• CARRITO â•â•â• -->
    <div class="panel-right" id="panelRight">
        <button class="cart-close-btn" id="cartCloseBtn" onclick="toggleCart()">âœ•</button>
        <div class="cart-head"><div class="cart-head-title">ğŸ§¾ Cobro actual <span class="cart-head-badge" id="cartCnt">0</span></div></div>
        <div class="cart-body" id="cartBody"><div class="cart-empty"><div class="cart-empty-icon">ğŸ›’</div>Selecciona deudas o conceptos<br>para agregar al cobro</div></div>
        <div class="cart-foot">
            <div class="cart-total-row"><span class="cart-total-lbl">TOTAL</span><span class="cart-total-val"><span class="cart-total-cur">S/</span><span id="cartTot">0.00</span></span></div>
            <div class="metodos-grid">
                <button class="m-btn active" onclick="setMetodo('efectivo')" data-m="efectivo"><span class="m-icon">ğŸ’µ</span>Efectivo</button>
                <button class="m-btn" onclick="setMetodo('yape')" data-m="yape"><span class="m-icon">ğŸ“±</span>Yape</button>
                <button class="m-btn" onclick="setMetodo('plin')" data-m="plin"><span class="m-icon">ğŸ“±</span>Plin</button>
                <button class="m-btn" onclick="setMetodo('tarjeta')" data-m="tarjeta"><span class="m-icon">ğŸ’³</span>Tarjeta</button>
                <button class="m-btn" onclick="setMetodo('transferencia')" data-m="transferencia"><span class="m-icon">ğŸ¦</span>Transfer.</button>
                <button class="m-btn" onclick="setMetodo('deposito')" data-m="deposito"><span class="m-icon">ğŸ§¾</span>DepÃ³sito</button>
            </div>
            <input type="text" class="ref-input" id="refInput" placeholder="Nro. de operaciÃ³n / voucher">
            <div class="comp-row">
                <button class="comp-btn active" onclick="setComp('03')" data-c="03">Boleta</button>
                <button class="comp-btn" onclick="setComp('01')" data-c="01">Factura</button>
            </div>
            <button class="btn-cobrar" id="btnCobrar" disabled onclick="confirmarCobro()">COBRAR <span class="cobrar-monto" id="btnMonto">S/ 0.00</span></button>
        </div>
    </div>
</div>

<!-- MOBILE FAB -->
<button class="cart-fab" id="cartFab" onclick="toggleCart()">ğŸ›’ <span class="fab-badge" id="fabBadge" style="display:none;">0</span></button>

<!-- â•â•â• MODALS â•â•â• -->
<div class="modal-bg" id="modalConfirm">
    <div class="modal-box">
        <div class="modal-title">Confirmar cobro</div>
        <div class="modal-sub">Â¿Confirmar el siguiente cobro?</div>
        <div class="modal-total" id="mTotal">S/ 0.00</div>
        <div class="modal-detail" id="mDetail"></div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModal()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarCobro()">âœ“ Confirmar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalCierre">
    <div class="modal-box" style="width:440px;">
        <div class="modal-title">ğŸ”’ Cierre de Caja</div>
        <div class="cierre-box" id="cierreResumen"></div>
        <div class="c-field"><label>Â¿CuÃ¡nto dinero hay en caja? (S/)</label><input type="number" id="cierreMontoInput" class="m-input" min="0" step="0.01" placeholder="0.00" oninput="calcDiff()"></div>
        <div class="c-diff" id="cierreDiff" style="display:none;"></div>
        <div class="c-field" id="cierreObsCont" style="display:none;"><label>Observaciones (obligatorio si dif. > S/ 50)</label><textarea id="cierreObsInput" class="m-textarea" rows="2" placeholder="Explicar..."></textarea></div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalCierre()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarCierre()">ğŸ”’ Cerrar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalLiquidar">
    <div class="modal-box" style="width:400px;">
        <div class="modal-title">ğŸ“„ Liquidar Egreso</div>
        <div class="modal-sub" id="liqInfo">--</div>
        <div class="c-field"><label>Monto de la factura/boleta (S/)</label><input type="number" id="liqFactura" class="m-input" min="0" step="0.01" placeholder="0.00" oninput="calcVuelto()"></div>
        <div class="c-diff" id="liqVuelto" style="display:none;"></div>
        <div class="c-field"><label>Nro. factura/boleta (opcional)</label><input type="text" id="liqNroDoc" class="egr-input" placeholder="B001-00001234"></div>
        <input type="hidden" id="liqId"><input type="hidden" id="liqOriginal">
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalLiq()">Cancelar</button><button class="mbtn mbtn-ok" onclick="ejecutarLiq()">âœ“ Liquidar</button></div>
    </div>
</div>

<div class="modal-bg" id="modalAnular">
    <div class="modal-box" style="width:420px;">
        <div class="modal-title" style="color:var(--red);">âš ï¸ Anular cobro</div>
        <div class="modal-sub" id="anularInfo">--</div>
        <div class="c-field"><label>Motivo de anulaciÃ³n</label>
            <select id="anularMotivo" class="ap-select" onchange="toggleMontoParcial()">
                <option value="01">AnulaciÃ³n de la operaciÃ³n</option>
                <option value="02">CorrecciÃ³n por error en comprobante</option>
                <option value="06">DevoluciÃ³n total</option>
                <option value="07">DevoluciÃ³n parcial</option>
            </select>
        </div>
        <div class="c-field" id="anularMontoCont" style="display:none;"><label>Monto a devolver (S/)</label><input type="number" id="anularMonto" class="m-input" min="0.01" step="0.01" placeholder="0.00"></div>
        <div class="c-field"><label>Observaciones (opcional)</label><input type="text" id="anularObs" class="egr-input" placeholder="Detalle adicional..."></div>
        <input type="hidden" id="anularPayId"><input type="hidden" id="anularTotal">
        <div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);border-radius:6px;padding:10px;margin:10px 0;font-size:12px;color:var(--red);">
            âš  Esta acciÃ³n emitirÃ¡ una Nota de CrÃ©dito ante SUNAT y revertirÃ¡ las deudas del colegiado. No se puede deshacer.
        </div>
        <div class="modal-btns"><button class="mbtn mbtn-cancel" onclick="cerrarModalAnular()">Cancelar</button><button class="mbtn mbtn-ok" style="background:var(--red);" onclick="ejecutarAnulacion()">ğŸ—‘ Anular</button></div>
    </div>
</div>

<div class="success-bg" id="successBg">
    <div class="success-box"><div class="success-check">âœ“</div><div class="success-title">Â¡Cobro registrado!</div><div class="success-amt" id="successAmt">S/ 0</div><div class="success-ref" id="successRef"></div><div class="success-comprobante" id="successComp"><div class="success-comp-numero" id="successCompNum"></div><a class="success-comp-link" id="successCompPdf" href="#" target="_blank">ğŸ“„ Ver Comprobante PDF</a><div class="success-comp-error" id="successCompErr"></div></div></div>
</div>

<div class="toast-box" id="toastBox"></div>

<script>
const API = '/api/caja';
let colActual = null, deudasDisp = [], conceptosDisp = [];
let catActiva = null, carrito = [], metodo = 'efectivo', tipoComp = '03';
let tabAct = 'deudas', sesion = null, totalEsperado = 0;

// â”€â”€ GEOLOCALIZACIÃ“N â”€â”€
const SEDES_CCPL = [
    { nombre: 'Oficina Principal', lat: -3.7486127, lng: -73.2529467, radio: 100 },
    { nombre: 'Centro Recreacional', lat: -3.793031, lng: -73.299236, radio: 100 },
];

function distanciaMetros(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function verificarGeo() {
    const el = document.getElementById('geoBlock');
    const titulo = document.getElementById('geoTitle');
    const desc = document.getElementById('geoDesc');
    const coords = document.getElementById('geoCoords');
    const retry = document.getElementById('geoRetry');
    titulo.textContent = 'Verificando ubicaciÃ³n...'; desc.textContent = 'Obteniendo tu posiciÃ³n GPS...';
    retry.style.display = 'none'; coords.style.display = 'none';

    if (!navigator.geolocation) {
        titulo.textContent = 'ğŸš« GPS no disponible';
        desc.textContent = 'Tu navegador no soporta geolocalizaciÃ³n. Usa Chrome o Firefox actualizado.';
        retry.style.display = 'inline-block'; return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude;
            let sedeOk = null, distMin = Infinity;
            for (const s of SEDES_CCPL) {
                const d = distanciaMetros(lat, lng, s.lat, s.lng);
                if (d < distMin) distMin = d;
                if (d <= s.radio) { sedeOk = s; break; }
            }
            if (sedeOk) {
                el.classList.remove('active');
                iniciarApp();
            } else {
                titulo.textContent = 'ğŸš« Fuera del Ã¡rea permitida';
                desc.textContent = `EstÃ¡s a ${Math.round(distMin)}m de la sede mÃ¡s cercana. El sistema de caja solo funciona dentro de las instalaciones del CCPL (radio: 100m).`;
                coords.textContent = `Tu posiciÃ³n: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                coords.style.display = 'block';
                retry.style.display = 'inline-block';
            }
        },
        (err) => {
            if (err.code === 1) {
                titulo.textContent = 'ğŸ“ Permiso denegado';
                desc.textContent = 'Debes permitir el acceso a tu ubicaciÃ³n para usar la caja. Haz clic en el Ã­cono de candado ğŸ”’ en la barra de direcciones y activa la ubicaciÃ³n.';
            } else if (err.code === 2) {
                titulo.textContent = 'ğŸ“ UbicaciÃ³n no disponible';
                desc.textContent = 'No se pudo obtener tu ubicaciÃ³n. Verifica que el GPS estÃ© activado.';
            } else {
                titulo.textContent = 'ğŸ“ Tiempo de espera agotado';
                desc.textContent = 'La obtenciÃ³n de ubicaciÃ³n tardÃ³ demasiado. Intenta de nuevo.';
            }
            retry.style.display = 'inline-block';
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
}

function iniciarApp() {
    actualizarReloj(); setInterval(actualizarReloj, 30000);
    verificarSesion(); cargarCats(); cargarConceptos();
    document.getElementById('searchInput').focus();
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('geoBlock').classList.remove('active'); iniciarApp(); // verificarGeo(); ğŸ‘ˆğŸ‘€ğŸ‘â€ğŸ—¨
    document.addEventListener('keydown', e => {
        if (e.key === 'F2') { e.preventDefault(); const s = document.getElementById('searchInput'); s.focus(); s.select(); }
        if (e.key === 'Escape') { cerrarModal(); cerrarModalCierre(); cerrarModalLiq(); cerrarModalAnular(); cerrarSuccess(); document.getElementById('searchResults').classList.remove('active'); }
        if (e.key === 'F9' && carrito.length) { e.preventDefault(); confirmarCobro(); }
    });
});

function actualizarReloj() { document.getElementById('horaActual').textContent = new Date().toLocaleTimeString('es-PE', { hour:'2-digit', minute:'2-digit' }); }
async function cargarResumen() { try { const r = await fetch(`${API}/resumen-dia`); const d = await r.json(); document.getElementById('totalDia').textContent = `S/ ${d.total_cobrado.toFixed(2)}`; document.getElementById('opsDia').textContent = d.cantidad_operaciones; } catch(e) {} }

// â”€â”€ SESIÃ“N â”€â”€
async function verificarSesion() {
    try { const r = await fetch(`${API}/sesion-actual?centro_costo_id=1`); const d = await r.json();
        if (d.caja_abierta && d.sesion) { sesion = d.sesion; abrirCajaUI(); } else { mostrarApertura(); }
    } catch(e) {} cargarResumen();
}
function mostrarApertura() {
    document.getElementById('aperturaOverlay').classList.add('active');
    document.getElementById('aperturaCentro').innerHTML = '<option value="1">Oficina Principal</option><option value="2">Restaurante</option><option value="3">CafetÃ­n</option><option value="4">Hotel</option><option value="5">Bazar / Merchandising</option><option value="6">Centro Recreacional</option>';
    setTimeout(() => { document.getElementById('aperturaMontoInput').focus(); document.getElementById('aperturaMontoInput').select(); }, 300);
}
async function ejecutarApertura() {
    const m = parseFloat(document.getElementById('aperturaMontoInput').value) || 0;
    const c = parseInt(document.getElementById('aperturaCentro').value) || 1;
    try { const r = await fetch(`${API}/abrir-caja`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ monto_apertura:m, centro_costo_id:c }) }); const d = await r.json();
        if (d.success) { document.getElementById('aperturaOverlay').classList.remove('active'); toast(d.mensaje,'ok'); verificarSesion(); } else toast(d.detail?.error||d.detail||'Error','err');
    } catch(e) { toast('Error','err'); }
}
function abrirCajaUI() {
    document.getElementById('aperturaOverlay').classList.remove('active');
    document.getElementById('sesionIndicator').style.display = 'flex';
    document.getElementById('sesionInfo').textContent = `${sesion.centro_costo} Â· ${sesion.hora_apertura}`;
    document.getElementById('headerTitle').textContent = `Caja â€” ${sesion.centro_costo}`;
    document.getElementById('btnCerrar').style.display = 'block';
    document.getElementById('btnEgreso').style.display = 'block';
}

// â”€â”€ CIERRE â”€â”€
function mostrarCierreCaja() {
    if (!sesion) return;
    fetch(`${API}/sesion-actual?centro_costo_id=${sesion.centro_costo_id||1}`).then(r=>r.json()).then(d => {
        if (!d.sesion) return;
        sesion = d.sesion; totalEsperado = sesion.total_esperado;
        document.getElementById('cierreResumen').innerHTML = `
            <div class="c-row"><span>Apertura</span><span class="cmonto">S/ ${sesion.monto_apertura.toFixed(2)}</span></div>
            <div class="c-row"><span>Cobros efectivo</span><span class="cmonto" style="color:var(--green)">+ S/ ${sesion.total_cobros_efectivo.toFixed(2)}</span></div>
            <div class="c-row"><span>Cobros digitales</span><span class="cmonto" style="color:var(--accent)">S/ ${sesion.total_cobros_digital.toFixed(2)}</span></div>
            <div class="c-row"><span>Egresos (neto)</span><span class="cmonto" style="color:var(--red)">- S/ ${sesion.total_egresos.toFixed(2)}</span></div>
            <div class="c-row"><span>Operaciones</span><span class="cmonto">${sesion.cantidad_operaciones}</span></div>
            <div class="c-row total"><span>Esperado en caja</span><span class="cmonto" style="color:var(--green)">S/ ${sesion.total_esperado.toFixed(2)}</span></div>`;
        document.getElementById('cierreMontoInput').value = '';
        document.getElementById('cierreDiff').style.display = 'none';
        document.getElementById('cierreObsCont').style.display = 'none';
        document.getElementById('modalCierre').classList.add('active');
        document.getElementById('cierreMontoInput').focus();
    });
}
function calcDiff() {
    const v = parseFloat(document.getElementById('cierreMontoInput').value); const el = document.getElementById('cierreDiff');
    if (isNaN(v)) { el.style.display='none'; document.getElementById('cierreObsCont').style.display='none'; return; }
    const d = v - totalEsperado; el.style.display = 'block';
    if (Math.abs(d)<0.01) { el.className='c-diff ok'; el.textContent='âœ“ Caja cuadrada'; document.getElementById('cierreObsCont').style.display='none'; }
    else if (d>0) { el.className='c-diff over'; el.textContent=`Sobrante: + S/ ${d.toFixed(2)}`; document.getElementById('cierreObsCont').style.display=Math.abs(d)>50?'block':'none'; }
    else { el.className='c-diff under'; el.textContent=`Faltante: - S/ ${Math.abs(d).toFixed(2)}`; document.getElementById('cierreObsCont').style.display=Math.abs(d)>50?'block':'none'; }
}
function cerrarModalCierre() { document.getElementById('modalCierre').classList.remove('active'); }
async function ejecutarCierre() {
    const m = parseFloat(document.getElementById('cierreMontoInput').value); if (isNaN(m)) { toast('Ingresa monto','err'); return; }
    const obs = document.getElementById('cierreObsInput').value.trim();
    if (Math.abs(m-totalEsperado)>50&&!obs) { toast('Dif >S/50: observaciÃ³n obligatoria','err'); return; }
    try { const r = await fetch(`${API}/cerrar-caja/${sesion.id}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ monto_cierre:m, observaciones:obs||null }) }); const d = await r.json();
        if (d.success) { cerrarModalCierre(); toast(d.mensaje,'ok'); sesion=null; document.getElementById('sesionIndicator').style.display='none'; document.getElementById('btnCerrar').style.display='none'; document.getElementById('btnEgreso').style.display='none'; setTimeout(()=>mostrarApertura(),1500); }
        else toast(d.detail||'Error','err');
    } catch(e) { toast('Error','err'); }
}

// â”€â”€ BÃšSQUEDA â”€â”€
let sT;
document.getElementById('searchInput').addEventListener('input', e => { clearTimeout(sT); const q=e.target.value.trim(); if(q.length<2){document.getElementById('searchResults').classList.remove('active');return;} sT=setTimeout(()=>buscar(q),300); });
document.getElementById('searchInput').addEventListener('focus', e => { if(e.target.value.trim().length>=2) document.getElementById('searchResults').classList.add('active'); });
document.addEventListener('click', e => { if(!e.target.closest('.search-card')) document.getElementById('searchResults').classList.remove('active'); });
async function buscar(q) { try { const r=await fetch(`${API}/buscar-colegiado?q=${encodeURIComponent(q)}`); renderRes(await r.json()); } catch(e){toast('Error','err');} }
function renderRes(arr) {
    const c=document.getElementById('searchResults');
    if(!arr.length){c.innerHTML='<div style="padding:12px;color:var(--text-muted);text-align:center;font-size:11px;">Sin resultados</div>';c.classList.add('active');return;}
    c.innerHTML=arr.map(r=>`<div class="search-result-item" onclick='selCol(${JSON.stringify(r)})'><div class="result-info"><div class="result-name">${r.apellidos_nombres}</div><div class="result-meta">DNI ${r.dni} Â· Mat. ${r.codigo_matricula||'-'} <span class="badge badge-${r.habilitado?'ok':'no'}">${r.habilitado?'HÃBIL':'INHÃBIL'}</span></div></div><div class="result-deuda ${r.total_deuda>0?'tiene':'no-tiene'}">${r.total_deuda>0?`S/ ${r.total_deuda.toFixed(2)}`:'Al dÃ­a âœ“'}</div></div>`).join('');
    c.classList.add('active');
}
function selCol(col) {
    colActual=col; document.getElementById('searchResults').classList.remove('active'); document.getElementById('searchInput').value='';
    document.getElementById('colCard').classList.add('active');
    document.getElementById('colAvatar').textContent=col.apellidos_nombres.split(' ').slice(0,2).map(n=>n[0]).join('');
    document.getElementById('colName').textContent=col.apellidos_nombres;
    document.getElementById('colDetail').textContent=`DNI ${col.dni} Â· Mat. ${col.codigo_matricula||'-'} Â· Deuda: S/ ${col.total_deuda.toFixed(2)}`;
    const b=document.getElementById('colBadge'); b.textContent=col.habilitado?'HÃBIL':'INHÃBIL'; b.className=`badge badge-${col.habilitado?'ok':'no'}`;
    cargarDeudas(col.id); cambiarTab('deudas');
}
function limpiarCol() {
    colActual=null; deudasDisp=[]; document.getElementById('colCard').classList.remove('active');
    document.getElementById('panelDeudas').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Busca un colegiado</div><div class="empty-desc">DNI, matrÃ­cula o nombre</div></div>';
    document.getElementById('cntDeudas').textContent='0'; carrito=carrito.filter(i=>i.tipo!=='deuda'); renderCarrito(); document.getElementById('searchInput').focus();
}

// â”€â”€ DEUDAS â”€â”€
async function cargarDeudas(id) { try { const r=await fetch(`${API}/deudas/${id}`); const d=await r.json(); deudasDisp=d.deudas||[]; renderDeudas(); } catch(e){toast('Error','err');} }
function renderDeudas() {
    const p=document.getElementById('panelDeudas'); document.getElementById('cntDeudas').textContent=deudasDisp.length;
    if(!deudasDisp.length){p.innerHTML='<div class="empty"><div class="empty-icon">âœ…</div><div class="empty-title">Sin deudas pendientes</div></div>';return;}
    const sel=carrito.filter(i=>i.tipo==='deuda').map(i=>i.deuda_id);
    p.innerHTML=`<div class="section-box red"><div class="sec-title red">ğŸ“‹ Deudas pendientes</div><button class="btn-sel-all" onclick="selTodas()">Seleccionar todas (${deudasDisp.length})</button>${deudasDisp.map(d=>`<div class="deuda-row ${sel.includes(d.id)?'selected':''}" onclick="togDeuda(${d.id})"><div class="d-check">${sel.includes(d.id)?'âœ“':''}</div><div class="d-info"><div class="d-concepto">${d.concepto}</div><div class="d-periodo">${d.periodo||''} ${d.fecha_vencimiento?'Â· Vence: '+d.fecha_vencimiento:''}</div></div><div class="d-monto">S/ ${d.saldo.toFixed(2)}</div></div>`).join('')}</div>`;
}
function togDeuda(id) { const i=carrito.findIndex(x=>x.tipo==='deuda'&&x.deuda_id===id); if(i>=0) carrito.splice(i,1); else { const d=deudasDisp.find(x=>x.id===id); if(d) carrito.push({tipo:'deuda',deuda_id:d.id,descripcion:`${d.concepto} ${d.periodo||''}`.trim(),monto:d.saldo}); } renderDeudas(); renderCarrito(); }
function selTodas() { carrito=carrito.filter(i=>i.tipo!=='deuda'); deudasDisp.forEach(d=>carrito.push({tipo:'deuda',deuda_id:d.id,descripcion:`${d.concepto} ${d.periodo||''}`.trim(),monto:d.saldo})); renderDeudas(); renderCarrito(); }

// â”€â”€ CATÃLOGO â”€â”€
async function cargarCats() { try { const r=await fetch(`${API}/categorias`); const c=await r.json(); document.getElementById('catsGrid').innerHTML=`<span class="cat-chip active" onclick="filtCat(null,this)">Todos</span>`+c.map(x=>`<span class="cat-chip" onclick="filtCat('${x.codigo}',this)">${x.nombre} (${x.total})</span>`).join(''); } catch(e){} }
async function cargarConceptos(cat) { try { let u=`${API}/conceptos`; if(cat) u+=`?categoria=${cat}`; const r=await fetch(u); conceptosDisp=await r.json(); document.getElementById('cntConceptos').textContent=conceptosDisp.length; renderConc(); } catch(e){} }
function filtCat(c,el) { catActiva=c; document.querySelectorAll('.cat-chip').forEach(x=>x.classList.remove('active')); if(el)el.classList.add('active'); cargarConceptos(c); }
function renderConc() { document.getElementById('concLista').innerHTML=conceptosDisp.map(c=>`<div class="concepto-row" onclick="addConc(${c.id})"><div><div class="c-nombre">${c.nombre_corto||c.nombre}</div><div class="c-cat">${c.categoria}${c.maneja_stock?` Â· Stock: ${c.stock_actual}`:''}</div></div><div class="c-precio">${c.monto_base>0?`S/ ${c.monto_base.toFixed(2)}`:'Variable'}</div></div>`).join(''); }
function addConc(id) {
    const c=conceptosDisp.find(x=>x.id===id); if(!c) return;
    if(c.requiere_colegiado&&!colActual){toast('Selecciona un colegiado','err');return;}
    let m=c.monto_base; if(c.permite_monto_libre||m===0){const i=prompt(`Monto para "${c.nombre}":`,m>0?m:'');if(!i)return;m=parseFloat(i);if(isNaN(m)||m<=0){toast('Monto invÃ¡lido','err');return;}}
    carrito.push({tipo:'concepto',concepto_id:c.id,descripcion:c.nombre_corto||c.nombre,cantidad:1,monto_unitario:m,monto:m}); renderCarrito(); toast(`${c.nombre_corto||c.nombre} agregado`,'ok');
}

// â”€â”€ CARRITO â”€â”€
function renderCarrito() {
    const t=carrito.reduce((s,i)=>s+i.monto,0); document.getElementById('cartCnt').textContent=carrito.length;
    document.getElementById('cartTot').textContent=t.toFixed(2); document.getElementById('btnMonto').textContent=`S/ ${t.toFixed(2)}`;
    document.getElementById('btnCobrar').disabled=!carrito.length;
    const fb=document.getElementById('fabBadge'); if(carrito.length){fb.style.display='block';fb.textContent=carrito.length;}else fb.style.display='none';
    if(!carrito.length){document.getElementById('cartBody').innerHTML='<div class="cart-empty"><div class="cart-empty-icon">ğŸ›’</div>Selecciona deudas o conceptos<br>para agregar al cobro</div>';return;}
    document.getElementById('cartBody').innerHTML=carrito.map((x,i)=>`<div class="cart-item"><div class="ci-info"><div class="ci-name">${x.descripcion}</div><div class="ci-type">${x.tipo==='deuda'?'Deuda':'Concepto'}</div></div><div class="ci-amt">S/ ${x.monto.toFixed(2)}</div><button class="ci-rm" onclick="rmItem(${i})">âœ•</button></div>`).join('');
}
function rmItem(i) { const x=carrito[i]; carrito.splice(i,1); if(x.tipo==='deuda') renderDeudas(); renderCarrito(); }
function toggleCart() { document.getElementById('panelRight').classList.toggle('open'); }

// â”€â”€ PAGO â”€â”€
function setMetodo(m) { metodo=m; document.querySelectorAll('.m-btn').forEach(b=>b.classList.toggle('active',b.dataset.m===m)); const r=document.getElementById('refInput'); ['transferencia','deposito','tarjeta'].includes(m)?(r.classList.add('visible'),r.focus()):r.classList.remove('visible'); }
function setComp(t) { tipoComp=t; document.querySelectorAll('.comp-btn').forEach(b=>b.classList.toggle('active',b.dataset.c===t)); }
function cambiarTab(t) {
    tabAct=t; document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.t===t));
    document.getElementById('panelDeudas').style.display=t==='deudas'?'block':'none';
    document.getElementById('panelCatalogo').style.display=t==='catalogo'?'block':'none';
    document.getElementById('panelEgresos').style.display=t==='egresos'?'block':'none';
    document.getElementById('panelHistorial').style.display=t==='historial'?'block':'none';
    if(t==='egresos') cargarEgresos();
    if(t==='historial') { if(!document.getElementById('histFecha').value) document.getElementById('histFecha').value=new Date().toISOString().split('T')[0]; cargarHistorial(); }
}
function confirmarCobro() {
    if(!carrito.length)return; const t=carrito.reduce((s,i)=>s+i.monto,0);
    document.getElementById('mTotal').textContent=`S/ ${t.toFixed(2)}`;
    document.getElementById('mDetail').innerHTML=`<div><span>Colegiado:</span><span>${colActual?colActual.apellidos_nombres:'PÃºblico general'}</span></div><div><span>Items:</span><span>${carrito.length}</span></div><div><span>MÃ©todo:</span><span>${metodo}</span></div><div><span>Comprobante:</span><span>${tipoComp==='01'?'Factura':'Boleta'}</span></div>`;
    document.getElementById('modalConfirm').classList.add('active');
}
function cerrarModal() { document.getElementById('modalConfirm').classList.remove('active'); }
async function ejecutarCobro() {
    cerrarModal(); const total=carrito.reduce((s,i)=>s+i.monto,0); const ref=document.getElementById('refInput').value.trim();
    const payload={colegiado_id:colActual?.id||null,items:carrito.map(i=>({tipo:i.tipo,deuda_id:i.deuda_id||null,concepto_id:i.concepto_id||null,descripcion:i.descripcion,cantidad:i.cantidad||1,monto_unitario:i.monto_unitario||i.monto,monto_total:i.monto})),total,metodo_pago:metodo,referencia_pago:ref||null,tipo_comprobante:tipoComp};
    try { const r=await fetch(`${API}/cobrar`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const d=await r.json();
        if(d.success){document.getElementById('successAmt').textContent=`S/ ${total.toFixed(2)}`;document.getElementById('successRef').textContent=`${metodo.toUpperCase()} ${ref?'Â· Op: '+ref:''} Â· ${colActual?.apellidos_nombres||'PÃºblico general'}`;
            // Comprobante electrÃ³nico
            const compEl=document.getElementById('successComp');
            const compNum=document.getElementById('successCompNum');
            const compPdf=document.getElementById('successCompPdf');
            const compErr=document.getElementById('successCompErr');
            compErr.textContent='';
            if(d.comprobante_emitido && d.numero_comprobante){
                compNum.textContent='ğŸ“„ '+d.numero_comprobante;
                if(d.comprobante_pdf){compPdf.href=d.comprobante_pdf;compPdf.style.display='inline-flex';}
                else{compPdf.style.display='none';}
                compEl.classList.add('active');
            } else {
                if(d.numero_comprobante){compNum.textContent='âš ï¸ '+d.numero_comprobante;compEl.classList.add('active');compPdf.style.display='none';}
                else{compEl.classList.remove('active');}
                if(!d.comprobante_emitido && d.mensaje){compErr.textContent=d.mensaje;}
            }
            document.getElementById('successBg').classList.add('active');carrito=[];renderCarrito();if(colActual)cargarDeudas(colActual.id);cargarResumen();
            // Si hay PDF, no cerrar automÃ¡ticamente â€” el usuario cierra manualmente
            if(!(d.comprobante_emitido && d.comprobante_pdf)){setTimeout(cerrarSuccess,2500);}
        }
        else toast(d.detail||'Error','err');
    } catch(e){toast('Error','err');}
}
function cerrarSuccess() { document.getElementById('successBg').classList.remove('active'); document.getElementById('successComp').classList.remove('active'); document.getElementById('searchInput').focus(); }
document.getElementById('successBg').addEventListener('click', cerrarSuccess);

// â”€â”€ EGRESOS â”€â”€
async function cargarEgresos() { try { const r=await fetch(`${API}/egresos-actual?centro_costo_id=1`); renderEgr(await r.json()); } catch(e){} }
function renderEgr(data) {
    const {egresos,totales}=data; document.getElementById('cntEgresos').textContent=egresos.length;
    const s=document.getElementById('egrSummary');
    if(egresos.length){s.style.display='block';document.getElementById('egrTotEnt').textContent=`S/ ${totales.entregado.toFixed(2)}`;document.getElementById('egrTotFact').textContent=`S/ ${totales.facturado.toFixed(2)}`;document.getElementById('egrTotDev').textContent=`S/ ${totales.devuelto.toFixed(2)}`;const pr=document.getElementById('egrPendRow');if(totales.pendientes>0){pr.style.display='flex';document.getElementById('egrPend').textContent=totales.pendientes;}else pr.style.display='none';}else s.style.display='none';
    const tl={gasto:'ğŸ›’ Gasto',devolucion:'â†©ï¸ DevoluciÃ³n',retiro_fondo:'ğŸ¦ Retiro'};
    const l=document.getElementById('egrLista');
    if(!egresos.length){l.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:11px;">Sin egresos en esta sesiÃ³n</div>';return;}
    l.innerHTML=egresos.map(e=>`<div class="egr-item ${e.estado}"><div class="egr-item-top"><div class="egr-item-concepto">${e.concepto}</div><div class="egr-item-monto">- S/ ${e.monto.toFixed(2)}</div></div><div class="egr-item-meta"><span>ğŸ‘¤ ${e.responsable}</span><span>ğŸ• ${e.hora}</span><span>${tl[e.tipo]||e.tipo}</span><span class="egr-badge ${e.estado}">${e.estado==='pendiente'?'â³ Pendiente':'âœ“ Liquidado'}</span></div>${e.estado==='liquidado'?`<div class="egr-liq-detail"><div><span>Factura${e.numero_documento?' ('+e.numero_documento+')':''}:</span><span class="mono">S/ ${(e.monto_factura??0).toFixed(2)}</span></div>${e.monto_devuelto>0?`<div><span>Vuelto a caja:</span><span class="mono" style="color:var(--green)">+ S/ ${e.monto_devuelto.toFixed(2)}</span></div>`:''}</div>`:`<button class="btn-liquidar" onclick="abrirLiq(${e.id},${e.monto},'${e.concepto.replace(/'/g,"\\'")}','${e.responsable.replace(/'/g,"\\'")}')">ğŸ“„ Liquidar (trajo factura)</button>`}</div>`).join('');
}
async function registrarEgreso() {
    const m=parseFloat(document.getElementById('eMonto').value),resp=document.getElementById('eResp').value.trim(),conc=document.getElementById('eConc').value.trim(),det=document.getElementById('eDet').value.trim(),tipo=document.getElementById('eTipo').value;
    if(!m||m<=0){toast('Ingresa monto','err');return;}if(!resp){toast('Ingresa responsable','err');return;}if(!conc){toast('Ingresa concepto','err');return;}
    try{const r=await fetch(`${API}/egreso?centro_costo_id=1`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({monto:m,responsable:resp,concepto:conc,detalle:det||null,tipo})});const d=await r.json();
        if(d.success){toast(d.mensaje,'ok');['eMonto','eResp','eConc','eDet'].forEach(x=>document.getElementById(x).value='');document.getElementById('eTipo').value='gasto';cargarEgresos();}else toast(d.detail||'Error','err');
    }catch(e){toast('Error','err');}
}

// â”€â”€ LIQUIDAR â”€â”€
function abrirLiq(id,monto,concepto,responsable) {
    document.getElementById('liqId').value=id; document.getElementById('liqOriginal').value=monto;
    document.getElementById('liqInfo').innerHTML=`<strong>${concepto}</strong><br>Responsable: ${responsable}<br>Entregado: <strong>S/ ${monto.toFixed(2)}</strong>`;
    document.getElementById('liqFactura').value=''; document.getElementById('liqNroDoc').value=''; document.getElementById('liqVuelto').style.display='none';
    document.getElementById('modalLiquidar').classList.add('active'); document.getElementById('liqFactura').focus();
}
function calcVuelto() {
    const o=parseFloat(document.getElementById('liqOriginal').value)||0, f=parseFloat(document.getElementById('liqFactura').value), el=document.getElementById('liqVuelto');
    if(isNaN(f)){el.style.display='none';return;} const v=o-f; el.style.display='block';
    if(v>0){el.className='c-diff over';el.textContent=`Vuelto a caja: + S/ ${v.toFixed(2)}`;}
    else if(v===0){el.className='c-diff ok';el.textContent='âœ“ Monto exacto';}
    else{el.className='c-diff under';el.textContent='âš  Factura mayor al entregado';}
}
function cerrarModalLiq() { document.getElementById('modalLiquidar').classList.remove('active'); }
async function ejecutarLiq() {
    const id=document.getElementById('liqId').value, mf=parseFloat(document.getElementById('liqFactura').value), nd=document.getElementById('liqNroDoc').value.trim();
    if(isNaN(mf)||mf<0){toast('Ingresa monto factura','err');return;}
    try{const r=await fetch(`${API}/egreso/${id}/liquidar`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({monto_factura:mf,numero_documento:nd||null})});const d=await r.json();
        if(d.success){cerrarModalLiq();toast(d.mensaje,'ok');cargarEgresos();}else toast(d.detail||'Error','err');
    }catch(e){toast('Error','err');}
}

// â”€â”€ HISTORIAL â”€â”€
async function cargarHistorial() {
    const fecha = document.getElementById('histFecha').value;
    const tipo = document.getElementById('histTipo').value;
    if(!fecha) return;
    try {
        let url = `${API}/historial-cobros?fecha=${fecha}`;
        if(tipo) url += `&metodo_pago=${tipo}`;
        const r = await fetch(url);
        const d = await r.json();
        renderHistorial(d);
    } catch(e) { document.getElementById('histLista').innerHTML = '<div class="hist-empty">Error cargando historial</div>'; }
}

function renderHistorial(data) {
    const ops = data.operaciones || data.cobros || data || [];
    const lista = document.getElementById('histLista');
    const summ = document.getElementById('histSummary');

    // Summary
    if(ops.length) {
        const activos = ops.filter(o=>o.status!=='anulado'&&o.status!=='refunded');
        const anulados = ops.length - activos.length;
        const totalEfect = activos.filter(o=>o.metodo_pago==='efectivo').reduce((s,o)=>s+(o.amount||o.total||0),0);
        const totalDigit = activos.filter(o=>o.metodo_pago!=='efectivo').reduce((s,o)=>s+(o.amount||o.total||0),0);
        const totalGen = activos.reduce((s,o)=>s+(o.amount||o.total||0),0);
        summ.innerHTML = `
            <div class="hist-stat"><div class="hist-stat-val">${activos.length}${anulados?` <span style="font-size:11px;color:var(--red)">(-${anulados})</span>`:''}</div><div class="hist-stat-lbl">Operaciones</div></div>
            <div class="hist-stat"><div class="hist-stat-val">S/ ${totalGen.toFixed(2)}</div><div class="hist-stat-lbl">Total cobrado</div></div>
            <div class="hist-stat"><div class="hist-stat-val">S/ ${totalEfect.toFixed(2)}</div><div class="hist-stat-lbl">Efectivo</div></div>
            <div class="hist-stat"><div class="hist-stat-val">S/ ${totalDigit.toFixed(2)}</div><div class="hist-stat-lbl">Digital</div></div>`;
    } else { summ.innerHTML = ''; }

    if(!ops.length) { lista.innerHTML = '<div class="hist-empty">Sin operaciones en esta fecha</div>'; return; }

    lista.innerHTML = ops.map(o => {
        const hora = o.reviewed_at ? new Date(o.reviewed_at).toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'}) : (o.hora||'--:--');
        const monto = o.amount || o.total || 0;
        const desc = o.notes || o.descripcion || 'Cobro';
        const compNum = o.numero_comprobante || o.comprobante_numero || '';
        const esAnulado = o.status === 'anulado' || o.status === 'refunded';
        return `<div class="hist-item${esAnulado?' anulado':''}" title="${desc}">
            <span class="hist-hora">${hora}</span>
            <div style="flex:1;overflow:hidden;">
                <div class="hist-desc">${desc.replace('[CAJA] ','')}</div>
                ${compNum ? `<div class="hist-comp">ğŸ“„ ${compNum}</div>` : ''}
                ${esAnulado ? '<span class="hist-badge-anulado">anulado</span>' : ''}
            </div>
            <span class="hist-metodo">${o.metodo_pago || o.payment_method || ''}</span>
            <span class="hist-monto">S/ ${monto.toFixed(2)}</span>
            ${!esAnulado ? `<button class="hist-anular" onclick="mostrarAnular(${o.id},'${desc.replace(/'/g,"\\'")}',${monto})">Anular</button>` : ''}
        </div>`;
    }).join('');
}

// â”€â”€ MENÃš / LOGOUT / CAMBIAR CAJA â”€â”€
function toggleMenu() {
    const m = document.getElementById('headerMenu');
    m.classList.toggle('active');
    if(m.classList.contains('active')) {
        setTimeout(()=> document.addEventListener('click', cerrarMenuFuera, {once:true}), 10);
    }
}
function cerrarMenuFuera(e) {
    const m = document.getElementById('headerMenu');
    if(!e.target.closest('.hdr-menu')) m.classList.remove('active');
}

function notificarDesdeCaja() {
    document.getElementById('headerMenu').classList.remove('active');
    toast('Notificaciones: prÃ³ximamente','ok');
}

function cerrarSesionUsuario() {
    document.getElementById('headerMenu').classList.remove('active');
    if(sesion) {
        if(!confirm('Tienes una caja abierta. Debes cerrarla antes de salir.\nÂ¿Ir al cierre de caja?')) return;
        mostrarCierreCaja();
        return;
    }
    window.location.href = '/logout';
}

// â”€â”€ EXPORTAR â”€â”€
function exportarDia() {
    const fecha = document.getElementById('histFecha').value;
    if(!fecha) { toast('Selecciona una fecha','err'); return; }
    window.open(`/api/reportes/exportar-dia?fecha=${fecha}`, '_blank');
}

// â”€â”€ ANULACIÃ“N â”€â”€
function mostrarAnular(payId, desc, monto) {
    document.getElementById('anularPayId').value = payId;
    document.getElementById('anularTotal').value = monto;
    document.getElementById('anularInfo').innerHTML = `<strong>S/ ${monto.toFixed(2)}</strong> â€” ${desc.replace('[CAJA] ','')}`;
    document.getElementById('anularMotivo').value = '01';
    document.getElementById('anularObs').value = '';
    document.getElementById('anularMonto').value = '';
    document.getElementById('anularMontoCont').style.display = 'none';
    document.getElementById('modalAnular').classList.add('active');
}
function cerrarModalAnular() { document.getElementById('modalAnular').classList.remove('active'); }

function toggleMontoParcial() {
    const esParcial = document.getElementById('anularMotivo').value === '07';
    document.getElementById('anularMontoCont').style.display = esParcial ? 'block' : 'none';
    if(esParcial) document.getElementById('anularMonto').focus();
}

async function ejecutarAnulacion() {
    const payId = document.getElementById('anularPayId').value;
    const motivo = document.getElementById('anularMotivo').value;
    const obs = document.getElementById('anularObs').value.trim();
    const motivoTexto = document.getElementById('anularMotivo').selectedOptions[0].text;
    const totalOriginal = parseFloat(document.getElementById('anularTotal').value) || 0;

    let montoAnular = totalOriginal;
    if(motivo === '07') {
        montoAnular = parseFloat(document.getElementById('anularMonto').value) || 0;
        if(montoAnular <= 0) { toast('Ingresa el monto a devolver','err'); return; }
        if(montoAnular > totalOriginal) { toast(`El monto no puede superar S/ ${totalOriginal.toFixed(2)}`,'err'); return; }
    }

    if(!confirm(`Â¿Confirmas la ${motivo==='07'?'DEVOLUCIÃ“N PARCIAL de S/ '+montoAnular.toFixed(2):'ANULACIÃ“N'}?\nMotivo: ${motivoTexto}`)) return;

    try {
        const r = await fetch(`${API}/anular-cobro`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ payment_id: parseInt(payId), motivo_codigo: motivo, motivo_texto: motivoTexto, monto: montoAnular, observaciones: obs })
        });
        const d = await r.json();
        if(d.success) {
            cerrarModalAnular();
            toast('Cobro anulado' + (d.nota_credito ? ` Â· NC: ${d.nota_credito}` : ''), 'ok');
            cargarHistorial();
            cargarResumen();
        } else {
            toast(d.detail || d.error || 'Error al anular', 'err');
        }
    } catch(e) { toast('Error de conexiÃ³n', 'err'); }
}

function toast(msg,type='ok'){const el=document.createElement('div');el.className=`toast toast-${type}`;el.textContent=msg;document.getElementById('toastBox').appendChild(el);setTimeout(()=>el.remove(),3000);}
</script>
</body>
</html>