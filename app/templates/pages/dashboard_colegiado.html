{% extends "base.html" %}
{% block head_extra %}
<link rel="stylesheet" href="/static/css/pages/dashboard_colegiado.css">
<link rel="stylesheet" href="/static/css/pages/modal-pagos.css">
<link rel="stylesheet" href="/static/css/components/ai-fab.css">
{% endblock %}

{% block container_width %}max-w-md lg:max-w-2xl{% endblock %}

{% block content %}
<div class="dashboard-pro">

    <!-- HEADER -->
    <header class="header-pro fade-in">
        <div class="avatar-pro" onclick="abrirModalLazy('modal-perfil')">
            {% if colegiado and colegiado.foto_url %}
                <img src="{{ colegiado.foto_url }}" alt="Foto">
            {% else %}
                <div class="avatar-placeholder">
                    {{ (colegiado.apellidos_nombres[0] if colegiado else user.user.name[0]) | upper }}
                </div>
            {% endif %}
        </div>
        
        <div class="user-info-pro">
            <h1 class="user-name-pro">
                {{ config.general.prefijo_titulo or '' }} {{ colegiado.apellidos_nombres.split(',')[0] if colegiado else user.user.name }}
            </h1>
            <div class="user-meta-pro">
                <span>Mat. {{ colegiado.codigo_matricula if colegiado else user.public_id }}</span>
                <span class="meta-sep">·</span>
                {% set es_habil = colegiado and colegiado.es_habil %}
                <span class="badge-status {{ 'badge-habil' if es_habil else 'badge-inhabil' }}">
                    {% if es_habil %}
                        <span class="dot-habil"></span> Hábil
                    {% else %}
                        <i class="ph ph-prohibit" style="font-size:10px;"></i> Inhábil
                    {% endif %}
                </span>
            </div>
        </div>

        <div class="header-actions">
            <button class="btn-icon" onclick="toggleSonidos()" title="Sonidos" id="btn-sound">
                <i class="ph ph-speaker-high"></i>
            </button>
            <a href="/auth/logout" class="btn-icon logout" title="Cerrar Sesión">
                <i class="ph ph-sign-out"></i>
            </a>
        </div>
    </header>

    <!-- AVISO DESTACADO -->
    {% if latest_bulletin %}
    <div class="notice-banner fade-in fade-in-delay-1 {{ latest_bulletin.priority }}"
         onclick="verAviso(this)"
         data-title="{{ latest_bulletin.title }}"
         data-content="{{ latest_bulletin.content }}"
         data-priority="{{ latest_bulletin.priority }}">
        <div class="notice-icon">
            {% if latest_bulletin.priority == 'alert' %}<i class="ph ph-warning-octagon"></i>
            {% elif latest_bulletin.priority == 'warning' %}<i class="ph ph-warning"></i>
            {% else %}<i class="ph ph-info"></i>{% endif %}
        </div>
        <div class="notice-content">
            <p class="notice-title">{{ latest_bulletin.title }}</p>
            <p class="notice-subtitle">Toca para ver detalles</p>
        </div>
        <i class="ph ph-caret-right notice-arrow"></i>
    </div>
    {% endif %}

    <!-- INDICADORES -->
    <div class="indicators-card fade-in fade-in-delay-2">
        <div class="indicators-header">
            <span class="indicators-title">
                <i class="ph ph-chart-line"></i>
                Indicadores del Día
            </span>
            <button class="btn-expand" onclick="Modal.open('modal-indicadores')" title="Ver más">
                <i class="ph ph-arrows-out-simple"></i>
            </button>
        </div>
        
        <div class="indicators-grid">
            <div class="indicator-item">
                <div class="indicator-label">UIT 2026</div>
                <div class="indicator-value gold">5,350</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-label">TC Compra</div>
                <div class="indicator-value">3.720</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-label">TC Venta</div>
                <div class="indicator-value">3.756</div>
            </div>
        </div>

        <div class="next-deadline">
            <div class="deadline-icon">
                <i class="ph ph-calendar-check"></i>
            </div>
            <div class="deadline-info">
                <div class="deadline-text">PDT 621 - Declaración Mensual</div>
                <div class="deadline-date">Vence: 14 Feb 2026 (en 14 días)</div>
            </div>
        </div>
    </div>

    <!-- SERVICIOS + HERRAMIENTAS (Grid unificado) -->
    <section class="options-section fade-in fade-in-delay-3">
        <h2 class="section-title">Servicios</h2>
        <div class="options-grid">
            <div class="option-card" onclick="ModalPagos.open()">
                <div class="option-icon blue"><i class="ph ph-wallet"></i></div>
                <span class="option-label">Mis Pagos</span>
            </div>
            <div class="option-card" onclick="abrirModalLazy('modal-justificaciones')">
                <div class="option-icon yellow"><i class="ph ph-calendar-x"></i></div>
                <span class="option-label">Justificar</span>
            </div>
            {% if config.modules.capacitaciones %}
            <div class="option-card" onclick="abrirModalLazy('modal-cursos')">
                <div class="option-icon purple"><i class="ph ph-certificate"></i></div>
                <span class="option-label">Cursos</span>
            </div>
            {% endif %}
            <div class="option-card" onclick="abrirModalLazy('modal-chat')">
                <div class="option-icon cyan"><i class="ph ph-chat-circle"></i></div>
                <span class="option-label">Chat</span>
            </div>
            {% if config.modules.votaciones %}
            <div class="option-card" onclick="abrirModalLazy('modal-votaciones')">
                <div class="option-icon indigo"><i class="ph ph-check-square"></i></div>
                <span class="option-label">Votar</span>
            </div>
            {% endif %}
            {% if config.modules.convenios %}
            <div class="option-card" onclick="abrirModalLazy('modal-convenios')">
                <div class="option-icon teal"><i class="ph ph-handshake"></i></div>
                <span class="option-label">Convenios</span>
            </div>
            {% endif %}
            <div class="option-card" onclick="abrirModalLazy('modal-bolsa')">
                <div class="option-icon orange"><i class="ph ph-briefcase"></i></div>
                <span class="option-label">Bolsa</span>
            </div>
            <div class="option-card" onclick="abrirModalLazy('modal-mi-sitio')">
                <div class="option-icon emerald"><i class="ph ph-globe"></i></div>
                <span class="option-label">Mi Sitio</span>
            </div>
        </div>
    </section>

    <section class="options-section fade-in fade-in-delay-4">
        <h2 class="section-title">Herramientas</h2>
        <div class="options-grid">
            <div class="option-card" onclick="abrirModalLazy('modal-avisos')">
                <div class="option-icon pink"><i class="ph ph-megaphone"></i></div>
                <span class="option-label">Avisos</span>
            </div>
            <div class="option-card" onclick="abrirModalLazy('modal-estadisticas')">
                <div class="option-icon gold"><i class="ph ph-chart-pie"></i></div>
                <span class="option-label">Estadísticas</span>
            </div>
            <div class="option-card" onclick="abrirModalLazy('modal-herramientas')">
                <div class="option-icon violet"><i class="ph ph-toolbox"></i></div>
                <span class="option-label">Herramientas</span>
            </div>
            <div class="option-card" onclick="abrirModalLazy('modal-normas')">
                <div class="option-icon red"><i class="ph ph-book-open"></i></div>
                <span class="option-label">Normas</span>
            </div>
            <div class="option-card" onclick="abrirModalLazy('modal-perfil')">
                <div class="option-icon slate"><i class="ph ph-user-circle"></i></div>
                <span class="option-label">Mi Perfil</span>
            </div>
        </div>
    </section>

</div>

<!-- BOTTOM DOCK (único elemento fijo) -->
<div class="bottom-dock">
    <div class="dock-inner">
        <!-- Botón descuento estacional: Ene-Feb 20%, Mar 10%, Abr+ oculto -->
        <button class="dock-btn descuento" id="dock-descuento" style="display:none"
                onclick="abrirDescuentoAnual()">
            <i class="ph ph-tag"></i>
            <span class="dock-label" id="dock-descuento-label"></span>
        </button>

        <button class="dock-btn primary" onclick="solicitarConstancia()">
            <i class="ph ph-file-text"></i>
            <span class="dock-label">Constancia</span>
        </button>
        <button class="dock-btn secondary" onclick="ModalPagos.open()">
            <i class="ph ph-wallet"></i>
            <span class="dock-label">Mis Pagos</span>
        </button>
        <button class="dock-btn mic" onclick="window.Neural && window.Neural.toggleListen()" id="dock-mic">
            <i class="ph ph-microphone"></i>
        </button>
    </div>
</div>

<!-- MODALES LIVIANOS (inline, <40 líneas c/u) -->
<dialog id="modal-aviso">
    <div class="modal-header">
        <h3 class="modal-title" id="aviso-titulo">Aviso</h3>
        <button class="modal-close" onclick="Modal.close('modal-aviso')"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body" style="padding:24px;">
        <p id="aviso-contenido" style="color:#cbd5e1;line-height:1.8;font-size:15px;"></p>
    </div>
    <div class="modal-footer">
        <button class="btn-primary" onclick="Modal.close('modal-aviso')">Entendido</button>
    </div>
</dialog>

<dialog id="modal-indicadores">
    <div class="modal-header">
        <h3 class="modal-title"><i class="ph ph-chart-line" style="color:var(--gold);"></i> Indicadores Tributarios</h3>
        <button class="modal-close" onclick="Modal.close('modal-indicadores')"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body" style="padding:16px;">
        <div class="list-item"><div class="list-item-icon" style="background:rgba(212,175,55,0.15);color:#d4af37;"><i class="ph ph-currency-circle-dollar"></i></div><div class="list-item-content"><div class="list-item-title">UIT 2026</div></div><div class="list-item-value" style="color:#d4af37;">S/ 5,350</div></div>
        <div class="list-item"><div class="list-item-icon" style="background:rgba(59,130,246,0.15);color:#3b82f6;"><i class="ph ph-arrow-down"></i></div><div class="list-item-content"><div class="list-item-title">TC Compra</div></div><div class="list-item-value">S/ 3.720</div></div>
        <div class="list-item"><div class="list-item-icon" style="background:rgba(16,185,129,0.15);color:#10b981;"><i class="ph ph-arrow-up"></i></div><div class="list-item-content"><div class="list-item-title">TC Venta</div></div><div class="list-item-value">S/ 3.756</div></div>
        <div class="list-item"><div class="list-item-icon" style="background:rgba(139,92,246,0.15);color:#8b5cf6;"><i class="ph ph-users"></i></div><div class="list-item-content"><div class="list-item-title">RMV 2026</div></div><div class="list-item-value">S/ 1,130</div></div>
        <div class="list-item"><div class="list-item-icon" style="background:rgba(239,68,68,0.15);color:#ef4444;"><i class="ph ph-percent"></i></div><div class="list-item-content"><div class="list-item-title">TIM Mensual</div></div><div class="list-item-value">1.00%</div></div>
    </div>
</dialog>

<!-- MODAL: MIS PAGOS (inline — modal-pagos.js maneja datos y render) -->
<dialog id="modal-pagos">
    <div class="modal-header">
        <h3 class="modal-title">
            <i class="ph ph-wallet" style="color:var(--gold);"></i>
            Mis Pagos
        </h3>
        <button class="modal-close" onclick="Modal.close('modal-pagos')">
            <i class="ph ph-x"></i>
        </button>
    </div>
    
    <div class="modal-body" style="position:relative;">
        <!-- Tabs -->
        <div class="pagos-tabs">
            <button class="pagos-tab active" data-tab="deudas">
                <i class="ph ph-receipt"></i>
                <span>Deudas</span>
            </button>
            <button class="pagos-tab" data-tab="servicios">
                <i class="ph ph-storefront"></i>
                <span>Servicios</span>
            </button>
            <button class="pagos-tab" data-tab="historial">
                <i class="ph ph-clock-counter-clockwise"></i>
                <span>Historial</span>
            </button>
        </div>
        
        <!-- Tab: Deudas (resumen + pendientes con checkbox) -->
        <div id="pagos-deudas" class="pagos-tab-content active">
            <div class="pagos-skeleton">
                <div class="skeleton-item"></div>
                <div class="skeleton-item"></div>
            </div>
        </div>
        
        <!-- Tab: Servicios (catálogo de productos) -->
        <div id="pagos-servicios" class="pagos-tab-content">
            <div class="pagos-skeleton">
                <div class="skeleton-item"></div>
                <div class="skeleton-item"></div>
            </div>
        </div>
        
        <!-- Tab: Historial -->
        <div id="pagos-historial" class="pagos-tab-content">
            <div class="pagos-empty">
                <i class="ph ph-clock-counter-clockwise"></i>
                <p>Cargando historial...</p>
            </div>
        </div>
        
        <!-- Sticky Footer: carrito + botón pagar -->
        <div id="pagos-footer" class="pagos-footer"></div>
    </div>
</dialog>

<!-- Placeholders para modales aún no implementados -->
{% for modal_id in ['modal-justificaciones', 'modal-cursos', 'modal-chat', 'modal-votaciones', 'modal-convenios', 'modal-bolsa', 'modal-estadisticas', 'modal-normas'] %}
<dialog id="{{ modal_id }}">
    <div class="modal-header">
        <h3 class="modal-title">{{ modal_id.replace('modal-', '').replace('-', ' ').title() }}</h3>
        <button class="modal-close" onclick="Modal.close('{{ modal_id }}')"><i class="ph ph-x"></i></button>
    </div>
    <div class="modal-body">
        <div class="empty-state">
            <i class="ph ph-code"></i>
            <p>Próximamente disponible</p>
        </div>
    </div>
</dialog>
{% endfor %}

<!-- Contenedor para modales lazy (se inyectan aquí) -->
<div id="modal-container"></div>

<div id="ai-fab-container"></div>

<!-- SCRIPTS -->
<script src="/static/js/modules/ux-system.js"></script>
<script src="/static/js/pages/dashboard_colegiado.js"></script>
<script src="/static/js/modules/modal-pagos.js"></script>
<script src="/static/js/components/ai-fab.js"></script>
<script src="/static/js/modules/verificacion-pago.js"></script>
{% block extra_scripts %}{% endblock %}
{% block mic_floating %}{% endblock %}
{% endblock %}